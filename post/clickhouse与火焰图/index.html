<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>clickhouse与火焰图 - 后端技术小屋</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="后端侠"><meta name=description content="最近再对clickhouse hive engine进行一些调优工作。本文将总结调优过程中常用的一些工具和命令。 火焰图 火焰图 (Flame Graph) 是性能优化大师 Bredan Gregg 创建"><meta name=keywords content="Hugo,theme,后端侠"><meta name=generator content="Hugo 0.62.2 with theme even"><link rel=canonical href=https://backendhouse.github.io/post/clickhouse%E4%B8%8E%E7%81%AB%E7%84%B0%E5%9B%BE/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.a2095472a2a8d7ddda1334cf60051cbe40ed55f2467554bb6aa4c17c9bcd27a4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="clickhouse与火焰图"><meta property="og:description" content="最近再对clickhouse hive engine进行一些调优工作。本文将总结调优过程中常用的一些工具和命令。 火焰图 火焰图 (Flame Graph) 是性能优化大师 Bredan Gregg 创建"><meta property="og:type" content="article"><meta property="og:url" content="https://backendhouse.github.io/post/clickhouse%E4%B8%8E%E7%81%AB%E7%84%B0%E5%9B%BE/"><meta property="article:published_time" content="2022-06-10T09:30:12+08:00"><meta property="article:modified_time" content="2022-06-10T09:30:12+08:00"><meta itemprop=name content="clickhouse与火焰图"><meta itemprop=description content="最近再对clickhouse hive engine进行一些调优工作。本文将总结调优过程中常用的一些工具和命令。 火焰图 火焰图 (Flame Graph) 是性能优化大师 Bredan Gregg 创建"><meta itemprop=datePublished content="2022-06-10T09:30:12+08:00"><meta itemprop=dateModified content="2022-06-10T09:30:12+08:00"><meta itemprop=wordCount content="2507"><meta itemprop=keywords content="clickhouse,火焰图,"><meta name=twitter:card content="summary"><meta name=twitter:title content="clickhouse与火焰图"><meta name=twitter:description content="最近再对clickhouse hive engine进行一些调优工作。本文将总结调优过程中常用的一些工具和命令。 火焰图 火焰图 (Flame Graph) 是性能优化大师 Bredan Gregg 创建"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>后端技术小屋</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>后端技术小屋</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>clickhouse与火焰图</h1><div class=post-meta><span class=post-time>2022-06-10</span><div class=post-category><a href=/categories/clickhouse/>clickhouse</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#火焰图>火焰图</a></li><li><a href=#clickhouse-flamegraph>clickhouse-flamegraph</a></li><li><a href=#perf>perf</a></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li></ul></li></ul></nav></div></div><div class=post-content><p>最近再对clickhouse hive engine进行一些调优工作。本文将总结调优过程中常用的一些工具和命令。</p><h2 id=火焰图>火焰图</h2><p>火焰图 (Flame Graph) 是性能优化大师 Bredan Gregg 创建的一种性能分析图标，因为它的样子近似火焰而得名。使用火焰图能够非常快速的定位到代码中的瓶颈，它就像一个在代码之海中航行的程序员的地图，指引着性能优化的方向。下图是clickhouse的一张火焰图。</p><p><img src=C:%5Cworkspace%5Cblog_sources%5Cstatic%5Cimages%5Ccpu.svg alt=cpu></p><p>火焰图的上下表示调用关系，下层的函数调用上层的函数。每个函数对应一个等高的长条，这个长条对应着该函数的某项指标，如cpu time/real time/memory allocate.</p><p>根据不同的指标，火焰图可以分为：</p><ul><li>cpu火焰图。显示代码中函数的cpu耗时，函数宽度与cpu time成正比。主要用于分析进程中的cpu瓶颈</li><li>real火焰图。显示代码中函数的duration耗时，函数宽度与real time成正比。与cpu火焰图结合可用于分析进程中的io瓶颈</li><li>mem火焰图。显示代码中函数中申请内存的大小，函数宽度与memory allocation成正比。主要用于优化进程的内存占用。</li></ul><p>对于clickhouse来说，性能瓶颈主要在于cpu和io。因此本文着重介绍如何生成cpu和real火焰图</p><h2 id=clickhouse-flamegraph>clickhouse-flamegraph</h2><p>clickhouse-flamegraph(<a href=https://github.com/Slach/clickhouse-flamegraph>https://github.com/Slach/clickhouse-flamegraph</a>)是一个命令行工具，他能够将clickhouse系统表system.trace_log中的性能指标以query_id为粒度可视化，形成对应的火焰图。</p><p>在使用clickhouse-flamegraph之前，需要</p><ul><li>安装：参考官方文档，此处略</li><li>配置：修改clickhouse配置文件：config.xml和users.xml，参考官方文档。这样做的目的是让clickhouse在query执行过程中，对cpu time, real time, memory allocate等指标进行采样。</li></ul><p>安装和配置完成后，如何使用clickhouse-flame-graph生成火焰图呢？</p><ul><li>首先执行对应的query，</li><li>然后记录对应的query_id</li><li>运行clickhouse-flamegraph</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ clickhouse-flamegraph --dsn<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;http://localhost:8123/?user=default&amp;password=xxx&#34;</span> --query-id<span style=color:#ff79c6>=</span>&lt;query_id&gt;
<span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;level&#34;</span>:<span style=color:#f1fa8c>&#34;info&#34;</span>,<span style=color:#f1fa8c>&#34;dsn&#34;</span>:<span style=color:#f1fa8c>&#34;http://localhost:8123/?user=default&amp;password=xxx&#34;</span>,<span style=color:#f1fa8c>&#34;time&#34;</span>:<span style=color:#f1fa8c>&#34;2022-06-10T10:28:44+08:00&#34;</span>,<span style=color:#f1fa8c>&#34;message&#34;</span>:<span style=color:#f1fa8c>&#34;connected to ClickHouse&#34;</span><span style=color:#ff79c6>}</span>
<span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;level&#34;</span>:<span style=color:#f1fa8c>&#34;info&#34;</span>,<span style=color:#f1fa8c>&#34;sqlFiles&#34;</span>:1,<span style=color:#f1fa8c>&#34;time&#34;</span>:<span style=color:#f1fa8c>&#34;2022-06-10T10:28:44+08:00&#34;</span>,<span style=color:#f1fa8c>&#34;message&#34;</span>:<span style=color:#f1fa8c>&#34;write .sql files&#34;</span><span style=color:#ff79c6>}</span>
<span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;level&#34;</span>:<span style=color:#f1fa8c>&#34;info&#34;</span>,<span style=color:#f1fa8c>&#34;processedFiles&#34;</span>:2,<span style=color:#f1fa8c>&#34;time&#34;</span>:<span style=color:#f1fa8c>&#34;2022-06-10T10:28:44+08:00&#34;</span>,<span style=color:#f1fa8c>&#34;message&#34;</span>:<span style=color:#f1fa8c>&#34;done processing&#34;</span><span style=color:#ff79c6>}</span>
</code></pre></div><ul><li>最后查看火焰图。在当前目录下执行，可以看到以下几个文件</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ tree clickhouse-flamegraphs 
clickhouse-flamegraphs
└── sg-ch-test006.bigdata.bigo.inner
    ├── 2694aa7a-f421-4727-a789-383a7bce05be.CPU.svg
    ├── 2694aa7a-f421-4727-a789-383a7bce05be.CPU.txt
    ├── 2694aa7a-f421-4727-a789-383a7bce05be.MemorySample.svg
    ├── 2694aa7a-f421-4727-a789-383a7bce05be.MemorySample.txt
    ├── 2694aa7a-f421-4727-a789-383a7bce05be.Memory.svg
    ├── 2694aa7a-f421-4727-a789-383a7bce05be.Memory.txt
    ├── 2694aa7a-f421-4727-a789-383a7bce05be.Real.svg
    ├── 2694aa7a-f421-4727-a789-383a7bce05be.Real.txt
    ├── 2694aa7a-f421-4727-a789-383a7bce05be.sql

</code></pre></div><p>其中，<code>*.Memory.svg</code>对应着mem火焰图，<code>*.CPU.svg</code>对应着cpu火焰图，<code>*.Real.svg</code>对应着real火焰图。<code>*.sql</code>中是本次查询的query语句。</p><p>我们看到，使用clickhouse-flamegraph生成火焰图还是很方便的。但是由于clickhouse的cpu time/real time的采样原理是在每个线程中一方面通过定时器每隔一定时间发出SIGUSR1和SIGUSR2 signal，另一方面注册信号处理函数，在收到signal的同时，将当前stack trace记录到system.trace_log中去。</p><p>由于clickhouse自带cpu time/real time的实现原理，clickhouse-flamegraph有两个缺点</p><ul><li>cpu time和real time的采样时间间隔太长。以笔者调试hive engine查询的经验，目前20ms是比较可靠的间隔，间隔再短点就无法保证query正常执行。</li><li>开启cpu time和real time采样会明显拖慢query运行速度，导致火焰图失真。</li></ul><h2 id=perf>perf</h2><p>perf是内置于linux kernel中的profiling工具，它能监测各种硬件和软件事件，被广泛用于性能瓶颈的查找和热点代码的定位。正因为他是内置的profiling工具，perf能够避免clickhouse-flamegraph的的上述缺点。perf的缺省采样频率是4000/s, 使用perf也不会导致被观测进程产生明显的性能衰减。</p><p>那么如何使用perf生成cpu和real火焰图呢？</p><ul><li>首先在clickhouse加上以下编译参数，避免debug信息丢失导致火焰图不准确。</li></ul><p>clickhouse在使用-O2编译的时候，会默认带上-fomit-frame-pointer和-fptimize-sibling-calls参数。这些参数通过编译阶段的优化，对运行是的性能有所提升，但是会让debug信息变得不完整。</p><blockquote><p>**-fomit-frame-pointer**</p><p>Don't keep the frame pointer in a register for functions that don't need one. This avoids the instructions to save, set up and restore frame pointers; it also makes an extra register available in many functions. It also makes debugging impossible on some machines.</p></blockquote><blockquote><p><strong>-foptimize-sibling-calls</strong></p><p>This option determines whether the compiler optimizes tail recursive calls. It enables conversion of tail recursion into loops.</p><p>If you do not want to optimize tail recursive calls, specify -fno-optimize-sibling-calls.</p><p>Tail recursion is a special form of recursion that doesn't use stack space. In tail recursion, a recursive call is converted to a GOTO statement that returns to the beginning of the function. In this case, the return value of the recursive call is only used to be returned. It is not used in another expression. The recursive function is converted into a loop, which prevents modification of the stack space used.</p></blockquote><pre><code>if (COMPILER_CLANG)
    # generate ranges for fast &quot;addr2line&quot; search
    if (NOT CMAKE_BUILD_TYPE_UC STREQUAL &quot;RELEASE&quot;)
        set(COMPILER_FLAGS &quot;${COMPILER_FLAGS} -gdwarf-aranges&quot;)
    endif ()

    if (HAS_USE_CTOR_HOMING)
        # For more info see https://blog.llvm.org/posts/2021-04-05-constructor-homing-for-debug-info/
        if (CMAKE_BUILD_TYPE_UC STREQUAL &quot;DEBUG&quot; OR CMAKE_BUILD_TYPE_UC STREQUAL &quot;RELWITHDEBINFO&quot;)
            set (CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -Xclang -fuse-ctor-homing&quot;)
            set (CMAKE_C_FLAGS &quot;${CMAKE_C_FLAGS} -Xclang -fuse-ctor-homing&quot;)
        endif()
    endif()
	
	# 添加以下两行
	# 
    set (CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -fno-omit-frame-pointer -mno-omit-leaf-frame-pointer -fno-optimize-sibling-calls&quot;)
    set (CMAKE_C_FLAGS &quot;${CMAKE_C_FLAGS} -fno-omit-frame-pointer -mno-omit-leaf-frame-pointer -fno-optimize-sibling-calls&quot;)
endif ()
</code></pre><ul><li>通过clickhouse-benchmark运行要profile的query。如</li></ul><p><code>./clickhouse benchmark -i 5 --query "select day, hour, appid, count(1) from test.csc_like_all_push_hour_text where day = '2022-02-03' and hour = '00' group by day, hour, appid"</code></p><ul><li>在运行query的同时，执行perf record, 分别对<code>cycles</code>和<code>cpu-clock</code>进行采集。其中<code>cycles</code>事件对应cpu time, <code>cpu-clock</code>事件对应real time. 如</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>perf record -ag -p &lt;clickhouse-pid&gt;  -e  cycles  -- sleep  <span style=color:#bd93f9>15</span>
perf record -ag -p &lt;clickhouse-pid&gt;  -e  cpu-clock  -- sleep  <span style=color:#bd93f9>15</span>
</code></pre></div><ul><li>使用FlameGraph工具(<a href=https://github.com/brendangregg/FlameGraph>https://github.com/brendangregg/FlameGraph</a>，大师Bredan Gregg写的另一个工具) 将事件cycles和cpu-clock的perf.data分别转化为cpu和real火焰图。</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>perf script &gt; out.perf <span style=color:#ff79c6>&amp;&amp;</span> stackcollapse-perf.pl out.perf &gt; out.folded <span style=color:#ff79c6>&amp;&amp;</span> flamegraph.pl out.folded &gt; out.svg
</code></pre></div><p>perf生成的cpu火焰图的示例：</p><p><img src=C:%5Cworkspace%5Cblog_sources%5Cstatic%5Cimages%5Ccpu1.svg alt=cpu1></p><p>perf生成的real火焰图的示例：</p><p><img src=C:%5Cworkspace%5Cblog_sources%5Cstatic%5Cimages%5Creal1.svg alt=real1></p><h2 id=总结>总结</h2><p>本文介绍了两种为clickhouse进程生成火焰图的方法：clickhouse-flamegraph与perf。clickhouse-flamegraph的优点是操作简单，缺点是被观测进程有性能衰减、采样间隔太长。perf在使用上更通用且更精确，但是操作也更复杂。因此建议将clickhouse-flamegraph用于定性分析，快速判定哪个模块是瓶颈；将perf用于定量分析，定位哪个具体函数是瓶颈，并衡量性能优化后的收益。</p><h2 id=参考>参考</h2><p><a href=https://zh-blog.logan.tw/2019/10/06/intro-to-perf-events-and-call-graph>https://zh-blog.logan.tw/2019/10/06/intro-to-perf-events-and-call-graph</a></p><p><a href=https://clickhouse.com/docs/en/interfaces/third-party/gui/>https://clickhouse.com/docs/en/interfaces/third-party/gui/</a></p><p><a href=https://github.tiankonguse.com/blog/2016/03/29/perf-record.html>https://github.tiankonguse.com/blog/2016/03/29/perf-record.html</a></p></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>后端侠</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2022-06-10</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/clickhouse/>clickhouse</a>
<a href=/tags/%E7%81%AB%E7%84%B0%E5%9B%BE/>火焰图</a></div><nav class=post-nav><a class=next href=/post/clickhouse%E6%96%B0%E7%89%B9%E6%80%A7%E4%B9%8B-mergetree%E5%90%AF%E5%8A%A8%E5%8A%A0%E9%80%9F%E4%BD%BF%E7%94%A8%E7%AF%87/><span class="next-text nav-default">clickhouse新特性之————MergeTree启动加速(使用篇)</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><script src=https://utteranc.es/client.js repo=BackendHouse/hugo-comment issue-term=pathname theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=http://github.com/%e5%90%8e%e7%ab%af%e4%be%a0 class="iconfont icon-github" title=github></a><a href=https://backendhouse.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2020 -
2022<span class=heart><i class="iconfont icon-heart"></i></span><span>后端侠</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-SYKLLYTW9K"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-SYKLLYTW9K');</script></body></html>