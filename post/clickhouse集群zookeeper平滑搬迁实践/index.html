<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>clickhouse集群zookeeper平滑搬迁实践 - 后端技术小屋</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="后端侠"><meta name=description content="clickhouse集群zookeeper平滑搬迁实践"><meta name=keywords content="Hugo,theme,后端侠"><meta name=generator content="Hugo 0.62.2 with theme even"><link rel=canonical href=https://backendhouse.github.io/post/clickhouse%E9%9B%86%E7%BE%A4zookeeper%E5%B9%B3%E6%BB%91%E6%90%AC%E8%BF%81%E5%AE%9E%E8%B7%B5/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.a2095472a2a8d7ddda1334cf60051cbe40ed55f2467554bb6aa4c17c9bcd27a4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="clickhouse集群zookeeper平滑搬迁实践"><meta property="og:description" content="clickhouse集群zookeeper平滑搬迁实践"><meta property="og:type" content="article"><meta property="og:url" content="https://backendhouse.github.io/post/clickhouse%E9%9B%86%E7%BE%A4zookeeper%E5%B9%B3%E6%BB%91%E6%90%AC%E8%BF%81%E5%AE%9E%E8%B7%B5/"><meta property="article:published_time" content="2021-03-17T16:18:25+08:00"><meta property="article:modified_time" content="2021-03-17T16:18:25+08:00"><meta itemprop=name content="clickhouse集群zookeeper平滑搬迁实践"><meta itemprop=description content="clickhouse集群zookeeper平滑搬迁实践"><meta itemprop=datePublished content="2021-03-17T16:18:25+08:00"><meta itemprop=dateModified content="2021-03-17T16:18:25+08:00"><meta itemprop=wordCount content="4432"><meta itemprop=keywords content="clickhouse,zookeeper,"><meta name=twitter:card content="summary"><meta name=twitter:title content="clickhouse集群zookeeper平滑搬迁实践"><meta name=twitter:description content="clickhouse集群zookeeper平滑搬迁实践"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>后端技术小屋</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>后端技术小屋</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>clickhouse集群zookeeper平滑搬迁实践</h1><div class=post-meta><span class=post-time>2021-03-17</span><div class=post-category><a href=/categories/clickhouse/>clickhouse</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#背景>〇、背景</a><ul><li><a href=#01-目标与挑战>0.1 目标与挑战</a><ul><li><a href=#011-zk跨洲搬迁需对用户基本无感知>0.1.1 zk跨洲搬迁需对用户基本无感知</a></li><li><a href=#012-热升级动态配置更新>0.1.2 热升级+动态配置更新</a></li></ul></li></ul></li><li><a href=#一整体方案>一、整体方案</a><ul><li><a href=#11-第一步zk从静态配置版本升级到动态配置版本>1.1 第一步：zk从静态配置版本升级到动态配置版本</a></li><li><a href=#12-第二步zk扩缩容实现搬迁>1.2 第二步：zk扩缩容实现搬迁</a></li></ul></li><li><a href=#二遇到的问题和解决方案>二、遇到的问题和解决方案</a><ul><li><a href=#21-zk静态配置版本与动态配置版本不兼容>2.1 zk静态配置版本与动态配置版本不兼容</a></li><li><a href=#22-ck无法动态加载zk配置>2.2 ck无法动态加载zk配置</a></li><li><a href=#23-zk实例重启导致少量ck查询失败>2.3 zk实例重启导致少量ck查询失败</a></li><li><a href=#24-zk实例重启导致写入ck失败>2.4 zk实例重启导致写入ck失败</a></li><li><a href=#25-zk实例重启导致ck表变更失败>2.5 zk实例重启导致ck表变更失败</a></li></ul></li><li><a href=#三最终的搬迁方案>三、最终的搬迁方案</a><ul><li><a href=#30-初始状态>3.0 初始状态</a></li><li><a href=#31-升级到动态配置版本>3.1 升级到动态配置版本</a><ul><li><a href=#311-静态版本---不带config-version检查的静态版本>3.1.1 静态版本 -> 不带(config version检查的)静态版本</a></li><li><a href=#312-不带config-version检查的静态版本---动态版本>3.1.2 不带(config version检查的)静态版本 -> 动态版本</a></li></ul></li><li><a href=#32-动态扩缩容>3.2 动态扩缩容</a><ul><li><a href=#321-扩容将新加坡新机器加入到zk集群中>3.2.1 扩容：将新加坡新机器加入到zk集群中</a></li><li><a href=#322-修改ck配置将zk配置改成新加坡新机器>3.2.2 修改ck配置：将zk配置改成新加坡新机器</a></li><li><a href=#323-缩容将香港老机器从zk集群中摘掉>3.2.3 缩容：将香港老机器从zk集群中摘掉</a></li></ul></li></ul></li><li><a href=#四总结>四、总结</a></li></ul></nav></div></div><div class=post-content><blockquote><p>更多精彩内容，请关注微信公众号：<strong>后端技术小屋</strong></p></blockquote><h1 id=背景>〇、背景</h1><p>注：为简化表述，本文中将clickhouse简称为ck, 将zookeeper简称为zk。</p><p>我司从去年年底开始启动从香港到新加坡机房的迁移。目前Clickhouse集群所有实例都已经搬迁从香港搬迁到了新加坡机房，还剩下其依赖的Zookeeper集群在香港机房，因此我们近期准备将Zookeeper集群平滑搬迁到香港机房。</p><p><img src=https://backendhouse.github.io/images/zk%E6%90%AC%E8%BF%81%E7%9B%AE%E6%A0%87png.png alt=zk搬迁目标png></p><h2 id=01-目标与挑战>0.1 目标与挑战</h2><h3 id=011-zk跨洲搬迁需对用户基本无感知>0.1.1 zk跨洲搬迁需对用户基本无感知</h3><p>ck集群发展到现在已经承载了整个公司的实时数据分析需求，还支持了许多在线服务。这要求ck集群不能够停机，在任何时候都是可用的。ck集群每时每刻都在执行数据插入和查询、表变更，而ck在架构设计上重度依赖zk做元数据存储、副本同步和表变更，zk一旦不可用，ck的读写都会受到影响。zk集群的迁移中间必然引起leader的切换，如何在zk集群搬迁的过程中保证读写，这是一个不小的挑战。</p><h3 id=012-热升级动态配置更新>0.1.2 热升级+动态配置更新</h3><p>为了实现上面的目标，我们在迁移的过程中，一方面要从写入层做好重试，避免zk切主过程中的失败。同时，也要尽可能的缩短zk不可用的时间。对zk的操作都要采用热升级的方式，滚动操作，同时因为zk的集群ip都换了，必然要更改很多配置，所有的配置也尽量采用reload的方式，而不是重启服务。</p><h1 id=一整体方案>一、整体方案</h1><h2 id=11-第一步zk从静态配置版本升级到动态配置版本>1.1 第一步：zk从静态配置版本升级到动态配置版本</h2><p>zk 3.5.0之后支持动态配置特性。利用动态配置特性可方便进行扩容和缩容操作，而不需要对整个zk集群中的所有实例进行滚动重启。但是不巧的是，ck用的zk集群还没有使用动态配置，因此zk集群搬迁的第一步就是将zk集群从静态配置版本平滑升级到动态配置版本，简化后续的扩容和缩容操作。zk动态配置版本详情可参考：https://backendhouse.github.io/post/zookeeper_dynamic_config/</p><h2 id=12-第二步zk扩缩容实现搬迁>1.2 第二步：zk扩缩容实现搬迁</h2><p>第二步，在ck集群升级到动态配置版本之后，通过扩容和缩容操作实现zk集群从香港老机器到新加坡新机器的平滑搬迁：</p><ul><li>扩容：将新加坡机房的新机器一台一台加入到zk集群中</li><li>ck实例修改zk配置：将zk配置全部从老机器换成新机器</li><li>缩容：将香港机房的老机器一台一台从zk集群中摘除。</li></ul><p><img src=https://backendhouse.github.io/images/zk%E6%90%AC%E8%BF%81%E6%AD%A5%E9%AA%A4.png alt=zk搬迁步骤></p><h1 id=二遇到的问题和解决方案>二、遇到的问题和解决方案</h1><p>为了保证线上zk搬迁过程中不出问题，我们事前进行充分的影响面预估和线下演练，在这个过程中发现了以下问题：</p><h2 id=21-zk静态配置版本与动态配置版本不兼容>2.1 zk静态配置版本与动态配置版本不兼容</h2><p>在1.1中，首先将zk中的Follower实例从静态配置升级到动态配置版本时，发现升级中的Follower实例报错：<br>Follower报错日志如下：</p><pre><code>2021-02-25 11:07:03,081 [myid:5] - WARN  [QuorumPeer[myid=5](plain=/0:0:0:0:0:0:0:0:2185)(secure=disabled):Follower@96] - Exception when following the leader  
java.io.EOFException  
        at java.io.DataInputStream.readInt(DataInputStream.java:392)  
        at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)  
        at org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:85)  
        at org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:99)  
        at org.apache.zookeeper.server.quorum.Learner.readPacket(Learner.java:158)  
        at org.apache.zookeeper.server.quorum.Learner.registerWithLeader(Learner.java:336)  
        at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:78)  
        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:1271)  
2021-02-25 11:07:03,081 [myid:5] - INFO  [QuorumPeer[myid=5](plain=/0:0:0:0:0:0:0:0:2185)(secure=disabled):Follower@201] - shutdown called  
java.lang.Exception: shutdown Follower  
        at org.apache.zookeeper.server.quorum.Follower.shutdown(Follower.java:201)  
        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:1275)  
</code></pre><p>同时，尚未升级的Leader实例报错如下：</p><pre><code>2021-02-26 19:35:08,065 [myid:6] - WARN  [LearnerHandler-/xx.xx.xx.xx:52906:LearnerHandler@644] - ******* GOODBYE /xx.xx.xx.xx:52906 ********  
2021-02-26 19:35:08,066 [myid:6] - INFO  [WorkerReceiver[myid=6]:FastLeaderElection$Messenger$WorkerReceiver@285] - 6 Received version: b00000000 my version: 0  
2021-02-26 19:35:08,066 [myid:6] - INFO  [WorkerReceiver[myid=6]:FastLeaderElection@679] - Notification: 2 (message format version), 5 (n.leader), 0xb0000000c (n.zxid), 0x2 (n.round), LOOKING (n.state), 5 (n.sid), 0xb (n.peerEPoch), LEADING (my state)b00000000 (n.config version)  
2021-02-26 19:35:08,067 [myid:6] - ERROR [LearnerHandler-/xx.xx.xx.xx:52908:LearnerHandler@629] - Unexpected exception causing shutdown while sock still open  
java.io.IOException: Follower is ahead of the leader (has a later activated configuration)  
        at org.apache.zookeeper.server.quorum.LearnerHandler.run(LearnerHandler.java:398)  
</code></pre><p>经过定位，发现问题出在静态版本的Leader实例与动态版本的Follower实例不可共存。在串行升级zk的过程中，为了尽量减少zk集群不可用时间，我们先升级完所有Follower, 最后再升级Leader。 当一个Follower实例从静态配置版本升级到动态配置版本之后，此时Leader还处于静态配置版本，其config version是0; 而Follower此时处于动态版本，config version大于0。</p><p>Follower启动之后会请求Leader，请求数据中带上config version. Leader收到请求之后会对Follower的config version做校验，如果发现对方config version大于自己，便抛异常(Follower is ahead of the leader)并主动关闭连接。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>learnerInfoData<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span> <span style=color:#ff79c6>&gt;</span><span style=color:#ff79c6>=</span> 20<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>  
                    <span style=color:#8be9fd>long</span> configVersion <span style=color:#ff79c6>=</span> bbsid<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getLong</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>;</span>  
                    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>configVersion <span style=color:#ff79c6>&gt;</span> leader<span style=color:#ff79c6>.</span><span style=color:#50fa7b>self</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getQuorumVerifier</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getVersion</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>  
                        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IOException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;Follower is ahead of the leader (has a later activated configuration)&#34;</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>;</span>  
                    <span style=color:#ff79c6>}</span>  
                <span style=color:#ff79c6>}</span>  
</code></pre></div><p>而Follower读到EOF之后也会抛异常(EOFException)，并不断重试。</p><p>摆在眼前的解决方案有两种：</p><ul><li>方案一：串行升级改成并行升级，避免静态版本与动态版本的实例同时存在。</li><li>方案二：由于静态版本和动态版本同时存在的时间很短，zk增加一个临时版本，该版本中去掉Leader对Follower的config version检查，绕过上述问题</li></ul><p>考虑到zk集群中数据较多，zk实例启动时间较长，并行升级会导致zk集群在2-4min内不可用。一旦出现问题发生回滚，zk集群不可用时间还会翻倍，风险较大。于是我们摒弃方案一，选择方案二：先将静态版本串行升级到去掉config version检查的静态版本，再升级到动态版本。</p><h2 id=22-ck无法动态加载zk配置>2.2 ck无法动态加载zk配置</h2><p>在线下演练过程中发现，在1.2中，当修改clickhouse配置文件中的zk server列表后，配置变更并不会被ck动态加载。而clickhouse上的应用已经如此之多，其中不乏一些2B业务或对实时性要求非常强的业务，通过重启ck集群去加载新的zk server列表显然不可接受。</p><p>最终的解决方案是增加clickhouse对zk配置动态加载的支持，从而避免重启ck集群影响用户。目前这一优化已经合并到社区，PR: <a href=https://github.com/ClickHouse/ClickHouse/pull/14678>https://github.com/ClickHouse/ClickHouse/pull/14678</a></p><h2 id=23-zk实例重启导致少量ck查询失败>2.3 zk实例重启导致少量ck查询失败</h2><p>ck查询一般不涉及zk交互，因此zk搬迁大部分情况下不影响ck查询。但是在线下演练过程中发现，当clickhouse开启了开关<code>optimize_trivial_count_query</code>之后, 对应PR: <a href=https://github.com/ClickHouse/ClickHouse/pull/7510>https://github.com/ClickHouse/ClickHouse/pull/7510</a>，执行一些简单的<code>select count</code>查询会被zk搬迁所影响。</p><p>追查代码发现，<code>optimize_trivial_count_query</code>开启后，对于简单的<code>select count</code>查询，ck会跳过常规的查询过程，转而从metadata中获取总行数(在此过程中会访问zk)，以此来提高<code>select count</code>的查询速度。因此，在zk集群搬迁之前，我们将clickhouse集群中的开关<code>optimize_trivial_count_query</code>设置为0，待zk搬迁完成之后再将其开启。</p><h2 id=24-zk实例重启导致写入ck失败>2.4 zk实例重启导致写入ck失败</h2><p>在向ck写入数据时，ck依赖zk集群分配blockid，并将数据从当前副本同步到配偶副本。因此zk搬迁过程中必定会影响ck写入。而我们要做的便是将影响写入的时间段尽量缩短；同时一旦发现写入失败针对同一个分片下的副本不断重试，保证zk集群恢复时，ck写入也能自动恢复。</p><p>目前有Flink、Spark和clickhouse_sinker三个入口往ck写数据，在zk搬迁之前我们需要提前确保它们写ck的过程已经有了重试机制。</p><h2 id=25-zk实例重启导致ck表变更失败>2.5 zk实例重启导致ck表变更失败</h2><p>表变更操作包括创建/删除表、新增/删除/修改字段。ck集群在执行表变更时必然会访问ck集群，因此zk搬迁过程中会影响ck集群中的表变更。因为ck表变更相对于ck写入与查询来说频率较低。因此在zk搬迁过程中，我们对ck平台进行功能降级，即此时不支持ck表变更操作，以此避免zk实例重启导致ck表变更失败。</p><h1 id=三最终的搬迁方案>三、最终的搬迁方案</h1><h2 id=30-初始状态>3.0 初始状态</h2><p>假设香港机器：A1, A2, A3, A4, A5，新加坡机器：B1, B2, B3, B4, B5<br>初始状态下，zk集群部署于香港机房，初始版本为静态配置版本。<br>我们的目标是将zk集群搬迁到新机房，最终版本为动态配置版本。</p><h2 id=31-升级到动态配置版本>3.1 升级到动态配置版本</h2><p>版本升级路线：静态版本 -> (不带config version检查的)静态版本 -> 动态版本</p><h3 id=311-静态版本---不带config-version检查的静态版本>3.1.1 静态版本 -> 不带(config version检查的)静态版本</h3><p>串行升级，先升级Follower, 最后升级Leader。每升级完一台机器，检查集群中Leader/Follower状态，检查ck查询和写入是否有异常。等待zk实例完成启动后，接着再升级下一个zk实例。</p><p>预期影响：</p><ul><li>升级Follower实例时，ck到该zk实例上的连接被断开，部分ck写入可能会报<code>zookeeper session expired</code>错误，ck重连其他zk实例后恢复正常，恢复时间不超过40s。</li><li>升级Leader实例时，zk会进入选举周期并会产生新的Leader, ck写入会报<code>table in readonly mode</code>错误，新Leader产生之后ck写入恢复正常，恢复时间不超过3min.</li></ul><p>回滚方案：直接并行回滚到初始的静态版本</p><h3 id=312-不带config-version检查的静态版本---动态版本>3.1.2 不带(config version检查的)静态版本 -> 动态版本</h3><p>升级步骤、预期影响面、回滚方案同3.1.1</p><h2 id=32-动态扩缩容>3.2 动态扩缩容</h2><h3 id=321-扩容将新加坡新机器加入到zk集群中>3.2.1 扩容：将新加坡新机器加入到zk集群中</h3><p>串行扩容步骤：</p><ul><li>在新机器B1上部署zk实例, 其配置中包含A1-A5和B1。通过<code>reconfig -add 6=B1:2888:3888;2181</code>将B1加入到集群中。接着检查当前所有zk实例的本地配置是否已更新，检查Leader/Follower状态，检查ck读写是否有异常，确认无问题后扩容下一台机器</li><li>在新机器B2上部署zk实例, 其配置中包含A1-A5和B1-B2。通过<code>reconfig -add 7=B2:2888:3888;2181</code>将B2加入到集群中。检查步骤同上</li><li>&mldr;</li><li>重复执行以上步骤，直到所有新机器都已经加入到zk集群中。</li></ul><p>预期影响：无</p><p>回滚步骤：在串行扩容过程中，如果有任何一步出现异常，则将新实例通过<code>reconfig -remove &lt;id></code>命令从集群中摘掉。</p><h3 id=322-修改ck配置将zk配置改成新加坡新机器>3.2.2 修改ck配置：将zk配置改成新加坡新机器</h3><p>修改ck配置，将<code>zookeeper-servers</code>从旧机器A1-A5改成新机器B1-B5，并下发到所有ck实例。<code>netstat</code>命令检查ck是否与新zk实例建立连接。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#ff79c6>&lt;zookeeper-servers</span><span style=color:#ff79c6>&gt;</span>  
      <span style=color:#ff79c6>&lt;node</span> <span style=color:#50fa7b>index=</span><span style=color:#f1fa8c>&#34;0&#34;</span><span style=color:#ff79c6>&gt;</span>  
          <span style=color:#ff79c6>&lt;host</span><span style=color:#ff79c6>&gt;</span>A1<span style=color:#ff79c6>&lt;/host&gt;</span>  
          <span style=color:#ff79c6>&lt;port</span><span style=color:#ff79c6>&gt;</span>2181<span style=color:#ff79c6>&lt;/port&gt;</span>  
      <span style=color:#ff79c6>&lt;/node&gt;</span>  
      <span style=color:#ff79c6>&lt;node</span> <span style=color:#50fa7b>index=</span><span style=color:#f1fa8c>&#34;1&#34;</span><span style=color:#ff79c6>&gt;</span>  
          <span style=color:#ff79c6>&lt;host</span><span style=color:#ff79c6>&gt;</span>A2<span style=color:#ff79c6>&lt;/host&gt;</span>  
          <span style=color:#ff79c6>&lt;port</span><span style=color:#ff79c6>&gt;</span>2181<span style=color:#ff79c6>&lt;/port&gt;</span>  
      <span style=color:#ff79c6>&lt;/node&gt;</span>  
      <span style=color:#ff79c6>&lt;node</span> <span style=color:#50fa7b>index=</span><span style=color:#f1fa8c>&#34;2&#34;</span><span style=color:#ff79c6>&gt;</span>  
          <span style=color:#ff79c6>&lt;host</span><span style=color:#ff79c6>&gt;</span>A3<span style=color:#ff79c6>&lt;/host&gt;</span>  
          <span style=color:#ff79c6>&lt;port</span><span style=color:#ff79c6>&gt;</span>2181<span style=color:#ff79c6>&lt;/port&gt;</span>  
      <span style=color:#ff79c6>&lt;/node&gt;</span>  
      <span style=color:#ff79c6>&lt;node</span> <span style=color:#50fa7b>index=</span><span style=color:#f1fa8c>&#34;3&#34;</span><span style=color:#ff79c6>&gt;</span>  
          <span style=color:#ff79c6>&lt;host</span><span style=color:#ff79c6>&gt;</span>A4<span style=color:#ff79c6>&lt;/host&gt;</span>  
          <span style=color:#ff79c6>&lt;port</span><span style=color:#ff79c6>&gt;</span>2181<span style=color:#ff79c6>&lt;/port&gt;</span>  
      <span style=color:#ff79c6>&lt;/node&gt;</span>  
      <span style=color:#ff79c6>&lt;node</span> <span style=color:#50fa7b>index=</span><span style=color:#f1fa8c>&#34;4&#34;</span><span style=color:#ff79c6>&gt;</span>  
          <span style=color:#ff79c6>&lt;host</span><span style=color:#ff79c6>&gt;</span>A5<span style=color:#ff79c6>&lt;/host&gt;</span>  
          <span style=color:#ff79c6>&lt;port</span><span style=color:#ff79c6>&gt;</span>2181<span style=color:#ff79c6>&lt;/port&gt;</span>  
      <span style=color:#ff79c6>&lt;/node&gt;</span>  
<span style=color:#ff79c6>&lt;/zookeeper-servers&gt;</span>  
</code></pre></div><p>预期影响：无</p><p>回滚：一旦检查过程中发现异常，将ck配置回滚并重新下发。</p><h3 id=323-缩容将香港老机器从zk集群中摘掉>3.2.3 缩容：将香港老机器从zk集群中摘掉</h3><p>串行缩容过程中，应当遵循先缩容Follower实例，最后缩容Leader实例的顺序，具体步骤如下：</p><ul><li>缩容A1: 通过<code>reconfig -remove 1=A1:2888:3888;2181</code>命令，将老机器A1从集群中摘除。接着检查当前所有zk实例的本地配置是否自动更新，检查Leader/Follower状态，检查ck读写是否出现异常。确认无问题后，将老机器A1上的zk实例下线。</li><li>缩容A2, 操作同上</li><li>&mldr;</li><li>重复执行以上操作，直到所有香港老机器都已经从zk集群中摘除。</li></ul><p>预期影响：同3.1.1</p><p>回滚：在串行缩容过程中，如果有任何一步出现异常，通过<code>reconfig -add &lt;id>=&lt;ip>:2888:3888;2181</code>命令将待下线实例重新加入zk集群中。</p><h1 id=四总结>四、总结</h1><p>通过线下环境中充分的zk搬迁演练，我们得以及时发现zk搬迁中出现的各种问题，并一一加以解决。最终在ck用户基本无感知的情况下，完成了zk集群从香港到新加坡的平滑迁移。</p><blockquote><p>更多精彩内容，请扫码关注微信公众号：<strong>后端技术小屋</strong>。如果觉得文章对你有帮助的话，请多多分享、转发、在看。<br><img src=https://backendhouse.github.io/images/qrcode.png alt=二维码></p></blockquote></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>后端侠</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2021-03-17</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/clickhouse/>clickhouse</a>
<a href=/tags/zookeeper/>zookeeper</a></div><nav class=post-nav><a class=prev href=/post/boltdb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E4%BA%8C-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/><i class="iconfont icon-left"></i><span class="prev-text nav-default">Boltdb学习笔记之二--数据结构</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/post/zookeeper_dynamic_config/><span class="next-text nav-default">zookeeper动态配置应用</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><script src=https://utteranc.es/client.js repo=BackendHouse/hugo-comment issue-term=pathname theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=http://github.com/%e5%90%8e%e7%ab%af%e4%be%a0 class="iconfont icon-github" title=github></a><a href=https://backendhouse.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2020 -
2022<span class=heart><i class="iconfont icon-heart"></i></span><span>后端侠</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-SYKLLYTW9K"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-SYKLLYTW9K');</script></body></html>