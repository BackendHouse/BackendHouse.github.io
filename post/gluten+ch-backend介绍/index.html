<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Gluten+CH backend介绍 - 后端技术小屋</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="后端侠"><meta name=description content="Gluten介绍 随着存储技术的进步，特别是SSD和万兆网卡的普及，IO性能得到了显著提升，此时CPU计算逐渐成为至于大数据处理速度的新瓶颈。"><meta name=keywords content="Hugo,theme,后端侠"><meta name=generator content="Hugo 0.62.2 with theme even"><link rel=canonical href=https://backendhouse.github.io/post/gluten+ch-backend%E4%BB%8B%E7%BB%8D/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.a2095472a2a8d7ddda1334cf60051cbe40ed55f2467554bb6aa4c17c9bcd27a4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="Gluten+CH backend介绍"><meta property="og:description" content="Gluten介绍 随着存储技术的进步，特别是SSD和万兆网卡的普及，IO性能得到了显著提升，此时CPU计算逐渐成为至于大数据处理速度的新瓶颈。"><meta property="og:type" content="article"><meta property="og:url" content="https://backendhouse.github.io/post/gluten+ch-backend%E4%BB%8B%E7%BB%8D/"><meta property="article:published_time" content="2025-05-22T18:24:05+08:00"><meta property="article:modified_time" content="2025-05-22T18:24:05+08:00"><meta itemprop=name content="Gluten+CH backend介绍"><meta itemprop=description content="Gluten介绍 随着存储技术的进步，特别是SSD和万兆网卡的普及，IO性能得到了显著提升，此时CPU计算逐渐成为至于大数据处理速度的新瓶颈。"><meta itemprop=datePublished content="2025-05-22T18:24:05+08:00"><meta itemprop=dateModified content="2025-05-22T18:24:05+08:00"><meta itemprop=wordCount content="4703"><meta itemprop=keywords content="gluten,clickhouse,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Gluten+CH backend介绍"><meta name=twitter:description content="Gluten介绍 随着存储技术的进步，特别是SSD和万兆网卡的普及，IO性能得到了显著提升，此时CPU计算逐渐成为至于大数据处理速度的新瓶颈。"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>后端技术小屋</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>后端技术小屋</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Gluten+CH backend介绍</h1><div class=post-meta><span class=post-time>2025-05-22</span><div class=post-category><a href=/categories/gluten/>gluten</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#gluten介绍>Gluten介绍</a><ul><li><a href=#gluten架构设计>Gluten架构设计</a></li><li><a href=#我们的工作>我们的工作</a><ul><li><a href=#类型支持>类型支持</a></li><li><a href=#函数支持>函数支持</a></li><li><a href=#算子支持>算子支持</a></li></ul></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class=post-content><h1 id=gluten介绍>Gluten介绍</h1><p>随着存储技术的进步，特别是SSD和万兆网卡的普及，IO性能得到了显著提升，此时CPU计算逐渐成为至于大数据处理速度的新瓶颈。而基于jvm的语言对CPU向量化的支持要远远小于其他native语言(c++/rust)。目前开源社区中比较成熟的开源Native Engine有</p><ul><li>Velox, Meta开源，以库的形式提供OLAP系统的核心功能：计划、表达式、向量化执行等</li><li>CH, Yandex开源，生态强大，使用者众多。</li><li>其他：DuckDB等。</li></ul><p>Databricks的Photon项目开启了使用Native Engine技术加速Spark查询的先河。在这样的背景下，Gluten项目于2021年由Intel和Kyligence共同发起，旨在将spark的可扩展性、优化器、容错能力和native engine的向量化执行能力结合起来，来加速spark查询。在各个大厂普遍降本增效的背景下，该项目获得了越来越多的关注，也得到了社区的广泛支持，先后有BIGO、美团、阿里云、网易、百度、微软等知名企业加入到Gluten的开发和贡献中来。2024年3月份gluten加入到apache孵化器。在这个赛道上，Gluten还有其他竞争者，如快手的Blaze和苹果的Apache Datafusion Comet，不过从功能完善度和社区活跃度上看，Gluten处于领先地位。</p><h2 id=gluten架构设计>Gluten架构设计</h2><p><img src=https://backendhouse.github.io/images/Gluten%E6%80%A7%E8%83%BD%E4%B9%8BIO%E4%BC%98%E5%8C%96%E7%AF%87/image.png alt="alt text"></p><p>以上是Gluten的整体架构设计。Spark提供了插件机制，插件可以在不侵入Spark自身代码的前提下重写Spark plan, 从而实现定制化的功能。Gluten就是以插件的形式集成到Spark中。</p><p>在Physical Plan交给Gluten Plugin 的时候，会添加一些扩展的规则，然后把 Physical Plan 转换成语言无关的 Substrait Plan。经过这个转换后再交由下面的各种Native向量化引擎去执行计算。各自的向量化引擎会根据SubstraitPlan构建自己的Execute pipeline，然后读取Input数据去做计算，计算完后都会以列式方式返回给Spark。</p><p>在整个流转过程当中，Gluten的Plugin层起到承上启下的关系。Gluten Plugin有哪些组件呢？</p><ul><li>Plan Conversion: gluten插件拿到spark的物理计划之后，plan conversion会通过扩展spark rule将其转化为substrait plan, substrait plan再通过jni接口传递给底层的native engine. native engine拿到substrait plan之后，首先会将其转化成自身的plan, 然后基于自身plan构建pipeline, 最后执行pipeline返回列式结果。列式结果再通过jni接口返回到jvm。</li><li>Memory Manager: 虽然native engine和jvm是不同语言，但是他们在同一个进程之内，共享相同的内存空间，native engine属于offHeap内存，jvm属于onHeap内存。为了避免spark driver/executor进程超出限制，也为了能充分利用分配的内存上线，对native engine和jvm中内存的统一管理就显得尤其重要。</li><li>Columnar Shuffle: Shuffle是spark任务执行过程中比较重的算子，join/aggregate/sort算子都会触发shuffle。spark自带shuffle reader的输出是行式的，为了能给native engine提供列式输入，必然要在shuffle算子后置一个行转列(R2C)算子，同样的为了兼容native engine的列式输出，shuffle writer也需要前置一个列转行(C2R)算子。但是不管行转列还是列转行都没有任何实质计算，只是为了兼容native engine执行。为了消除行转列开销，gluten扩展出了Columnar shuffle。</li><li>Shim Layer: 我们知道Spark的版本一直在升级，不同版本的内部实现会有一些微小差异。Gluten通过Shim Layer来兼容这些diff。截止目前Shim Layer兼容的spark版本有3.3, 3.4, 3.5。</li><li>Fallback: spark中有很多算子和表达式，gluten在发展初期不可能完全支持他们。当遇到gluten不支持的情况，首先会通过fallback机制退回到jvm执行。类似上面的shuffle, 由于jvm是行式执行，native engine是列式执行，一旦算子出现fallback, 在二者的边界必然要引入r2c, c2r开销，造成额外的性能开销，甚至性能不如全部在jvm中执行。因此Fallback其实是为了保证功能正确的无奈之举。为了避免Fallback对性能造成太大影响，仅支持对包含leaf节点的计划树进行fallback，整个计划中fallback次数有上限。</li></ul><p><img src=https://backendhouse.github.io/images/Gluten%E6%80%A7%E8%83%BD%E4%B9%8BIO%E4%BC%98%E5%8C%96%E7%AF%87/image-4.png alt="alt text"></p><ul><li>Metrics：收集native engine执行过程中的指标，上报给spark, 方便在webui中可视化。一般包含input rows, input bytes, output rows, output bytes, execution time, waiting time for input, waiting time for output.</li></ul><p><img src=https://backendhouse.github.io/images/Gluten%E6%80%A7%E8%83%BD%E4%B9%8BIO%E4%BC%98%E5%8C%96%E7%AF%87/image-1.png alt="alt text">
以上是gluten计划的详细转换过程，我们看到:</p><ul><li>spark层面：用户可能以不同的方式表示计算逻辑: spark-sql, dataset, 或dataframe, spark对这些逻辑统一处理，首先生成unresolved plan, 绑定catalog中元数据之后，生成logical plan。不管来自spark还是gluten，都会有一系列的rule对logical plan进行改写，生成optimized logical plan, 最终生成physical plan。</li><li>gluten层面：gluten通过注入rule，改写spark physical plan, 将其转化成对应的substrait plan。Substrait是一个开源项目, 旨在通过一个统一的计划表示层，在不同的查询引擎之间进行数据交换。</li><li>native engine层面: 拿到substrait plan之后，先转化为自身的physical plan, 然后构建pipeline，最后执行。</li></ul><h2 id=我们的工作>我们的工作</h2><p>我们的目标是使用Apache Gluten加速生产环境离线ETL任务。</p><p>Gluten目前支持两种Native Engine, Velox与ClickHouse。我们最终选择了ClickHouse作为计划执行的后端。理由有三</p><ul><li>社区与生态：ClickHouse社区比较开放, 只要是有利于性能的改动，社区都比较欢迎，PR响应的也很及时。而且CH经过这么多年的发展，它的算子、表达式、类型等核心功能都支持的比较完善。</li><li>团队技术栈：我们团队维护有CH集群，对CH有丰富的使用和二开经验。在加入Gluten社区之前，我们也给CH社区贡献了一些比较大的PR, 包括<a href>hive engine</a>, <a href=https://github.com/ClickHouse/ClickHouse/pull/31104>mergetree启动加速</a>，<a href=https://github.com/ClickHouse/ClickHouse/pull/36415>parallel hash join</a>等。</li><li>工具链：CH的开发工具链非常完善，有利于保证代码质量，包括compiler/profiler/sanitizer/tests/benchmarks/performance report等。</li></ul><p>在我们加入Gluten + CH Backend的开发之前，它的功能支持还处于初级阶段，很多类型、算子、表达式都不支持。经历了两年多的开发，我们持了生产环境所有的算子、类型和表达式，保证了所有spark任务都能够通过Gluten offload到CH backend中执行。目前Gluten已基本在我们生产环境落地，相比Vanilla Spark能够节约一半的资源。</p><h3 id=类型支持>类型支持</h3><p>我们支持了以下类型，覆盖了生产环境的所有类型。</p><ul><li>Null</li><li>Timestamp</li><li>Short</li><li>Byte</li><li>Binary</li><li>Decimal</li><li>Array</li><li>Map</li><li>Struct</li></ul><p>归功于CH社区的完备，所有Spark类型在CH中都有对标，spark和CH中类型的映射关系如下。</p><p><img src=https://backendhouse.github.io/images/Gluten%E6%80%A7%E8%83%BD%E4%B9%8BIO%E4%BC%98%E5%8C%96%E7%AF%87/image-2.png alt="alt text"></p><h3 id=函数支持>函数支持</h3><p>函数分为三类，简单函数、聚合函数和窗口函数。我们支持100+简单函数、10+聚合函数和窗口函数，覆盖了生产环境的所有函数。</p><p>函数支持的开发上，分为三种情况</p><ul><li>CH中已有对标函数，且语义相同。这种情况只需在spark和ch表达式之间建议简单映射即可。</li><li>CH中已有对标函数，语义在某些corner case下不同。这种情况需要将spark function转化为ch 表达式组合。例如CH中<code>substring(‘hello’, offset = 0)</code>返回的是空字符串，而Spark中<code>substring(‘hello’, offset = 0)</code>返回的是<code>hello</code>, 为了消除他们之间的diff, 我们将spark函数<code>substring(str, start)</code>转化为<code>substring(str, if(start = 0, 1, start))</code>。我们引入了Function Parser框架，用户可基于其扩展某个spark函数转成CH表达式的定制化逻辑，避免了重新开发新CH函数。</li><li>CH无对标函数。这时候就需要在CH中实现新函数。在这个过程中，我们尽量将通用功能贡献给CH社区。</li></ul><h3 id=算子支持>算子支持</h3><p>我们实现了以下算子，覆盖生产环境中所有算子</p><h4 id=scangeneratefilterunionsortlimit算子>Scan/Generate/Filter/Union/Sort/Limit算子</h4><p>Scan算子: CH本身支持了对HDFS数据源的读取，也支持ORC/Parquet/JSON/Text等格式，因此只需通过Gluten集成。注意这里需考虑partition column的特殊处理。
Filter/Union/Sort/Limit等算子：CH中都有实现，需在gluten将其与spark一一映射。这里不赘述</p><p>Generate算子：对应spark sql中lateral view explode/posexplode, CH中有对应实现Array Join算子。</p><h4 id=expand算子>Expand算子</h4><p>对应spark sql中的with cube，with rollup或grouping sets语句。我们基于CH实现了Expand算子。我们实现了两版Expand算子。</p><p>第一版Expand算子会在Aggregate算子之前，将一行数据按照grouping sets扩展成多行数据，从而实现expand语义。</p><pre><code>expand -&gt; aggregate partial -&gt; shuffle -&gt; aggregate final 
</code></pre><p>第二版AdvancedExpand算子基于第一版做了优化，将aggregate放在aggregate partial阶段之后。这样做的好处是，将expand后置，能够减少aggregate partial处理的数据量。</p><pre><code>aggregate partial -&gt; advanced expand -&gt; shuffle -&gt; aggregate final
</code></pre><h4 id=aggregate算子>Aggregate算子</h4><p>CH中aggregate分为两阶段，第一阶段对输入数据进行部分聚合，第二阶段对第一阶段产生的中间结果进行进一步聚合。但是在高基数场景下容易导致第二阶段OOM，我们针对第二阶段支持了spill功能，使其在内存紧张时能够自动将hash table spill到本地磁盘。</p><h4 id=join算子>Join算子</h4><p>CH中join算子有不同的实现，其中merge join有partial merge join和full merge join, hash join有grace hash join, hash join, parallel hash join. 不同join算法的实现可参考<a href=https://clickhouse.com/blog/clickhouse-fully-supports-joins-hash-joins-part2>ClickHouse Joins Under the Hood - Hash Join, Parallel Hash Join, Grace Hash Join</a>。我们在gluten中实现了自适应的join算法选择，同时补足了grace hash join的right/full join语义，和ASOF JOIN语义。</p><h4 id=行列转换算子>行列转换算子</h4><p>实现Spark Row行式数据和CH Block列式数据的互换。如下所示，设计上将所有类型分为两类，定长类型(integer/decimal/floating), 和变长类型(array/map/struct/string)。定长类型的行列转换由FixedLengthDataWriter和FixedLengthDataReader实现，变长类型的行列转换由VariableLengthDataReader和VariableLengthDataWriter实现。<a href=https://github.com/Kyligence/ClickHouse/pull/163#issuecomment-1286721535>详细设计</a></p><h1 id=总结>总结</h1><p>通过引入Gluten并结合ClickHouse作为Native Engine，我们成功实现了Spark离线ETL任务的加速，显著提升了资源利用率和执行效率。在类型、函数和算子支持方面，我们实现了与生产环境高度兼容的能力，确保了所有Spark任务能够顺利迁移并稳定运行在Gluten+CH架构下。</p></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>后端侠</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2025-05-22</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/gluten/>gluten</a>
<a href=/tags/clickhouse/>clickhouse</a></div><nav class=post-nav><a class=next href=/post/gluten%E4%B8%ADsubstrait%E7%AE%97%E5%AD%90%E7%9A%84%E8%BD%AC%E5%8C%96%E5%92%8Cch%E7%AE%97%E5%AD%90%E7%9A%84%E5%AE%9E%E7%8E%B0/><span class="next-text nav-default">Gluten中Substrait算子的转化和CH算子的实现</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><script src=https://utteranc.es/client.js repo=BackendHouse/hugo-comment issue-term=pathname theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=http://github.com/%e5%90%8e%e7%ab%af%e4%be%a0 class="iconfont icon-github" title=github></a><a href=https://backendhouse.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2020 -
2025<span class=heart><i class="iconfont icon-heart"></i></span><span>后端侠</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-SYKLLYTW9K"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-SYKLLYTW9K');</script></body></html>