<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Gluten中Substrait算子的转化和CH算子的实现 - 后端技术小屋</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="后端侠"><meta name=description content="如何打印计划 spark plan 首先在本地部署thriftserver 然后建表 CREATE TEMPORARY VIEW lineitem USING org.apache.spark.sql.parquet OPTIONS ( path &amp;#34;/data1/liyang/cppproject/gluten/gluten-core/src/test/resources/tpch-data/lineitem&amp;#34; ); 拿到TPC-H Q1 SELECT l_returnflag, l_linestatus, sum(l_quantity) AS sum_qty, sum(l_extendedprice) AS sum_base_price, sum(l_extendedprice * (1 - l_discount)) AS sum_disc_price, sum(l_extendedprice * (1 -"><meta name=keywords content="Hugo,theme,后端侠"><meta name=generator content="Hugo 0.62.2 with theme even"><link rel=canonical href=https://backendhouse.github.io/post/gluten%E4%B8%ADsubstrait%E7%AE%97%E5%AD%90%E7%9A%84%E8%BD%AC%E5%8C%96%E5%92%8Cch%E7%AE%97%E5%AD%90%E7%9A%84%E5%AE%9E%E7%8E%B0/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.a2095472a2a8d7ddda1334cf60051cbe40ed55f2467554bb6aa4c17c9bcd27a4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="Gluten中Substrait算子的转化和CH算子的实现"><meta property="og:description" content="如何打印计划 spark plan 首先在本地部署thriftserver 然后建表 CREATE TEMPORARY VIEW lineitem USING org.apache.spark.sql.parquet OPTIONS ( path &#34;/data1/liyang/cppproject/gluten/gluten-core/src/test/resources/tpch-data/lineitem&#34; ); 拿到TPC-H Q1 SELECT l_returnflag, l_linestatus, sum(l_quantity) AS sum_qty, sum(l_extendedprice) AS sum_base_price, sum(l_extendedprice * (1 - l_discount)) AS sum_disc_price, sum(l_extendedprice * (1 -"><meta property="og:type" content="article"><meta property="og:url" content="https://backendhouse.github.io/post/gluten%E4%B8%ADsubstrait%E7%AE%97%E5%AD%90%E7%9A%84%E8%BD%AC%E5%8C%96%E5%92%8Cch%E7%AE%97%E5%AD%90%E7%9A%84%E5%AE%9E%E7%8E%B0/"><meta property="article:published_time" content="2025-05-21T18:24:05+08:00"><meta property="article:modified_time" content="2025-05-21T18:24:05+08:00"><meta itemprop=name content="Gluten中Substrait算子的转化和CH算子的实现"><meta itemprop=description content="如何打印计划 spark plan 首先在本地部署thriftserver 然后建表 CREATE TEMPORARY VIEW lineitem USING org.apache.spark.sql.parquet OPTIONS ( path &#34;/data1/liyang/cppproject/gluten/gluten-core/src/test/resources/tpch-data/lineitem&#34; ); 拿到TPC-H Q1 SELECT l_returnflag, l_linestatus, sum(l_quantity) AS sum_qty, sum(l_extendedprice) AS sum_base_price, sum(l_extendedprice * (1 - l_discount)) AS sum_disc_price, sum(l_extendedprice * (1 -"><meta itemprop=datePublished content="2025-05-21T18:24:05+08:00"><meta itemprop=dateModified content="2025-05-21T18:24:05+08:00"><meta itemprop=wordCount content="12416"><meta itemprop=keywords content="gluten,clickhouse,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Gluten中Substrait算子的转化和CH算子的实现"><meta name=twitter:description content="如何打印计划 spark plan 首先在本地部署thriftserver 然后建表 CREATE TEMPORARY VIEW lineitem USING org.apache.spark.sql.parquet OPTIONS ( path &#34;/data1/liyang/cppproject/gluten/gluten-core/src/test/resources/tpch-data/lineitem&#34; ); 拿到TPC-H Q1 SELECT l_returnflag, l_linestatus, sum(l_quantity) AS sum_qty, sum(l_extendedprice) AS sum_base_price, sum(l_extendedprice * (1 - l_discount)) AS sum_disc_price, sum(l_extendedprice * (1 -"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>后端技术小屋</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>后端技术小屋</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Gluten中Substrait算子的转化和CH算子的实现</h1><div class=post-meta><span class=post-time>2025-05-21</span><div class=post-category><a href=/categories/gluten/>gluten</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#如何打印计划>如何打印计划</a><ul><li><a href=#spark-plan>spark plan</a></li><li><a href=#substrait-plan>substrait plan</a></li><li><a href=#clickhouse-plan>clickhouse plan</a></li><li><a href=#其他>其他</a></li></ul></li><li><a href=#计划解读>计划解读</a><ul><li><a href=#表达式>表达式</a><ul><li><a href=#ch表达式>CH表达式</a></li><li><a href=#substrait表达式>substrait表达式</a></li><li><a href=#substrait到ch表达式的转化>substrait到CH表达式的转化</a></li></ul></li><li><a href=#算子>算子</a><ul><li><a href=#substrait算子>substrait算子</a></li><li><a href=#ch算子>CH算子</a></li><li><a href=#substrait到ch算子的转化>substrait到CH算子的转化</a></li></ul></li></ul></li></ul></nav></div></div><div class=post-content><h1 id=如何打印计划>如何打印计划</h1><h2 id=spark-plan>spark plan</h2><p>首先在本地<a href=https://backendhouse.github.io/post/apache-gluten-+-clickhouse-backend%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/>部署thriftserver</a></p><p>然后建表</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TEMPORARY</span> <span style=color:#ff79c6>VIEW</span> lineitem  
<span style=color:#ff79c6>USING</span> org.apache.spark.<span style=color:#ff79c6>sql</span>.parquet  
<span style=color:#ff79c6>OPTIONS</span> (  
  path <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>/data1/liyang/cppproject/gluten/gluten-core/src/test/resources/tpch-data/lineitem</span><span style=color:#f1fa8c>&#34;</span>  
);  
</code></pre></div><p>拿到TPC-H Q1</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#ff79c6>SELECT</span>  
    l_returnflag,  
    l_linestatus,  
    <span style=color:#ff79c6>sum</span>(l_quantity) <span style=color:#ff79c6>AS</span> sum_qty,  
    <span style=color:#ff79c6>sum</span>(l_extendedprice) <span style=color:#ff79c6>AS</span> sum_base_price,  
    <span style=color:#ff79c6>sum</span>(l_extendedprice <span style=color:#ff79c6>*</span> (<span style=color:#bd93f9>1</span> <span style=color:#ff79c6>-</span> l_discount)) <span style=color:#ff79c6>AS</span> sum_disc_price,  
    <span style=color:#ff79c6>sum</span>(l_extendedprice <span style=color:#ff79c6>*</span> (<span style=color:#bd93f9>1</span> <span style=color:#ff79c6>-</span> l_discount) <span style=color:#ff79c6>*</span> (<span style=color:#bd93f9>1</span> <span style=color:#ff79c6>+</span> l_tax)) <span style=color:#ff79c6>AS</span> sum_charge,  
    <span style=color:#ff79c6>avg</span>(l_quantity) <span style=color:#ff79c6>AS</span> avg_qty,  
    <span style=color:#ff79c6>avg</span>(l_extendedprice) <span style=color:#ff79c6>AS</span> avg_price,  
    <span style=color:#ff79c6>avg</span>(l_discount) <span style=color:#ff79c6>AS</span> avg_disc,  
    <span style=color:#ff79c6>count</span>(<span style=color:#ff79c6>*</span>) <span style=color:#ff79c6>AS</span> count_order  
<span style=color:#ff79c6>FROM</span>  
    lineitem  
<span style=color:#ff79c6>WHERE</span>  
    l_shipdate <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>date</span><span style=color:#f1fa8c>&#39;</span><span style=color:#f1fa8c>1998-09-02</span><span style=color:#f1fa8c>&#39;</span> <span style=color:#ff79c6>-</span> <span style=color:#8be9fd;font-style:italic>interval</span> <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>day</span>  
<span style=color:#ff79c6>GROUP</span> <span style=color:#ff79c6>BY</span>  
    l_returnflag,  
    l_linestatus  
<span style=color:#ff79c6>ORDER</span> <span style=color:#ff79c6>BY</span>  
    l_returnflag,  
    l_linestatus;  
</code></pre></div><p>执行explain formatted + query，就能看到对应的spark optimized physical plan</p><pre><code>+----------------------------------------------------+  
|                        plan                        |  
+----------------------------------------------------+  
| == Physical Plan ==  
CHNativeColumnarToRow (12)  
+- * SortExecTransformer (10)  
   +- ColumnarExchangeAdaptor (9)  
      +- * CHHashAggregateExecTransformer (7)  
         +- ColumnarExchangeAdaptor (6)  
            +- * CHHashAggregateExecTransformer (4)  
               +- * ProjectExecTransformer (3)  
                  +- * FilterExecTransformer (2)  
                     +- * Scan parquet  (1)  
   
   
(1) Scan parquet  
Output [7]: [l_quantity#364, l_extendedprice#365, l_discount#366, l_tax#367, l_returnflag#368, l_linestatus#369, l_shipdate#370]  
Batched: true  
Location: InMemoryFileIndex [file:/data1/liyang/cppproject/gluten/gluten-core/src/test/resources/tpch-data/lineitem]  
PushedFilters: [IsNotNull(l_shipdate), LessThanOrEqual(l_shipdate,1998-09-01)]  
ReadSchema: struct&lt;l_quantity:double,l_extendedprice:double,l_discount:double,l_tax:double,l_returnflag:string,l_linestatus:string,l_shipdate:date&gt;  
   
(2) FilterExecTransformer  
Input [7]: [l_quantity#364, l_extendedprice#365, l_discount#366, l_tax#367, l_returnflag#368, l_linestatus#369, l_shipdate#370]  
Arguments: (isnotnull(l_shipdate#370) AND (l_shipdate#370 &lt;= 1998-09-01))  
   
(3) ProjectExecTransformer  
Input [7]: [l_quantity#364, l_extendedprice#365, l_discount#366, l_tax#367, l_returnflag#368, l_linestatus#369, l_shipdate#370]  
Arguments: [l_quantity#364, l_extendedprice#365, l_discount#366, l_tax#367, l_returnflag#368, l_linestatus#369]  
   
(4) CHHashAggregateExecTransformer  
Input [6]: [l_quantity#364, l_extendedprice#365, l_discount#366, l_tax#367, l_returnflag#368, l_linestatus#369]  
Keys [2]: [l_returnflag#368, l_linestatus#369]  
Functions [8]: [partial_sum(l_quantity#364), partial_sum(l_extendedprice#365), partial_sum((l_extendedprice#365 * (1.0 - l_discount#366))), partial_sum(((l_extendedprice#365 * (1.0 - l_discount#366)) * (1.0 + l_tax#367))), partial_avg(l_quantity#364), partial_avg(l_extendedprice#365), partial_avg(l_discount#366), partial_count(1)]  
Aggregate Attributes [11]: [sum#414, sum#415, sum#416, sum#417, sum#418, count#419L, sum#420, count#421L, sum#422, count#423L, count#424L]  
Results [13]: [l_returnflag#368, l_linestatus#369, sum#425, sum#426, sum#427, sum#428, sum#429, count#430L, sum#431, count#432L, sum#433, count#434L, count#435L]  
   
(5) WholeStageCodegenTransformer (13)  
Input [13]: [l_returnflag#368, l_linestatus#369, sum#425, sum#426, sum#427, sum#428, sum#429, count#430L, sum#431, count#432L, sum#433, count#434L, count#435L]  
   
(6) ColumnarExchangeAdaptor  
Input [13]: [l_returnflag#368, l_linestatus#369, sum#425, sum#426, sum#427, sum#428, sum#429, count#430L, sum#431, count#432L, sum#433, count#434L, count#435L]  
Arguments: hashpartitioning(l_returnflag#368, l_linestatus#369, 5), ENSURE_REQUIREMENTS, false, [plan_id=891], [id=#891]  
   
(7) CHHashAggregateExecTransformer  
Input [13]: [l_returnflag#368, l_linestatus#369, sum#425, sum#426, sum#427, sum#428, sum#429, count#430L, sum#431, count#432L, sum#433, count#434L, count#435L]  
Keys [2]: [l_returnflag#368, l_linestatus#369]  
Functions [8]: [sum(l_quantity#364), sum(l_extendedprice#365), sum((l_extendedprice#365 * (1.0 - l_discount#366))), sum(((l_extendedprice#365 * (1.0 - l_discount#366)) * (1.0 + l_tax#367))), avg(l_quantity#364), avg(l_extendedprice#365), avg(l_discount#366), count(1)]  
Aggregate Attributes [8]: [sum(l_quantity#364)#407, sum(l_extendedprice#365)#408, sum((l_extendedprice#365 * (1.0 - l_discount#366)))#412, sum(((l_extendedprice#365 * (1.0 - l_discount#366)) * (1.0 + l_tax#367)))#413, avg(l_quantity#364)#409, avg(l_extendedprice#365)#410, avg(l_discount#366)#411, count(1)#406L]  
Results [10]: [l_returnflag#368, l_linestatus#369, sum(l_quantity#364)#407 AS sum_qty#393, sum(l_extendedprice#365)#408 AS sum_base_price#394, sum((l_extendedprice#365 * (1.0 - l_discount#366)))#412 AS sum_disc_price#395, sum(((l_extendedprice#365 * (1.0 - l_discount#366)) * (1.0 + l_tax#367)))#413 AS sum_charge#396, avg(l_quantity#364)#409 AS avg_qty#397, avg(l_extendedprice#365)#410 AS avg_price#398, avg(l_discount#366)#411 AS avg_disc#399, count(1)#406L AS count_order#400L]  
   
(8) WholeStageCodegenTransformer (14)  
Input [10]: [l_returnflag#368, l_linestatus#369, sum_qty#393, sum_base_price#394, sum_disc_price#395, sum_charge#396, avg_qty#397, avg_price#398, avg_disc#399, count_order#400L]  
   
(9) ColumnarExchangeAdaptor  
Input [10]: [l_returnflag#368, l_linestatus#369, sum_qty#393, sum_base_price#394, sum_disc_price#395, sum_charge#396, avg_qty#397, avg_price#398, avg_disc#399, count_order#400L]  
Arguments: rangepartitioning(l_returnflag#368 ASC NULLS FIRST, l_linestatus#369 ASC NULLS FIRST, 5), ENSURE_REQUIREMENTS, false, [plan_id=895], [id=#895]  
   
(10) SortExecTransformer  
Input [10]: [l_returnflag#368, l_linestatus#369, sum_qty#393, sum_base_price#394, sum_disc_price#395, sum_charge#396, avg_qty#397, avg_price#398, avg_disc#399, count_order#400L]  
Arguments: [l_returnflag#368 ASC NULLS FIRST, l_linestatus#369 ASC NULLS FIRST], true, 0  
   
(11) WholeStageCodegenTransformer (15)  
Input [10]: [l_returnflag#368, l_linestatus#369, sum_qty#393, sum_base_price#394, sum_disc_price#395, sum_charge#396, avg_qty#397, avg_price#398, avg_disc#399, count_order#400L]  
   
(12) CHNativeColumnarToRow  
Input [10]: [l_returnflag#368, l_linestatus#369, sum_qty#393, sum_base_price#394, sum_disc_price#395, sum_charge#396, avg_qty#397, avg_price#398, avg_disc#399, count_order#400L]  
</code></pre><h2 id=substrait-plan>substrait plan</h2><p>spark log中substrait plan默认使用 pb.DebugString() 输出，不便于阅读。<br>在调试代码时，为了更清楚的打印substrait plan，首先在utils/local-engine/Common/common.cpp中，将默认log level从"error"改成"trace&rdquo;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#ff79c6>auto</span> level <span style=color:#ff79c6>=</span> config<span style=color:#ff79c6>-</span><span style=color:#ff79c6>&gt;</span>getString(<span style=color:#f1fa8c></span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>logger.level</span><span style=color:#f1fa8c>&#34;</span>, <span style=color:#f1fa8c></span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>trace</span><span style=color:#f1fa8c>&#34;</span>);  
</code></pre></div><p>重新编译后执行TCP-H Q1, 可在spark log中发现三种不同的substrait plan，对应三个阶段</p><p>第一阶段: 对应聚合的Partial阶段</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{<span style=color:#ff79c6>&#34;extensions&#34;</span>:[{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionAnchor&#34;</span>:<span style=color:#bd93f9>7</span>,<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;avg:req_fp64&#34;</span>}},{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;is_not_null:opt_bool_date&#34;</span>}},{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionAnchor&#34;</span>:<span style=color:#bd93f9>1</span>,<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;lte:opt_date_date&#34;</span>}},{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionAnchor&#34;</span>:<span style=color:#bd93f9>2</span>,<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;and:opt_bool_bool&#34;</span>}},{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionAnchor&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;subtract:opt_fp64_fp64&#34;</span>}},{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionAnchor&#34;</span>:<span style=color:#bd93f9>6</span>,<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;sum:req_fp64&#34;</span>}},{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionAnchor&#34;</span>:<span style=color:#bd93f9>5</span>,<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;add:opt_fp64_fp64&#34;</span>}},{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionAnchor&#34;</span>:<span style=color:#bd93f9>8</span>,<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;count:req_i32&#34;</span>}},{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionAnchor&#34;</span>:<span style=color:#bd93f9>4</span>,<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;multiply:opt_fp64_fp64&#34;</span>}}],<span style=color:#ff79c6>&#34;relations&#34;</span>:[{<span style=color:#ff79c6>&#34;root&#34;</span>:{<span style=color:#ff79c6>&#34;input&#34;</span>:{<span style=color:#ff79c6>&#34;aggregate&#34;</span>:{<span style=color:#ff79c6>&#34;common&#34;</span>:{<span style=color:#ff79c6>&#34;direct&#34;</span>:{}},<span style=color:#ff79c6>&#34;input&#34;</span>:{<span style=color:#ff79c6>&#34;project&#34;</span>:{<span style=color:#ff79c6>&#34;common&#34;</span>:{<span style=color:#ff79c6>&#34;direct&#34;</span>:{}},<span style=color:#ff79c6>&#34;input&#34;</span>:{<span style=color:#ff79c6>&#34;project&#34;</span>:{<span style=color:#ff79c6>&#34;common&#34;</span>:{<span style=color:#ff79c6>&#34;direct&#34;</span>:{}},<span style=color:#ff79c6>&#34;input&#34;</span>:{<span style=color:#ff79c6>&#34;filter&#34;</span>:{<span style=color:#ff79c6>&#34;common&#34;</span>:{<span style=color:#ff79c6>&#34;direct&#34;</span>:{}},<span style=color:#ff79c6>&#34;input&#34;</span>:{<span style=color:#ff79c6>&#34;read&#34;</span>:{<span style=color:#ff79c6>&#34;common&#34;</span>:{<span style=color:#ff79c6>&#34;direct&#34;</span>:{}},<span style=color:#ff79c6>&#34;baseSchema&#34;</span>:{<span style=color:#ff79c6>&#34;names&#34;</span>:[<span style=color:#f1fa8c>&#34;l_quantity&#34;</span>,<span style=color:#f1fa8c>&#34;l_extendedprice&#34;</span>,<span style=color:#f1fa8c>&#34;l_discount&#34;</span>,<span style=color:#f1fa8c>&#34;l_tax&#34;</span>,<span style=color:#f1fa8c>&#34;l_returnflag&#34;</span>,<span style=color:#f1fa8c>&#34;l_linestatus&#34;</span>,<span style=color:#f1fa8c>&#34;l_shipdate&#34;</span>],<span style=color:#ff79c6>&#34;struct&#34;</span>:{<span style=color:#ff79c6>&#34;types&#34;</span>:[{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;string&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;string&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;date&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}}]},<span style=color:#ff79c6>&#34;partitionColumns&#34;</span>:{<span style=color:#ff79c6>&#34;columnType&#34;</span>:[<span style=color:#f1fa8c>&#34;NORMAL_COL&#34;</span>,<span style=color:#f1fa8c>&#34;NORMAL_COL&#34;</span>,<span style=color:#f1fa8c>&#34;NORMAL_COL&#34;</span>,<span style=color:#f1fa8c>&#34;NORMAL_COL&#34;</span>,<span style=color:#f1fa8c>&#34;NORMAL_COL&#34;</span>,<span style=color:#f1fa8c>&#34;NORMAL_COL&#34;</span>,<span style=color:#f1fa8c>&#34;NORMAL_COL&#34;</span>]}},<span style=color:#ff79c6>&#34;filter&#34;</span>:{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>2</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;bool&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;bool&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_REQUIRED&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>6</span>}}}}}]}}},{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>1</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;bool&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>6</span>}}}}},{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;literal&#34;</span>:{<span style=color:#ff79c6>&#34;date&#34;</span>:<span style=color:#bd93f9>10470</span>}}}]}}}]}},<span style=color:#ff79c6>&#34;localFiles&#34;</span>:{<span style=color:#ff79c6>&#34;items&#34;</span>:[{<span style=color:#ff79c6>&#34;uriFile&#34;</span>:<span style=color:#f1fa8c>&#34;file:///data1/liyang/cppproject/gluten/gluten-core/src/test/resources/tpch-data/lineitem/part-00000-d08071cb-0dfa-42dc-9198-83cb334ccda3-c000.snappy.parquet&#34;</span>,<span style=color:#ff79c6>&#34;length&#34;</span>:<span style=color:#f1fa8c>&#34;17777735&#34;</span>,<span style=color:#ff79c6>&#34;parquet&#34;</span>:{}}]}}},<span style=color:#ff79c6>&#34;condition&#34;</span>:{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>2</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;bool&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;bool&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_REQUIRED&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>6</span>}}}}}]}}},{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>1</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;bool&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>6</span>}}}}},{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;literal&#34;</span>:{<span style=color:#ff79c6>&#34;date&#34;</span>:<span style=color:#bd93f9>10470</span>}}}]}}}]}}}},<span style=color:#ff79c6>&#34;expressions&#34;</span>:[{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{}}}},{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>1</span>}}}},{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>2</span>}}}},{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>3</span>}}}},{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>4</span>}}}},{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>5</span>}}}}]}},<span style=color:#ff79c6>&#34;expressions&#34;</span>:[{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>4</span>}}}},{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>5</span>}}}},{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{}}}},{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>1</span>}}}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>4</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>1</span>}}}}},{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;literal&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:<span style=color:#bd93f9>1</span>}}},{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>2</span>}}}}}]}}}]}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>4</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>4</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>1</span>}}}}},{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;literal&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:<span style=color:#bd93f9>1</span>}}},{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>2</span>}}}}}]}}}]}}},{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>5</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;literal&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:<span style=color:#bd93f9>1</span>}}},{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>3</span>}}}}}]}}}]}},{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>2</span>}}}},{<span style=color:#ff79c6>&#34;literal&#34;</span>:{<span style=color:#ff79c6>&#34;i32&#34;</span>:<span style=color:#bd93f9>1</span>}}]}},<span style=color:#ff79c6>&#34;groupings&#34;</span>:[{<span style=color:#ff79c6>&#34;groupingExpressions&#34;</span>:[{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{}}}},{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>1</span>}}}}]}],<span style=color:#ff79c6>&#34;measures&#34;</span>:[{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>6</span>,<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INITIAL_TO_INTERMEDIATE&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>2</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>6</span>,<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INITIAL_TO_INTERMEDIATE&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>3</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>6</span>,<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INITIAL_TO_INTERMEDIATE&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>4</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>6</span>,<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INITIAL_TO_INTERMEDIATE&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>5</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>7</span>,<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INITIAL_TO_INTERMEDIATE&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>2</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>7</span>,<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INITIAL_TO_INTERMEDIATE&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>3</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>7</span>,<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INITIAL_TO_INTERMEDIATE&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>6</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>8</span>,<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INITIAL_TO_INTERMEDIATE&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;i64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_REQUIRED&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>7</span>}}}}}]}}]}},<span style=color:#ff79c6>&#34;names&#34;</span>:[<span style=color:#f1fa8c>&#34;l_returnflag#8&#34;</span>,<span style=color:#f1fa8c>&#34;l_linestatus#9&#34;</span>,<span style=color:#f1fa8c>&#34;sum#42&#34;</span>,<span style=color:#f1fa8c>&#34;sum#43&#34;</span>,<span style=color:#f1fa8c>&#34;sum#47&#34;</span>,<span style=color:#f1fa8c>&#34;sum#48&#34;</span>,<span style=color:#f1fa8c>&#34;avg#44&#34;</span>,<span style=color:#f1fa8c>&#34;avg#45&#34;</span>,<span style=color:#f1fa8c>&#34;avg#46&#34;</span>,<span style=color:#f1fa8c>&#34;count#41&#34;</span>]}}]}  
</code></pre></div><p>第二阶段：对应聚合的Final阶段</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{<span style=color:#ff79c6>&#34;extensions&#34;</span>:[{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionAnchor&#34;</span>:<span style=color:#bd93f9>1</span>,<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;avg:req_fp64&#34;</span>}},{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionAnchor&#34;</span>:<span style=color:#bd93f9>4</span>,<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;alias:req_i64&#34;</span>}},{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;sum:req_fp64&#34;</span>}},{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionAnchor&#34;</span>:<span style=color:#bd93f9>2</span>,<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;count:req_i32&#34;</span>}},{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionAnchor&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;alias:req_fp64&#34;</span>}}],<span style=color:#ff79c6>&#34;relations&#34;</span>:[{<span style=color:#ff79c6>&#34;root&#34;</span>:{<span style=color:#ff79c6>&#34;input&#34;</span>:{<span style=color:#ff79c6>&#34;project&#34;</span>:{<span style=color:#ff79c6>&#34;common&#34;</span>:{<span style=color:#ff79c6>&#34;direct&#34;</span>:{}},<span style=color:#ff79c6>&#34;input&#34;</span>:{<span style=color:#ff79c6>&#34;aggregate&#34;</span>:{<span style=color:#ff79c6>&#34;common&#34;</span>:{<span style=color:#ff79c6>&#34;direct&#34;</span>:{}},<span style=color:#ff79c6>&#34;input&#34;</span>:{<span style=color:#ff79c6>&#34;read&#34;</span>:{<span style=color:#ff79c6>&#34;common&#34;</span>:{<span style=color:#ff79c6>&#34;direct&#34;</span>:{}},<span style=color:#ff79c6>&#34;baseSchema&#34;</span>:{<span style=color:#ff79c6>&#34;names&#34;</span>:[<span style=color:#f1fa8c>&#34;l_returnflag#8&#34;</span>,<span style=color:#f1fa8c>&#34;l_linestatus#9&#34;</span>,<span style=color:#f1fa8c>&#34;sum#42#Partial#sum&#34;</span>,<span style=color:#f1fa8c>&#34;sum#43#Partial#sum&#34;</span>,<span style=color:#f1fa8c>&#34;sum#47#Partial#sum&#34;</span>,<span style=color:#f1fa8c>&#34;sum#48#Partial#sum&#34;</span>,<span style=color:#f1fa8c>&#34;avg#44#Partial#avg&#34;</span>,<span style=color:#f1fa8c>&#34;avg#45#Partial#avg&#34;</span>,<span style=color:#f1fa8c>&#34;avg#46#Partial#avg&#34;</span>,<span style=color:#f1fa8c>&#34;count#41#Partial#count&#34;</span>],<span style=color:#ff79c6>&#34;struct&#34;</span>:{<span style=color:#ff79c6>&#34;types&#34;</span>:[{<span style=color:#ff79c6>&#34;string&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;string&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;i64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_REQUIRED&#34;</span>}}]}},<span style=color:#ff79c6>&#34;localFiles&#34;</span>:{<span style=color:#ff79c6>&#34;items&#34;</span>:[{<span style=color:#ff79c6>&#34;uriFile&#34;</span>:<span style=color:#f1fa8c>&#34;iterator:0&#34;</span>}]}}},<span style=color:#ff79c6>&#34;groupings&#34;</span>:[{<span style=color:#ff79c6>&#34;groupingExpressions&#34;</span>:[{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{}}}},{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>1</span>}}}}]}],<span style=color:#ff79c6>&#34;measures&#34;</span>:[{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INTERMEDIATE_TO_RESULT&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>2</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INTERMEDIATE_TO_RESULT&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>3</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INTERMEDIATE_TO_RESULT&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>4</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INTERMEDIATE_TO_RESULT&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>5</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>1</span>,<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INTERMEDIATE_TO_RESULT&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>6</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>1</span>,<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INTERMEDIATE_TO_RESULT&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>7</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>1</span>,<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INTERMEDIATE_TO_RESULT&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>8</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>2</span>,<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INTERMEDIATE_TO_RESULT&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;i64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_REQUIRED&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>9</span>}}}}}]}}]}},<span style=color:#ff79c6>&#34;expressions&#34;</span>:[{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{}}}},{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>1</span>}}}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>2</span>}}}}}]}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>3</span>}}}}}]}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>4</span>}}}}}]}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>5</span>}}}}}]}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>6</span>}}}}}]}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>7</span>}}}}}]}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>8</span>}}}}}]}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>4</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;i64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_REQUIRED&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>9</span>}}}}}]}}]}},<span style=color:#ff79c6>&#34;names&#34;</span>:[<span style=color:#f1fa8c>&#34;l_returnflag#8&#34;</span>,<span style=color:#f1fa8c>&#34;l_linestatus#9&#34;</span>,<span style=color:#f1fa8c>&#34;sum_qty#33&#34;</span>,<span style=color:#f1fa8c>&#34;sum_base_price#34&#34;</span>,<span style=color:#f1fa8c>&#34;sum_disc_price#35&#34;</span>,<span style=color:#f1fa8c>&#34;sum_charge#36&#34;</span>,<span style=color:#f1fa8c>&#34;avg_qty#37&#34;</span>,<span style=color:#f1fa8c>&#34;avg_price#38&#34;</span>,<span style=color:#f1fa8c>&#34;avg_disc#39&#34;</span>,<span style=color:#f1fa8c>&#34;count_order#40&#34;</span>]}}]}  
</code></pre></div><p>第三阶段：基于聚合结果进行排序</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{<span style=color:#ff79c6>&#34;extensions&#34;</span>:[{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionAnchor&#34;</span>:<span style=color:#bd93f9>1</span>,<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;avg:req_fp64&#34;</span>}},{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionAnchor&#34;</span>:<span style=color:#bd93f9>4</span>,<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;alias:req_i64&#34;</span>}},{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;sum:req_fp64&#34;</span>}},{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionAnchor&#34;</span>:<span style=color:#bd93f9>2</span>,<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;count:req_i32&#34;</span>}},{<span style=color:#ff79c6>&#34;extensionFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionAnchor&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;alias:req_fp64&#34;</span>}}],<span style=color:#ff79c6>&#34;relations&#34;</span>:[{<span style=color:#ff79c6>&#34;root&#34;</span>:{<span style=color:#ff79c6>&#34;input&#34;</span>:{<span style=color:#ff79c6>&#34;project&#34;</span>:{<span style=color:#ff79c6>&#34;common&#34;</span>:{<span style=color:#ff79c6>&#34;direct&#34;</span>:{}},<span style=color:#ff79c6>&#34;input&#34;</span>:{<span style=color:#ff79c6>&#34;aggregate&#34;</span>:{<span style=color:#ff79c6>&#34;common&#34;</span>:{<span style=color:#ff79c6>&#34;direct&#34;</span>:{}},<span style=color:#ff79c6>&#34;input&#34;</span>:{<span style=color:#ff79c6>&#34;read&#34;</span>:{<span style=color:#ff79c6>&#34;common&#34;</span>:{<span style=color:#ff79c6>&#34;direct&#34;</span>:{}},<span style=color:#ff79c6>&#34;baseSchema&#34;</span>:{<span style=color:#ff79c6>&#34;names&#34;</span>:[<span style=color:#f1fa8c>&#34;l_returnflag#8&#34;</span>,<span style=color:#f1fa8c>&#34;l_linestatus#9&#34;</span>,<span style=color:#f1fa8c>&#34;sum#42#Partial#sum&#34;</span>,<span style=color:#f1fa8c>&#34;sum#43#Partial#sum&#34;</span>,<span style=color:#f1fa8c>&#34;sum#47#Partial#sum&#34;</span>,<span style=color:#f1fa8c>&#34;sum#48#Partial#sum&#34;</span>,<span style=color:#f1fa8c>&#34;avg#44#Partial#avg&#34;</span>,<span style=color:#f1fa8c>&#34;avg#45#Partial#avg&#34;</span>,<span style=color:#f1fa8c>&#34;avg#46#Partial#avg&#34;</span>,<span style=color:#f1fa8c>&#34;count#41#Partial#count&#34;</span>],<span style=color:#ff79c6>&#34;struct&#34;</span>:{<span style=color:#ff79c6>&#34;types&#34;</span>:[{<span style=color:#ff79c6>&#34;string&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;string&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},{<span style=color:#ff79c6>&#34;i64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_REQUIRED&#34;</span>}}]}},<span style=color:#ff79c6>&#34;localFiles&#34;</span>:{<span style=color:#ff79c6>&#34;items&#34;</span>:[{<span style=color:#ff79c6>&#34;uriFile&#34;</span>:<span style=color:#f1fa8c>&#34;iterator:0&#34;</span>}]}}},<span style=color:#ff79c6>&#34;groupings&#34;</span>:[{<span style=color:#ff79c6>&#34;groupingExpressions&#34;</span>:[{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{}}}},{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>1</span>}}}}]}],<span style=color:#ff79c6>&#34;measures&#34;</span>:[{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INTERMEDIATE_TO_RESULT&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>2</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INTERMEDIATE_TO_RESULT&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>3</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INTERMEDIATE_TO_RESULT&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>4</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INTERMEDIATE_TO_RESULT&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>5</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>1</span>,<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INTERMEDIATE_TO_RESULT&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>6</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>1</span>,<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INTERMEDIATE_TO_RESULT&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>7</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>1</span>,<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INTERMEDIATE_TO_RESULT&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>8</span>}}}}}]}},{<span style=color:#ff79c6>&#34;measure&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>2</span>,<span style=color:#ff79c6>&#34;phase&#34;</span>:<span style=color:#f1fa8c>&#34;AGGREGATION_PHASE_INTERMEDIATE_TO_RESULT&#34;</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;i64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_REQUIRED&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>9</span>}}}}}]}}]}},<span style=color:#ff79c6>&#34;expressions&#34;</span>:[{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{}}}},{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>1</span>}}}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>2</span>}}}}}]}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>3</span>}}}}}]}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>4</span>}}}}}]}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>5</span>}}}}}]}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>6</span>}}}}}]}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>7</span>}}}}}]}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>3</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;fp64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_NULLABLE&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>8</span>}}}}}]}},{<span style=color:#ff79c6>&#34;scalarFunction&#34;</span>:{<span style=color:#ff79c6>&#34;functionReference&#34;</span>:<span style=color:#bd93f9>4</span>,<span style=color:#ff79c6>&#34;outputType&#34;</span>:{<span style=color:#ff79c6>&#34;i64&#34;</span>:{<span style=color:#ff79c6>&#34;nullability&#34;</span>:<span style=color:#f1fa8c>&#34;NULLABILITY_REQUIRED&#34;</span>}},<span style=color:#ff79c6>&#34;arguments&#34;</span>:[{<span style=color:#ff79c6>&#34;value&#34;</span>:{<span style=color:#ff79c6>&#34;selection&#34;</span>:{<span style=color:#ff79c6>&#34;directReference&#34;</span>:{<span style=color:#ff79c6>&#34;structField&#34;</span>:{<span style=color:#ff79c6>&#34;field&#34;</span>:<span style=color:#bd93f9>9</span>}}}}}]}}]}},<span style=color:#ff79c6>&#34;names&#34;</span>:[<span style=color:#f1fa8c>&#34;l_returnflag#8&#34;</span>,<span style=color:#f1fa8c>&#34;l_linestatus#9&#34;</span>,<span style=color:#f1fa8c>&#34;sum_qty#33&#34;</span>,<span style=color:#f1fa8c>&#34;sum_base_price#34&#34;</span>,<span style=color:#f1fa8c>&#34;sum_disc_price#35&#34;</span>,<span style=color:#f1fa8c>&#34;sum_charge#36&#34;</span>,<span style=color:#f1fa8c>&#34;avg_qty#37&#34;</span>,<span style=color:#f1fa8c>&#34;avg_price#38&#34;</span>,<span style=color:#f1fa8c>&#34;avg_disc#39&#34;</span>,<span style=color:#f1fa8c>&#34;count_order#40&#34;</span>]}}]}  
</code></pre></div><h2 id=clickhouse-plan>clickhouse plan</h2><p>同样的，在开启log level = &lsquo;trace'后，在spark log中也能发现clickhouse在不同阶段的plan</p><p>第一阶段</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Expression <span style=color:#ff79c6>(</span>Rename Output<span style=color:#ff79c6>)</span>  
Header: l_returnflag#8 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
        l_linestatus#9 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
        sum#42 AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
        sum#43 AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
        sum#47 AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
        sum#48 AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
        avg#44 AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
        avg#45 AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
        avg#46 AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
        count#41 AggregateFunction<span style=color:#ff79c6>(</span>count, Int32<span style=color:#ff79c6>)</span>  
Actions: INPUT : <span style=color:#bd93f9>0</span> -&gt; l_returnflag Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>0</span>  
         INPUT : <span style=color:#bd93f9>1</span> -&gt; l_linestatus Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>1</span>  
         INPUT : <span style=color:#bd93f9>2</span> -&gt; sum<span style=color:#ff79c6>(</span>l_quantity<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>2</span>  
         INPUT : <span style=color:#bd93f9>3</span> -&gt; sum<span style=color:#ff79c6>(</span>l_extendedprice<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>3</span>  
         INPUT : <span style=color:#bd93f9>4</span> -&gt; sum<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_1,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>4</span>  
         INPUT : <span style=color:#bd93f9>5</span> -&gt; sum<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>,plus<span style=color:#ff79c6>(</span>1_3,l_tax<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>5</span>  
         INPUT : <span style=color:#bd93f9>6</span> -&gt; avg<span style=color:#ff79c6>(</span>l_quantity<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>6</span>  
         INPUT : <span style=color:#bd93f9>7</span> -&gt; avg<span style=color:#ff79c6>(</span>l_extendedprice<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>7</span>  
         INPUT : <span style=color:#bd93f9>8</span> -&gt; avg<span style=color:#ff79c6>(</span>l_discount<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>8</span>  
         INPUT : <span style=color:#bd93f9>9</span> -&gt; count<span style=color:#ff79c6>(</span>1_4<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>count, Int32<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>9</span>  
         ALIAS l_returnflag :: <span style=color:#bd93f9>0</span> -&gt; l_returnflag#8 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>10</span>  
         ALIAS l_linestatus :: <span style=color:#bd93f9>1</span> -&gt; l_linestatus#9 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>0</span>  
         ALIAS sum<span style=color:#ff79c6>(</span>l_quantity<span style=color:#ff79c6>)</span> :: <span style=color:#bd93f9>2</span> -&gt; sum#42 AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>1</span>  
         ALIAS sum<span style=color:#ff79c6>(</span>l_extendedprice<span style=color:#ff79c6>)</span> :: <span style=color:#bd93f9>3</span> -&gt; sum#43 AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>2</span>  
         ALIAS sum<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_1,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> :: <span style=color:#bd93f9>4</span> -&gt; sum#47 AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>3</span>  
         ALIAS sum<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>,plus<span style=color:#ff79c6>(</span>1_3,l_tax<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> :: <span style=color:#bd93f9>5</span> -&gt; sum#48 AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>4</span>  
         ALIAS avg<span style=color:#ff79c6>(</span>l_quantity<span style=color:#ff79c6>)</span> :: <span style=color:#bd93f9>6</span> -&gt; avg#44 AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>5</span>  
         ALIAS avg<span style=color:#ff79c6>(</span>l_extendedprice<span style=color:#ff79c6>)</span> :: <span style=color:#bd93f9>7</span> -&gt; avg#45 AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>6</span>  
         ALIAS avg<span style=color:#ff79c6>(</span>l_discount<span style=color:#ff79c6>)</span> :: <span style=color:#bd93f9>8</span> -&gt; avg#46 AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>7</span>  
         ALIAS count<span style=color:#ff79c6>(</span>1_4<span style=color:#ff79c6>)</span> :: <span style=color:#bd93f9>9</span> -&gt; count#41 AggregateFunction<span style=color:#ff79c6>(</span>count, Int32<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>8</span>  
Positions: <span style=color:#bd93f9>10</span> <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>1</span> <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>3</span> <span style=color:#bd93f9>4</span> <span style=color:#bd93f9>5</span> <span style=color:#bd93f9>6</span> <span style=color:#bd93f9>7</span> <span style=color:#bd93f9>8</span>  
  Aggregating  
  Header: l_returnflag Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
          l_linestatus Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
          sum<span style=color:#ff79c6>(</span>l_quantity<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
          sum<span style=color:#ff79c6>(</span>l_extendedprice<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
          sum<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_1,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
          sum<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>,plus<span style=color:#ff79c6>(</span>1_3,l_tax<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
          avg<span style=color:#ff79c6>(</span>l_quantity<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
          avg<span style=color:#ff79c6>(</span>l_extendedprice<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
          avg<span style=color:#ff79c6>(</span>l_discount<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
          count<span style=color:#ff79c6>(</span>1_4<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>count, Int32<span style=color:#ff79c6>)</span>  
  Keys: l_returnflag, l_linestatus  
  Aggregating  
  Header: l_returnflag Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
          l_linestatus Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
          sum<span style=color:#ff79c6>(</span>l_quantity<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
          sum<span style=color:#ff79c6>(</span>l_extendedprice<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
          sum<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_1,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
          sum<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>,plus<span style=color:#ff79c6>(</span>1_3,l_tax<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
          avg<span style=color:#ff79c6>(</span>l_quantity<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
          avg<span style=color:#ff79c6>(</span>l_extendedprice<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
          avg<span style=color:#ff79c6>(</span>l_discount<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
          count<span style=color:#ff79c6>(</span>1_4<span style=color:#ff79c6>)</span> AggregateFunction<span style=color:#ff79c6>(</span>count, Int32<span style=color:#ff79c6>)</span>  
  Keys: l_returnflag, l_linestatus  
  Aggregates:  
      sum<span style=color:#ff79c6>(</span>l_quantity<span style=color:#ff79c6>)</span>  
        Function: sum<span style=color:#ff79c6>(</span>Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> → Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        Arguments: l_quantity  
      sum<span style=color:#ff79c6>(</span>l_extendedprice<span style=color:#ff79c6>)</span>  
        Function: sum<span style=color:#ff79c6>(</span>Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> → Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        Arguments: l_extendedprice  
      sum<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_1,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
        Function: sum<span style=color:#ff79c6>(</span>Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> → Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        Arguments: multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_1,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
      sum<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>,plus<span style=color:#ff79c6>(</span>1_3,l_tax<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
        Function: sum<span style=color:#ff79c6>(</span>Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> → Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        Arguments: multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>,plus<span style=color:#ff79c6>(</span>1_3,l_tax<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
      avg<span style=color:#ff79c6>(</span>l_quantity<span style=color:#ff79c6>)</span>  
        Function: avg<span style=color:#ff79c6>(</span>Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> → Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        Arguments: l_quantity  
      avg<span style=color:#ff79c6>(</span>l_extendedprice<span style=color:#ff79c6>)</span>  
        Function: avg<span style=color:#ff79c6>(</span>Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> → Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        Arguments: l_extendedprice  
      avg<span style=color:#ff79c6>(</span>l_discount<span style=color:#ff79c6>)</span>  
        Function: avg<span style=color:#ff79c6>(</span>Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> → Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        Arguments: l_discount  
      count<span style=color:#ff79c6>(</span>1_4<span style=color:#ff79c6>)</span>  
        Function: count<span style=color:#ff79c6>(</span>Int32<span style=color:#ff79c6>)</span> → UInt64  
        Arguments: 1_4  
    Expression <span style=color:#ff79c6>(</span>Project<span style=color:#ff79c6>)</span>  
    Header: l_returnflag Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
            l_linestatus Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
            l_quantity Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            l_extendedprice Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_1,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>,plus<span style=color:#ff79c6>(</span>1_3,l_tax<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            l_discount Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            1_4 Int32  
    Actions: INPUT :: <span style=color:#bd93f9>0</span> -&gt; l_quantity Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>0</span>  
             INPUT : <span style=color:#bd93f9>1</span> -&gt; l_extendedprice Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>1</span>  
             INPUT : <span style=color:#bd93f9>2</span> -&gt; l_discount Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>2</span>  
             INPUT : <span style=color:#bd93f9>3</span> -&gt; l_tax Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>3</span>  
             INPUT :: <span style=color:#bd93f9>4</span> -&gt; l_returnflag Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>4</span>  
             INPUT :: <span style=color:#bd93f9>5</span> -&gt; l_linestatus Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>5</span>  
             COLUMN Const<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> -&gt; 1_1 Float64 : <span style=color:#bd93f9>6</span>  
             COLUMN Const<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> -&gt; 1_2 Float64 : <span style=color:#bd93f9>7</span>  
             COLUMN Const<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> -&gt; 1_3 Float64 : <span style=color:#bd93f9>8</span>  
             COLUMN Const<span style=color:#ff79c6>(</span>Int32<span style=color:#ff79c6>)</span> -&gt; 1_4 Int32 : <span style=color:#bd93f9>9</span>  
             FUNCTION minus<span style=color:#ff79c6>(</span>1_1 :: 6, l_discount : 2<span style=color:#ff79c6>)</span> -&gt; minus<span style=color:#ff79c6>(</span>1_1,l_discount<span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>10</span>  
             FUNCTION minus<span style=color:#ff79c6>(</span>1_2 :: 7, l_discount : 2<span style=color:#ff79c6>)</span> -&gt; minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>6</span>  
             FUNCTION plus<span style=color:#ff79c6>(</span>1_3 :: 8, l_tax :: 3<span style=color:#ff79c6>)</span> -&gt; plus<span style=color:#ff79c6>(</span>1_3,l_tax<span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>7</span>  
             FUNCTION multiply<span style=color:#ff79c6>(</span>l_extendedprice : 1, minus<span style=color:#ff79c6>(</span>1_1,l_discount<span style=color:#ff79c6>)</span> :: 10<span style=color:#ff79c6>)</span> -&gt; multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_1,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>3</span>  
             FUNCTION multiply<span style=color:#ff79c6>(</span>l_extendedprice : 1, minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span> :: 6<span style=color:#ff79c6>)</span> -&gt; multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>10</span>  
             FUNCTION multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> :: 10, plus<span style=color:#ff79c6>(</span>1_3,l_tax<span style=color:#ff79c6>)</span> :: 7<span style=color:#ff79c6>)</span> -&gt; multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>,plus<span style=color:#ff79c6>(</span>1_3,l_tax<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>6</span>  
    Positions: <span style=color:#bd93f9>4</span> <span style=color:#bd93f9>5</span> <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>1</span> <span style=color:#bd93f9>3</span> <span style=color:#bd93f9>6</span> <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>9</span>  
      Expression <span style=color:#ff79c6>(</span>Project<span style=color:#ff79c6>)</span>  
      Header: l_quantity Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
              l_extendedprice Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
              l_discount Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
              l_tax Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
              l_returnflag Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
              l_linestatus Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
      Actions: INPUT :: <span style=color:#bd93f9>0</span> -&gt; l_quantity Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>0</span>  
               INPUT :: <span style=color:#bd93f9>1</span> -&gt; l_extendedprice Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>1</span>  
               INPUT :: <span style=color:#bd93f9>2</span> -&gt; l_discount Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>2</span>  
               INPUT :: <span style=color:#bd93f9>3</span> -&gt; l_tax Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>3</span>  
               INPUT :: <span style=color:#bd93f9>4</span> -&gt; l_returnflag Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>4</span>  
               INPUT :: <span style=color:#bd93f9>5</span> -&gt; l_linestatus Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>5</span>  
      Positions: <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>1</span> <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>3</span> <span style=color:#bd93f9>4</span> <span style=color:#bd93f9>5</span>  
        Expression <span style=color:#ff79c6>(</span>Remove nullable properties<span style=color:#ff79c6>)</span>  
        Header: l_quantity Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
                l_extendedprice Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
                l_discount Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
                l_tax Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
                l_returnflag Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
                l_linestatus Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
                l_shipdate Date32  
        Actions: INPUT :: <span style=color:#bd93f9>0</span> -&gt; l_quantity Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>0</span>  
                 INPUT :: <span style=color:#bd93f9>1</span> -&gt; l_extendedprice Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>1</span>  
                 INPUT :: <span style=color:#bd93f9>2</span> -&gt; l_discount Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>2</span>  
                 INPUT :: <span style=color:#bd93f9>3</span> -&gt; l_tax Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>3</span>  
                 INPUT :: <span style=color:#bd93f9>4</span> -&gt; l_returnflag Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>4</span>  
                 INPUT :: <span style=color:#bd93f9>5</span> -&gt; l_linestatus Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>5</span>  
                 INPUT : <span style=color:#bd93f9>6</span> -&gt; l_shipdate Nullable<span style=color:#ff79c6>(</span>Date32<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>6</span>  
                 FUNCTION assumeNotNull<span style=color:#ff79c6>(</span>l_shipdate :: 6<span style=color:#ff79c6>)</span> -&gt; l_shipdate Date32 : <span style=color:#bd93f9>7</span>  
        Positions: <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>1</span> <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>3</span> <span style=color:#bd93f9>4</span> <span style=color:#bd93f9>5</span> <span style=color:#bd93f9>7</span>  
          Filter  
          Header: l_quantity Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
                  l_extendedprice Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
                  l_discount Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
                  l_tax Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
                  l_returnflag Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
                  l_linestatus Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
                  l_shipdate Nullable<span style=color:#ff79c6>(</span>Date32<span style=color:#ff79c6>)</span>  
          Filter column: and<span style=color:#ff79c6>(</span>isNotNull<span style=color:#ff79c6>(</span>l_shipdate<span style=color:#ff79c6>)</span>,lessOrEquals<span style=color:#ff79c6>(</span>l_shipdate,10470_0<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>(</span>removed<span style=color:#ff79c6>)</span>  
          Actions: INPUT :: <span style=color:#bd93f9>0</span> -&gt; l_quantity Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>0</span>  
                   INPUT :: <span style=color:#bd93f9>1</span> -&gt; l_extendedprice Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>1</span>  
                   INPUT :: <span style=color:#bd93f9>2</span> -&gt; l_discount Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>2</span>  
                   INPUT :: <span style=color:#bd93f9>3</span> -&gt; l_tax Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>3</span>  
                   INPUT :: <span style=color:#bd93f9>4</span> -&gt; l_returnflag Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>4</span>  
                   INPUT :: <span style=color:#bd93f9>5</span> -&gt; l_linestatus Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>5</span>  
                   INPUT : <span style=color:#bd93f9>6</span> -&gt; l_shipdate Nullable<span style=color:#ff79c6>(</span>Date32<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>6</span>  
                   COLUMN Const<span style=color:#ff79c6>(</span>Int32<span style=color:#ff79c6>)</span> -&gt; 10470_0 Date32 : <span style=color:#bd93f9>7</span>  
                   FUNCTION isNotNull<span style=color:#ff79c6>(</span>l_shipdate : 6<span style=color:#ff79c6>)</span> -&gt; isNotNull<span style=color:#ff79c6>(</span>l_shipdate<span style=color:#ff79c6>)</span> UInt8 : <span style=color:#bd93f9>8</span>  
                   FUNCTION lessOrEquals<span style=color:#ff79c6>(</span>l_shipdate : 6, 10470_0 :: 7<span style=color:#ff79c6>)</span> -&gt; lessOrEquals<span style=color:#ff79c6>(</span>l_shipdate,10470_0<span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>UInt8<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>9</span>  
                   FUNCTION and<span style=color:#ff79c6>(</span>isNotNull<span style=color:#ff79c6>(</span>l_shipdate<span style=color:#ff79c6>)</span> :: 8, lessOrEquals<span style=color:#ff79c6>(</span>l_shipdate,10470_0<span style=color:#ff79c6>)</span> :: 9<span style=color:#ff79c6>)</span> -&gt; and<span style=color:#ff79c6>(</span>isNotNull<span style=color:#ff79c6>(</span>l_shipdate<span style=color:#ff79c6>)</span>,lessOrEquals<span style=color:#ff79c6>(</span>l_shipdate,10470_0<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>UInt8<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>7</span>  
          Positions: <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>1</span> <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>3</span> <span style=color:#bd93f9>4</span> <span style=color:#bd93f9>5</span> <span style=color:#bd93f9>6</span> <span style=color:#bd93f9>7</span>  
            ReadFromStorage <span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>read</span> <span style=color:#8be9fd;font-style:italic>local</span> files<span style=color:#ff79c6>)</span>  
            Header: l_quantity Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
                    l_extendedprice Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
                    l_discount Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
                    l_tax Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
                    l_returnflag Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
                    l_linestatus Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
                    l_shipdate Nullable<span style=color:#ff79c6>(</span>Date32<span style=color:#ff79c6>)</span>  
</code></pre></div><p>对应的pipeline</p><p><img src=https://backendhouse.github.io/images/Gluten%E4%B8%ADSubstrait%E7%AE%97%E5%AD%90%E7%9A%84%E8%BD%AC%E5%8C%96%E5%92%8CCH%E7%AE%97%E5%AD%90%E7%9A%84%E5%AE%9E%E7%8E%B0/image.png alt="alt text"></p><p>第二阶段</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Expression <span style=color:#ff79c6>(</span>Rename Output<span style=color:#ff79c6>)</span>  
Header: l_returnflag#8 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
        l_linestatus#9 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
        sum_qty#33 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        sum_base_price#34 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        sum_disc_price#35 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        sum_charge#36 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        avg_qty#37 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        avg_price#38 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        avg_disc#39 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        count_order#40 Int64  
Actions: INPUT :: <span style=color:#bd93f9>0</span> -&gt; l_returnflag#8 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>0</span>  
         INPUT :: <span style=color:#bd93f9>1</span> -&gt; l_linestatus#9 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>1</span>  
         INPUT : <span style=color:#bd93f9>2</span> -&gt; sum#42#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>2</span>  
         INPUT : <span style=color:#bd93f9>3</span> -&gt; sum#43#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>3</span>  
         INPUT : <span style=color:#bd93f9>4</span> -&gt; sum#47#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>4</span>  
         INPUT : <span style=color:#bd93f9>5</span> -&gt; sum#48#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>5</span>  
         INPUT : <span style=color:#bd93f9>6</span> -&gt; avg#44#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>6</span>  
         INPUT : <span style=color:#bd93f9>7</span> -&gt; avg#45#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>7</span>  
         INPUT : <span style=color:#bd93f9>8</span> -&gt; avg#46#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>8</span>  
         INPUT : <span style=color:#bd93f9>9</span> -&gt; count#41#Partial#count Int64 : <span style=color:#bd93f9>9</span>  
         ALIAS sum#42#Partial#sum :: <span style=color:#bd93f9>2</span> -&gt; sum_qty#33 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>10</span>  
         ALIAS sum#43#Partial#sum :: <span style=color:#bd93f9>3</span> -&gt; sum_base_price#34 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>2</span>  
         ALIAS sum#47#Partial#sum :: <span style=color:#bd93f9>4</span> -&gt; sum_disc_price#35 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>3</span>  
         ALIAS sum#48#Partial#sum :: <span style=color:#bd93f9>5</span> -&gt; sum_charge#36 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>4</span>  
         ALIAS avg#44#Partial#avg :: <span style=color:#bd93f9>6</span> -&gt; avg_qty#37 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>5</span>  
         ALIAS avg#45#Partial#avg :: <span style=color:#bd93f9>7</span> -&gt; avg_price#38 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>6</span>  
         ALIAS avg#46#Partial#avg :: <span style=color:#bd93f9>8</span> -&gt; avg_disc#39 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>7</span>  
         ALIAS count#41#Partial#count :: <span style=color:#bd93f9>9</span> -&gt; count_order#40 Int64 : <span style=color:#bd93f9>8</span>  
Positions: <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>1</span> <span style=color:#bd93f9>10</span> <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>3</span> <span style=color:#bd93f9>4</span> <span style=color:#bd93f9>5</span> <span style=color:#bd93f9>6</span> <span style=color:#bd93f9>7</span> <span style=color:#bd93f9>8</span>  
  Expression <span style=color:#ff79c6>(</span>Project<span style=color:#ff79c6>)</span>  
  Header: l_returnflag#8 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
          l_linestatus#9 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
          sum#42#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
          sum#43#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
          sum#47#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
          sum#48#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
          avg#44#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
          avg#45#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
          avg#46#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
          count#41#Partial#count Int64  
  Actions: INPUT :: <span style=color:#bd93f9>0</span> -&gt; l_returnflag#8 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>0</span>  
           INPUT :: <span style=color:#bd93f9>1</span> -&gt; l_linestatus#9 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>1</span>  
           INPUT :: <span style=color:#bd93f9>2</span> -&gt; sum#42#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>2</span>  
           INPUT :: <span style=color:#bd93f9>3</span> -&gt; sum#43#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>3</span>  
           INPUT :: <span style=color:#bd93f9>4</span> -&gt; sum#47#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>4</span>  
           INPUT :: <span style=color:#bd93f9>5</span> -&gt; sum#48#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>5</span>  
           INPUT :: <span style=color:#bd93f9>6</span> -&gt; avg#44#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>6</span>  
           INPUT :: <span style=color:#bd93f9>7</span> -&gt; avg#45#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>7</span>  
           INPUT :: <span style=color:#bd93f9>8</span> -&gt; avg#46#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>8</span>  
           INPUT :: <span style=color:#bd93f9>9</span> -&gt; count#41#Partial#count Int64 : <span style=color:#bd93f9>9</span>  
  Positions: <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>1</span> <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>3</span> <span style=color:#bd93f9>4</span> <span style=color:#bd93f9>5</span> <span style=color:#bd93f9>6</span> <span style=color:#bd93f9>7</span> <span style=color:#bd93f9>8</span> <span style=color:#bd93f9>9</span>  
    Expression <span style=color:#ff79c6>(</span>Convert Aggregate Output<span style=color:#ff79c6>)</span>  
    Header: l_returnflag#8 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
            l_linestatus#9 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
            sum#42#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            sum#43#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            sum#47#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            sum#48#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            avg#44#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            avg#45#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            avg#46#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            count#41#Partial#count Int64  
    Actions: INPUT :: <span style=color:#bd93f9>0</span> -&gt; l_returnflag#8 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>0</span>  
             INPUT :: <span style=color:#bd93f9>1</span> -&gt; l_linestatus#9 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>1</span>  
             INPUT :: <span style=color:#bd93f9>2</span> -&gt; sum#42#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>2</span>  
             INPUT :: <span style=color:#bd93f9>3</span> -&gt; sum#43#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>3</span>  
             INPUT :: <span style=color:#bd93f9>4</span> -&gt; sum#47#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>4</span>  
             INPUT :: <span style=color:#bd93f9>5</span> -&gt; sum#48#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>5</span>  
             INPUT :: <span style=color:#bd93f9>6</span> -&gt; avg#44#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>6</span>  
             INPUT :: <span style=color:#bd93f9>7</span> -&gt; avg#45#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>7</span>  
             INPUT :: <span style=color:#bd93f9>8</span> -&gt; avg#46#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>8</span>  
             INPUT : <span style=color:#bd93f9>9</span> -&gt; count#41#Partial#count UInt64 : <span style=color:#bd93f9>9</span>  
             COLUMN Const<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> -&gt; Int64 String : <span style=color:#bd93f9>10</span>  
             FUNCTION _CAST<span style=color:#ff79c6>(</span>count#41#Partial#count :: 9, Int64 :: 10<span style=color:#ff79c6>)</span> -&gt; _CAST<span style=color:#ff79c6>(</span>count#41#Partial#count, Int64<span style=color:#ff79c6>)</span> Int64 : <span style=color:#bd93f9>11</span>  
             ALIAS _CAST<span style=color:#ff79c6>(</span>count#41#Partial#count, Int64<span style=color:#ff79c6>)</span> :: <span style=color:#bd93f9>11</span> -&gt; count#41#Partial#count Int64 : <span style=color:#bd93f9>10</span>  
    Positions: <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>1</span> <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>3</span> <span style=color:#bd93f9>4</span> <span style=color:#bd93f9>5</span> <span style=color:#bd93f9>6</span> <span style=color:#bd93f9>7</span> <span style=color:#bd93f9>8</span> <span style=color:#bd93f9>10</span>  
      MergingAggregated  
      Header: l_returnflag#8 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
              l_linestatus#9 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
              sum#42#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
              sum#43#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
              sum#47#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
              sum#48#Partial#sum Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
              avg#44#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
              avg#45#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
              avg#46#Partial#avg Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
              count#41#Partial#count UInt64  
      Keys: l_returnflag#8, l_linestatus#9  
      Aggregates:  
          sum#42#Partial#sum  
            Function: sumPartialMerge<span style=color:#ff79c6>(</span>AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> → Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            Arguments: sum#42#Partial#sum  
          sum#43#Partial#sum  
            Function: sumPartialMerge<span style=color:#ff79c6>(</span>AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> → Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            Arguments: sum#43#Partial#sum  
          sum#47#Partial#sum  
            Function: sumPartialMerge<span style=color:#ff79c6>(</span>AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> → Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            Arguments: sum#47#Partial#sum  
          sum#48#Partial#sum  
            Function: sumPartialMerge<span style=color:#ff79c6>(</span>AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> → Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            Arguments: sum#48#Partial#sum  
          avg#44#Partial#avg  
            Function: avgPartialMerge<span style=color:#ff79c6>(</span>AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> → Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            Arguments: avg#44#Partial#avg  
          avg#45#Partial#avg  
            Function: avgPartialMerge<span style=color:#ff79c6>(</span>AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> → Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            Arguments: avg#45#Partial#avg  
          avg#46#Partial#avg  
            Function: avgPartialMerge<span style=color:#ff79c6>(</span>AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> → Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            Arguments: avg#46#Partial#avg  
          count#41#Partial#count  
            Function: countPartialMerge<span style=color:#ff79c6>(</span>AggregateFunction<span style=color:#ff79c6>(</span>count, Int64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> → UInt64  
            Arguments: count#41#Partial#count  
        ReadFromPreparedSource <span style=color:#ff79c6>(</span>Read From Java Iter<span style=color:#ff79c6>)</span>  
        Header: l_returnflag#8 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
                l_linestatus#9 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
                sum#42#Partial#sum AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
                sum#43#Partial#sum AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
                sum#47#Partial#sum AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
                sum#48#Partial#sum AggregateFunction<span style=color:#ff79c6>(</span>sum, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
                avg#44#Partial#avg AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
                avg#45#Partial#avg AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
                avg#46#Partial#avg AggregateFunction<span style=color:#ff79c6>(</span>avg, Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
                count#41#Partial#count AggregateFunction<span style=color:#ff79c6>(</span>count, Int64<span style=color:#ff79c6>)</span>  
</code></pre></div><p>对应的pipeline</p><p><img src=https://backendhouse.github.io/images/Gluten%E4%B8%ADSubstrait%E7%AE%97%E5%AD%90%E7%9A%84%E8%BD%AC%E5%8C%96%E5%92%8CCH%E7%AE%97%E5%AD%90%E7%9A%84%E5%AE%9E%E7%8E%B0/image-1.png alt="alt text"></p><p>第三阶段</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Expression <span style=color:#ff79c6>(</span>Rename Output<span style=color:#ff79c6>)</span>  
Header: l_returnflag#8 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
        l_linestatus#9 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
        sum_qty#33 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        sum_base_price#34 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        sum_disc_price#35 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        sum_charge#36 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        avg_qty#37 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        avg_price#38 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        avg_disc#39 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        count_order#40 Int64  
Actions: INPUT :: <span style=color:#bd93f9>0</span> -&gt; l_returnflag#8 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>0</span>  
         INPUT :: <span style=color:#bd93f9>1</span> -&gt; l_linestatus#9 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>1</span>  
         INPUT :: <span style=color:#bd93f9>2</span> -&gt; sum_qty#33 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>2</span>  
         INPUT :: <span style=color:#bd93f9>3</span> -&gt; sum_base_price#34 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>3</span>  
         INPUT :: <span style=color:#bd93f9>4</span> -&gt; sum_disc_price#35 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>4</span>  
         INPUT :: <span style=color:#bd93f9>5</span> -&gt; sum_charge#36 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>5</span>  
         INPUT :: <span style=color:#bd93f9>6</span> -&gt; avg_qty#37 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>6</span>  
         INPUT :: <span style=color:#bd93f9>7</span> -&gt; avg_price#38 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>7</span>  
         INPUT :: <span style=color:#bd93f9>8</span> -&gt; avg_disc#39 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>8</span>  
         INPUT :: <span style=color:#bd93f9>9</span> -&gt; count_order#40 Int64 : <span style=color:#bd93f9>9</span>  
Positions: <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>1</span> <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>3</span> <span style=color:#bd93f9>4</span> <span style=color:#bd93f9>5</span> <span style=color:#bd93f9>6</span> <span style=color:#bd93f9>7</span> <span style=color:#bd93f9>8</span> <span style=color:#bd93f9>9</span>  
  Sorting <span style=color:#ff79c6>(</span>Sorting step<span style=color:#ff79c6>)</span>  
  Header: l_returnflag#8 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
          l_linestatus#9 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
          sum_qty#33 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
          sum_base_price#34 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
          sum_disc_price#35 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
          sum_charge#36 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
          avg_qty#37 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
          avg_price#38 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
          avg_disc#39 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
          count_order#40 Int64  
  Sort description: l_returnflag#8 ASC, l_linestatus#9 ASC  
    ReadFromPreparedSource <span style=color:#ff79c6>(</span>Read From Java Iter<span style=color:#ff79c6>)</span>  
    Header: l_returnflag#8 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
            l_linestatus#9 Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
            sum_qty#33 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            sum_base_price#34 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            sum_disc_price#35 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            sum_charge#36 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            avg_qty#37 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            avg_price#38 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            avg_disc#39 Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            count_order#40 Int64  
</code></pre></div><p>对应的Pipeline</p><p><img src=https://backendhouse.github.io/images/Gluten%E4%B8%ADSubstrait%E7%AE%97%E5%AD%90%E7%9A%84%E8%BD%AC%E5%8C%96%E5%92%8CCH%E7%AE%97%E5%AD%90%E7%9A%84%E5%AE%9E%E7%8E%B0/image-2.png alt="alt text"></p><h2 id=其他>其他</h2><p>如何在clickhouse-client中打印AST，Plan，Pipeline呢？<br>到测试环境找到一条query:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#ff79c6>SELECT</span>  
    (intDiv(toUInt32(rtime), <span style=color:#bd93f9>10</span>) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>10</span>) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>1000</span> <span style=color:#ff79c6>AS</span> t,  
    <span style=color:#ff79c6>count</span>()  
<span style=color:#ff79c6>FROM</span> <span style=color:#ff79c6>default</span>.test_ranger_0  
<span style=color:#ff79c6>WHERE</span> ((<span style=color:#ff79c6>day</span> <span style=color:#ff79c6>&gt;</span><span style=color:#ff79c6>=</span> toDate(<span style=color:#bd93f9>1678356215</span>)) <span style=color:#ff79c6>AND</span> (<span style=color:#ff79c6>day</span> <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>=</span> toDate(<span style=color:#bd93f9>1678356515</span>))) <span style=color:#ff79c6>AND</span> ((rtime <span style=color:#ff79c6>&gt;</span><span style=color:#ff79c6>=</span> toDateTime(<span style=color:#bd93f9>1678356215</span>)) <span style=color:#ff79c6>AND</span> (rtime <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>=</span> toDateTime(<span style=color:#bd93f9>1678356515</span>)))  
<span style=color:#ff79c6>GROUP</span> <span style=color:#ff79c6>BY</span> t  
<span style=color:#ff79c6>ORDER</span> <span style=color:#ff79c6>BY</span> t <span style=color:#ff79c6>ASC</span>  
</code></pre></div><p><strong>打印AST</strong>: explain ast <query>，这一步会打印出query对应的语法树。但是输出结果不太便于阅读。我们可以添加选项explain ast graph = 1 <query>，该命令会输出dot代码，dot代码可通过<a href=https://dreampuf.github.io/GraphvizOnline>在线工具</a>转化为矢量图。</p><p><img src=https://backendhouse.github.io/images/Gluten%E4%B8%ADSubstrait%E7%AE%97%E5%AD%90%E7%9A%84%E8%BD%AC%E5%8C%96%E5%92%8CCH%E7%AE%97%E5%AD%90%E7%9A%84%E5%AE%9E%E7%8E%B0/image-3.png alt="alt text"></p><p><strong>规整化query</strong>: explain syntax <query>, 该命令会格式化query, 并且显示经过AST优化之后的query</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#ff79c6>EXPLAIN</span> SYNTAX  
<span style=color:#ff79c6>SELECT</span> sumIf(<span style=color:#bd93f9>1</span>, (<span style=color:#8be9fd;font-style:italic>number</span> <span style=color:#ff79c6>%</span> <span style=color:#bd93f9>2</span>) <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>2</span>)  
<span style=color:#ff79c6>FROM</span> numbers(<span style=color:#bd93f9>100</span>)  
   
Query id: <span style=color:#bd93f9>3</span>fb3b332<span style=color:#ff79c6>-</span>a988<span style=color:#ff79c6>-</span><span style=color:#bd93f9>43</span>c5<span style=color:#ff79c6>-</span><span style=color:#bd93f9>9677</span><span style=color:#ff79c6>-</span><span style=color:#bd93f9>9</span>fff8c44ff3d  
   
┌─<span style=color:#ff79c6>explain</span>──────────────────────────┐  
│ <span style=color:#ff79c6>SELECT</span> countIf((<span style=color:#8be9fd;font-style:italic>number</span> <span style=color:#ff79c6>%</span> <span style=color:#bd93f9>2</span>) <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>2</span>) │  
│ <span style=color:#ff79c6>FROM</span> numbers(<span style=color:#bd93f9>100</span>)                │  
└──────────────────────────────────┘  
</code></pre></div><p><strong>打印Plan</strong>: explain plan header = 1, actions = 1 <query></p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>EXPLAIN <span style=color:#8be9fd;font-style:italic>header</span> <span style=color:#ff79c6>=</span> 1, <span style=color:#8be9fd;font-style:italic>actions</span> <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>  
SELECT  
    <span style=color:#ff79c6>(</span>intDiv<span style=color:#ff79c6>(</span>toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span> * 10<span style=color:#ff79c6>)</span> * <span style=color:#bd93f9>1000</span> AS t,  
    count<span style=color:#ff79c6>(</span><span style=color:#ff79c6>)</span>  
FROM default.test_ranger_0  
WHERE <span style=color:#ff79c6>(</span><span style=color:#ff79c6>(</span>day &gt;<span style=color:#ff79c6>=</span> toDate<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> AND <span style=color:#ff79c6>(</span>day &lt;<span style=color:#ff79c6>=</span> toDate<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> AND <span style=color:#ff79c6>(</span><span style=color:#ff79c6>(</span>rtime &gt;<span style=color:#ff79c6>=</span> toDateTime<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> AND <span style=color:#ff79c6>(</span>rtime &lt;<span style=color:#ff79c6>=</span> toDateTime<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>  
GROUP BY t  
ORDER BY t ASC  
   
Query id: f395457f-a684-4fc3-b6c9-6e9eb7ece5fe  
   
┌─explain────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐  
│ Expression <span style=color:#ff79c6>(</span>Projection<span style=color:#ff79c6>)</span>                                                                                                                                                                                                                                    │  
│ Header: t UInt64                                                                                                                                                                                                                                           │  
│         count<span style=color:#ff79c6>(</span><span style=color:#ff79c6>)</span> UInt64                                                                                                                                                                                                                                     │  
│ Actions: INPUT : <span style=color:#bd93f9>0</span> -&gt; multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>intDiv<span style=color:#ff79c6>(</span>toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 1000<span style=color:#ff79c6>)</span> UInt64 : <span style=color:#bd93f9>0</span>                                                                                                                                                                 │  
│          INPUT :: <span style=color:#bd93f9>1</span> -&gt; count<span style=color:#ff79c6>(</span><span style=color:#ff79c6>)</span> UInt64 : <span style=color:#bd93f9>1</span>                                                                                                                                                                                                                  │  
│          ALIAS multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>intDiv<span style=color:#ff79c6>(</span>toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 1000<span style=color:#ff79c6>)</span> :: <span style=color:#bd93f9>0</span> -&gt; t UInt64 : <span style=color:#bd93f9>2</span>                                                                                                                                                              │  
│ Positions: <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>1</span>                                                                                                                                                                                                                                             │  
│   Sorting <span style=color:#ff79c6>(</span>Sorting <span style=color:#ff79c6>for</span> ORDER BY<span style=color:#ff79c6>)</span>                                                                                                                                                                                                                           │  
│   Header: multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>intDiv<span style=color:#ff79c6>(</span>toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 1000<span style=color:#ff79c6>)</span> UInt64                                                                                                                                                                                 │  
│           count<span style=color:#ff79c6>(</span><span style=color:#ff79c6>)</span> UInt64                                                                                                                                                                                                                                   │  
│   Sort description: multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>intDiv<span style=color:#ff79c6>(</span>toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 1000<span style=color:#ff79c6>)</span> ASC                                                                                                                                                                          │  
│     Expression <span style=color:#ff79c6>(</span>Before ORDER BY<span style=color:#ff79c6>)</span>                                                                                                                                                                                                                           │  
│     Header: multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>intDiv<span style=color:#ff79c6>(</span>toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 1000<span style=color:#ff79c6>)</span> UInt64                                                                                                                                                                               │  
│             count<span style=color:#ff79c6>(</span><span style=color:#ff79c6>)</span> UInt64                                                                                                                                                                                                                                 │  
│     Actions: INPUT :: <span style=color:#bd93f9>0</span> -&gt; multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>intDiv<span style=color:#ff79c6>(</span>toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 1000<span style=color:#ff79c6>)</span> UInt64 : <span style=color:#bd93f9>0</span>                                                                                                                                                            │  
│              INPUT :: <span style=color:#bd93f9>1</span> -&gt; count<span style=color:#ff79c6>(</span><span style=color:#ff79c6>)</span> UInt64 : <span style=color:#bd93f9>1</span>                                                                                                                                                                                                              │  
│     Positions: <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>1</span>                                                                                                                                                                                                                                         │  
│       Aggregating                                                                                                                                                                                                                                          │  
│       Header: multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>intDiv<span style=color:#ff79c6>(</span>toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 1000<span style=color:#ff79c6>)</span> UInt64                                                                                                                                                                             │  
│               count<span style=color:#ff79c6>(</span><span style=color:#ff79c6>)</span> UInt64                                                                                                                                                                                                                               │  
│       Keys: multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>intDiv<span style=color:#ff79c6>(</span>toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 1000<span style=color:#ff79c6>)</span>                                                                                                                                                                                      │  
│       Aggregates:                                                                                                                                                                                                                                          │  
│           count<span style=color:#ff79c6>(</span><span style=color:#ff79c6>)</span>                                                                                                                                                                                                                                          │  
│             Function: count<span style=color:#ff79c6>(</span><span style=color:#ff79c6>)</span> → UInt64                                                                                                                                                                                                                     │  
│             Arguments: none                                                                                                                                                                                                                                │  
│       Skip merging: <span style=color:#bd93f9>0</span>                                                                                                                                                                                                                                      │  
│         Expression <span style=color:#ff79c6>(</span>Before GROUP BY<span style=color:#ff79c6>)</span>                                                                                                                                                                                                                       │  
│         Header: multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>intDiv<span style=color:#ff79c6>(</span>toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 1000<span style=color:#ff79c6>)</span> UInt64                                                                                                                                                                           │  
│         Actions: INPUT : <span style=color:#bd93f9>0</span> -&gt; rtime DateTime : <span style=color:#bd93f9>0</span>                                                                                                                                                                                                           │  
│                  COLUMN Const<span style=color:#ff79c6>(</span>UInt8<span style=color:#ff79c6>)</span> -&gt; <span style=color:#bd93f9>10</span> UInt8 : <span style=color:#bd93f9>1</span>                                                                                                                                                                                                       │  
│                  COLUMN Const<span style=color:#ff79c6>(</span>UInt16<span style=color:#ff79c6>)</span> -&gt; <span style=color:#bd93f9>1000</span> UInt16 : <span style=color:#bd93f9>2</span>                                                                                                                                                                                                   │  
│                  FUNCTION toUInt32<span style=color:#ff79c6>(</span>rtime :: 0<span style=color:#ff79c6>)</span> -&gt; toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span> UInt32 : <span style=color:#bd93f9>3</span>                                                                                                                                                                               │  
│                  FUNCTION intDiv<span style=color:#ff79c6>(</span>toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span> :: 3, <span style=color:#bd93f9>10</span> : 1<span style=color:#ff79c6>)</span> -&gt; intDiv<span style=color:#ff79c6>(</span>toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span> UInt32 : <span style=color:#bd93f9>0</span>                                                                                                                                                   │  
│                  FUNCTION multiply<span style=color:#ff79c6>(</span>intDiv<span style=color:#ff79c6>(</span>toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span> :: 0, <span style=color:#bd93f9>10</span> :: 1<span style=color:#ff79c6>)</span> -&gt; multiply<span style=color:#ff79c6>(</span>intDiv<span style=color:#ff79c6>(</span>toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span> UInt64 : <span style=color:#bd93f9>3</span>                                                                                                                      │  
│                  FUNCTION multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>intDiv<span style=color:#ff79c6>(</span>toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span> :: 3, <span style=color:#bd93f9>1000</span> :: 2<span style=color:#ff79c6>)</span> -&gt; multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>intDiv<span style=color:#ff79c6>(</span>toUInt32<span style=color:#ff79c6>(</span>rtime<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 10<span style=color:#ff79c6>)</span>, 1000<span style=color:#ff79c6>)</span> UInt64 : <span style=color:#bd93f9>1</span>                                                                                      │  
│         Positions: <span style=color:#bd93f9>1</span>                                                                                                                                                                                                                                       │  
│           Filter <span style=color:#ff79c6>(</span>WHERE<span style=color:#ff79c6>)</span>                                                                                                                                                                                                                                   │  
│           Header: rtime DateTime                                                                                                                                                                                                                           │  
│           Filter column: and<span style=color:#ff79c6>(</span>and<span style=color:#ff79c6>(</span>greaterOrEquals<span style=color:#ff79c6>(</span>day, toDate<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>, lessOrEquals<span style=color:#ff79c6>(</span>day, toDate<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>, and<span style=color:#ff79c6>(</span>greaterOrEquals<span style=color:#ff79c6>(</span>rtime, toDateTime<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>, lessOrEquals<span style=color:#ff79c6>(</span>rtime, toDateTime<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>(</span>removed<span style=color:#ff79c6>)</span>                             │  
│           Actions: INPUT : <span style=color:#bd93f9>0</span> -&gt; rtime DateTime : <span style=color:#bd93f9>0</span>                                                                                                                                                                                                         │  
│                    INPUT : <span style=color:#bd93f9>1</span> -&gt; day Date : <span style=color:#bd93f9>1</span>                                                                                                                                                                                                               │  
│                    COLUMN Const<span style=color:#ff79c6>(</span>UInt16<span style=color:#ff79c6>)</span> -&gt; toDate<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span> Date : <span style=color:#bd93f9>2</span>                                                                                                                                                                                     │  
│                    COLUMN Const<span style=color:#ff79c6>(</span>UInt16<span style=color:#ff79c6>)</span> -&gt; toDate<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span> Date : <span style=color:#bd93f9>3</span>                                                                                                                                                                                     │  
│                    COLUMN Const<span style=color:#ff79c6>(</span>UInt32<span style=color:#ff79c6>)</span> -&gt; toDateTime<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span> DateTime : <span style=color:#bd93f9>4</span>                                                                                                                                                                             │  
│                    COLUMN Const<span style=color:#ff79c6>(</span>UInt32<span style=color:#ff79c6>)</span> -&gt; toDateTime<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span> DateTime : <span style=color:#bd93f9>5</span>                                                                                                                                                                             │  
│                    FUNCTION greaterOrEquals<span style=color:#ff79c6>(</span>day : 1, toDate<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span> :: 2<span style=color:#ff79c6>)</span> -&gt; greaterOrEquals<span style=color:#ff79c6>(</span>day, toDate<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> UInt8 : <span style=color:#bd93f9>6</span>                                                                                                                        │  
│                    FUNCTION lessOrEquals<span style=color:#ff79c6>(</span>day :: 1, toDate<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span> :: 3<span style=color:#ff79c6>)</span> -&gt; lessOrEquals<span style=color:#ff79c6>(</span>day, toDate<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> UInt8 : <span style=color:#bd93f9>2</span>                                                                                                                             │  
│                    FUNCTION greaterOrEquals<span style=color:#ff79c6>(</span>rtime : 0, toDateTime<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span> :: 4<span style=color:#ff79c6>)</span> -&gt; greaterOrEquals<span style=color:#ff79c6>(</span>rtime, toDateTime<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> UInt8 : <span style=color:#bd93f9>3</span>                                                                                                            │  
│                    FUNCTION lessOrEquals<span style=color:#ff79c6>(</span>rtime : 0, toDateTime<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span> :: 5<span style=color:#ff79c6>)</span> -&gt; lessOrEquals<span style=color:#ff79c6>(</span>rtime, toDateTime<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> UInt8 : <span style=color:#bd93f9>4</span>                                                                                                                  │  
│                    FUNCTION and<span style=color:#ff79c6>(</span>greaterOrEquals<span style=color:#ff79c6>(</span>day, toDate<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> :: 6, lessOrEquals<span style=color:#ff79c6>(</span>day, toDate<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> :: 2<span style=color:#ff79c6>)</span> -&gt; and<span style=color:#ff79c6>(</span>greaterOrEquals<span style=color:#ff79c6>(</span>day, toDate<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>, lessOrEquals<span style=color:#ff79c6>(</span>day, toDate<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> UInt8 : <span style=color:#bd93f9>5</span>                               │  
│                    FUNCTION and<span style=color:#ff79c6>(</span>greaterOrEquals<span style=color:#ff79c6>(</span>rtime, toDateTime<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> :: 3, lessOrEquals<span style=color:#ff79c6>(</span>rtime, toDateTime<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> :: 4<span style=color:#ff79c6>)</span> -&gt; and<span style=color:#ff79c6>(</span>greaterOrEquals<span style=color:#ff79c6>(</span>rtime, toDateTime<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>, lessOrEquals<span style=color:#ff79c6>(</span>rtime, toDateTime<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> UInt8 : <span style=color:#bd93f9>2</span>       │  
│                    FUNCTION and<span style=color:#ff79c6>(</span>and<span style=color:#ff79c6>(</span>greaterOrEquals<span style=color:#ff79c6>(</span>day, toDate<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>, lessOrEquals<span style=color:#ff79c6>(</span>day, toDate<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> :: 5, and<span style=color:#ff79c6>(</span>greaterOrEquals<span style=color:#ff79c6>(</span>rtime, toDateTime<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>, lessOrEquals<span style=color:#ff79c6>(</span>rtime, toDateTime<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> :: 2<span style=color:#ff79c6>)</span> -&gt; and<span style=color:#ff79c6>(</span>and<span style=color:#ff79c6>(</span>greaterOrEquals<span style=color:#ff79c6>(</span>day, toDate<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>, lessOrEquals<span style=color:#ff79c6>(</span>day, toDate<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>, and<span style=color:#ff79c6>(</span>greaterOrEquals<span style=color:#ff79c6>(</span>rtime, toDateTime<span style=color:#ff79c6>(</span>1678356215<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>, lessOrEquals<span style=color:#ff79c6>(</span>rtime, toDateTime<span style=color:#ff79c6>(</span>1678356515<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> UInt8 : <span style=color:#bd93f9>4</span> │  
│           Positions: <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>4</span>                                                                                                                                                                                                                                   │  
│             ReadFromPreparedSource <span style=color:#ff79c6>(</span>Read from NullSource<span style=color:#ff79c6>)</span>                                                                                                                                                                                                  │  
│             Header: rtime DateTime                                                                                                                                                                                                                         │  
│                     day Date     
</code></pre></div><p><strong>打印pipeline</strong>: explain pipeline header = 1, graph = 1 <query>，同explain ast graph = 1类似，也会输出dot代码，可在线转化成图形。<br><img src=https://backendhouse.github.io/images/Gluten%E4%B8%ADSubstrait%E7%AE%97%E5%AD%90%E7%9A%84%E8%BD%AC%E5%8C%96%E5%92%8CCH%E7%AE%97%E5%AD%90%E7%9A%84%E5%AE%9E%E7%8E%B0/image-4.png alt="alt text"></p><h1 id=计划解读>计划解读</h1><h2 id=表达式>表达式</h2><h3 id=ch表达式>CH表达式</h3><p>我们截取TPC-H Q1的CH计划片段</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Expression <span style=color:#ff79c6>(</span>Project<span style=color:#ff79c6>)</span>  
    Header: l_returnflag Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
            l_linestatus Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
            l_quantity Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            l_extendedprice Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_1,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>,plus<span style=color:#ff79c6>(</span>1_3,l_tax<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            l_discount Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
            1_4 Int32  
    Actions: INPUT :: <span style=color:#bd93f9>0</span> -&gt; l_quantity Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>0</span>  
             INPUT : <span style=color:#bd93f9>1</span> -&gt; l_extendedprice Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>1</span>  
             INPUT : <span style=color:#bd93f9>2</span> -&gt; l_discount Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>2</span>  
             INPUT : <span style=color:#bd93f9>3</span> -&gt; l_tax Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>3</span>  
             INPUT :: <span style=color:#bd93f9>4</span> -&gt; l_returnflag Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>4</span>  
             INPUT :: <span style=color:#bd93f9>5</span> -&gt; l_linestatus Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>5</span>  
             COLUMN Const<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> -&gt; 1_1 Float64 : <span style=color:#bd93f9>6</span>  
             COLUMN Const<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> -&gt; 1_2 Float64 : <span style=color:#bd93f9>7</span>  
             COLUMN Const<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> -&gt; 1_3 Float64 : <span style=color:#bd93f9>8</span>  
             COLUMN Const<span style=color:#ff79c6>(</span>Int32<span style=color:#ff79c6>)</span> -&gt; 1_4 Int32 : <span style=color:#bd93f9>9</span>  
             FUNCTION minus<span style=color:#ff79c6>(</span>1_1 :: 6, l_discount : 2<span style=color:#ff79c6>)</span> -&gt; minus<span style=color:#ff79c6>(</span>1_1,l_discount<span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>10</span>  
             FUNCTION minus<span style=color:#ff79c6>(</span>1_2 :: 7, l_discount : 2<span style=color:#ff79c6>)</span> -&gt; minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>6</span>  
             FUNCTION plus<span style=color:#ff79c6>(</span>1_3 :: 8, l_tax :: 3<span style=color:#ff79c6>)</span> -&gt; plus<span style=color:#ff79c6>(</span>1_3,l_tax<span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>7</span>  
             FUNCTION multiply<span style=color:#ff79c6>(</span>l_extendedprice : 1, minus<span style=color:#ff79c6>(</span>1_1,l_discount<span style=color:#ff79c6>)</span> :: 10<span style=color:#ff79c6>)</span> -&gt; multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_1,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>3</span>  
             FUNCTION multiply<span style=color:#ff79c6>(</span>l_extendedprice : 1, minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span> :: 6<span style=color:#ff79c6>)</span> -&gt; multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>10</span>  
             FUNCTION multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> :: 10, plus<span style=color:#ff79c6>(</span>1_3,l_tax<span style=color:#ff79c6>)</span> :: 7<span style=color:#ff79c6>)</span> -&gt; multiply<span style=color:#ff79c6>(</span>multiply<span style=color:#ff79c6>(</span>l_extendedprice,minus<span style=color:#ff79c6>(</span>1_2,l_discount<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span>,plus<span style=color:#ff79c6>(</span>1_3,l_tax<span style=color:#ff79c6>)</span><span style=color:#ff79c6>)</span> Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span> : <span style=color:#bd93f9>6</span>  
    Positions: <span style=color:#bd93f9>4</span> <span style=color:#bd93f9>5</span> <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>1</span> <span style=color:#bd93f9>3</span> <span style=color:#bd93f9>6</span> <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>9</span>  
</code></pre></div><p>表达式计算一般出现在Project算子里</p><ul><li>Header: Project算子的输出schema</li><li>Actions: Project算子的计算内容</li><li>Position: Actions到header的映射关系</li></ul><p>Actions分成三种类型：</p><ul><li>Input: 由前置算子输入的column</li><li>Column: Literal值，const column</li><li>Alias: 为输出增加alias name</li><li>Function: 普通函数计算，</li><li>ArrayJoin: 与普通函数不同，CH中针对array join特殊处理。对应着Spark中的lateral view explode</li></ul><p>相关源码：</p><p><strong>ActionsDAG</strong>: 用于表示某个算子中的一组表达式，这些表达式共同组成了一个DAG.</p><ul><li>addInput: 增加输入column</li><li>addColumn: 增加literal column</li><li>addAlias: 增加alias映射</li><li>addArrayJoin: 增加array join计算</li><li>addFunction: 增加普通函数计算</li><li>addCast: 本质上还是增加普通函数cast, 只是方便调用</li><li>findInOutputs: 从actions的输出中找到指定列</li><li>addOrReplaceInOutputs: 从actions的输出中找到指定列并取而代之。如果不存在则直接添加。</li><li>project：规整化ActionsDAG, 批量添加必要的输出列和ALIAS, 删除无用的action(没有被任何输入所依赖的计算)</li></ul><p><strong>ActionsVisitor</strong>: 用于在ExpressionAnalyzer中，将输入的AST解析成不同阶段的ActionsDAG</p><p><strong>ExpressionActionsChain</strong>: 表示多组ActionsDag, 例如SELECT和WHERE中的expression对应两个独立的ActionsDAG。用于ExpressionAnalyzer中，将解析AST得到的ActionsDAG追加到其中。</p><p><strong>ExpressionActions</strong>: 基于输入的Block执行ActionsDAG。用于Expression算子执行(ExpressionStep/ExpressionTransform)</p><p><strong>ArrayJoinAction</strong>: 基于输入的Block执行Array Join Action，注意与ExpressionActions是并列关系。用于ArrayJoin算子执行(ArrayJoinStep/ArrayJoinTransform)</p><h3 id=substrait表达式>substrait表达式</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>message Expression {  
  oneof rex_type {  
    <span style=color:#6272a4>/// query中的常量，分为不同的类型，除了interval/fixedxxx/userdefined外都已支持  
</span><span style=color:#6272a4></span>    Literal literal <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;  
    <span style=color:#6272a4>/// 对字段的引用，例如select a from table,select a.b from table  
</span><span style=color:#6272a4></span>    FieldReference selection <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;  
    <span style=color:#6272a4>/// 普通函数  
</span><span style=color:#6272a4></span>    ScalarFunction scalar_function <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;  
    <span style=color:#6272a4>/// 窗口函数  
</span><span style=color:#6272a4></span>    WindowFunction window_function <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>5</span>;  
    <span style=color:#6272a4>/// 对应case when或if clause  
</span><span style=color:#6272a4></span>    IfThen if_then <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>6</span>;  
    <span style=color:#6272a4>/// 目前没用到，其实是IfThen的子集  
</span><span style=color:#6272a4></span>    SwitchExpression switch_expression <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>7</span>;  
    <span style=color:#6272a4>/// 用于表示 a in (b, c, d)  
</span><span style=color:#6272a4></span>    SingularOrList singular_or_list <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>8</span>;  
    <span style=color:#6272a4>/// 没用到  
</span><span style=color:#6272a4></span>    MultiOrList multi_or_list <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>9</span>;  
    <span style=color:#6272a4>/// 将input的类型强转成指定类型，failure_behavior表示失败后如何处理  
</span><span style=color:#6272a4></span>    Cast cast <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>11</span>;  
    <span style=color:#6272a4>/// 没用到  
</span><span style=color:#6272a4></span>    Subquery subquery <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>12</span>;  
    <span style=color:#6272a4>/// 没用到  
</span><span style=color:#6272a4></span>    Nested nested <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>13</span>;  
   
   
    <span style=color:#6272a4>// deprecated: enum literals are only sensible in the context of  
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// function arguments, for which FunctionArgument should now be  
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// used  
</span><span style=color:#6272a4></span>    Enum <span style=color:#ff79c6>enum</span> = 10 [<span style=color:#50fa7b>deprecated</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>];  
  }  
  
</code></pre></div><h3 id=substrait到ch表达式的转化>substrait到CH表达式的转化</h3><p>代码入口：expressionsToActionsDAG，将substrait::Expression转化为CH中的ActionsDAG</p><ul><li>如果Expression类型是FieldReference, 根据input schema获取column name, 到ActionsDAG的output column中搜索，加入到required_columns中</li><li>如果Expression类型是ScalarFunction<ul><li>递归解析function arguments(也是substrait::Expression类型)，并将其加入到ActionsDAG中</li><li>根据映射关系(SCALAR_FUNCTIONS)将substrait function name转化为ch function name，生成FunctionOverloadResolverPtr</li><li>执行ActionsDAG::addFunction将该函数加入其中。例外：alias函数用ActionsDAG::addAlias, array join函数用ActionsDAG::addArrayJoin</li></ul></li><li>如果Expression类型是Literal, 将Literal对应的const column通过ActionsDAG::addColumn加入其中</li><li>如果Expression类型是Cast, 处理类似ScalarFunction，对应ch function: toInt/toUInt/toString/toDecimal/toDate32</li><li>如果Expression类型是IfThen, 处理类似ScalaFunction, 对应ch function: multiIf</li><li>其他：略</li></ul><h2 id=算子>算子</h2><h3 id=substrait算子>substrait算子</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#6272a4>// A relation with output field names.  
</span><span style=color:#6272a4></span><span style=color:#6272a4>//  
</span><span style=color:#6272a4></span><span style=color:#6272a4>// This is for use at the root of a `Rel` tree.  
</span><span style=color:#6272a4></span>message RelRoot {  
  <span style=color:#6272a4>// A relation  
</span><span style=color:#6272a4></span>  Rel input <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;  
  <span style=color:#6272a4>// Field names in depth-first order  
</span><span style=color:#6272a4></span>  repeated string names <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;  
}  
   
   
<span style=color:#6272a4>// A relation (used internally in a plan)  
</span><span style=color:#6272a4></span>message Rel {  
  oneof rel_type {  
    <span style=color:#6272a4>/// source算子，ReadFromPreparedSource  
</span><span style=color:#6272a4></span>    ReadRel read <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;  
    <span style=color:#6272a4>/// filter算子，对应CH FilterStep/FilterTransform  
</span><span style=color:#6272a4></span>    FilterRel filter <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;  
    <span style=color:#6272a4>/// Limit算子，对应CH LimitStep/LimitTransform  
</span><span style=color:#6272a4></span>    FetchRel fetch <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;  
    <span style=color:#6272a4>/// aggregate算子，partial阶段对应AggregatingStep/AggregatingTransform, final阶段对应MergingAggregated/MergingAggregatedTransform  
</span><span style=color:#6272a4></span>    AggregateRel aggregate <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4</span>;  
    <span style=color:#6272a4>/// sort算子，对应CH SortingStep/SortingTransform  
</span><span style=color:#6272a4></span>    SortRel sort <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>5</span>;  
    <span style=color:#6272a4>/// join算子，对应CH JoinStep/JoiningTransform  
</span><span style=color:#6272a4></span>    JoinRel join <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>6</span>;  
    <span style=color:#6272a4>/// project算子, 对应CH ExpressionStep/ExpressionTransform  
</span><span style=color:#6272a4></span>    ProjectRel project <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>7</span>;  
    SetRel set <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>8</span>;  
    ExtensionSingleRel extension_single <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>9</span>;  
    ExtensionMultiRel extension_multi <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>10</span>;  
    ExtensionLeafRel extension_leaf <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>11</span>;  
    <span style=color:#6272a4>/// cross join算子，暂时没用  
</span><span style=color:#6272a4></span>    CrossRel cross <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>12</span>;  
    <span style=color:#6272a4>/// grouping sets算子，对应CH ExpandStep/ExpandTransform  
</span><span style=color:#6272a4></span>    ExpandRel expand <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>13</span>;  
    <span style=color:#6272a4>/// window算子，对应CH WindowStep/WindowTransform  
</span><span style=color:#6272a4></span>    WindowRel window <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>14</span>;  
    <span style=color:#6272a4>/// generate算子，对应spark explode lateral view，对应CH ArrayJoinStep/ArrayJoinTransform  
</span><span style=color:#6272a4></span>    GenerateRel generate <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>15</span>;  
  }  
}  
  
</code></pre></div><h3 id=ch算子>CH算子</h3><p>注意这里说的算子是物理算子</p><p>接口：IQueryPlanStep<br>代码：src/Processors/QueryPlan/*Step.h<br>CH中算子按照拓扑结构分成三类</p><ul><li>Source算子：输入为空。读取data source的算子，例如读取MergeTree、Parquet、ORC、Java Iterator</li><li>Transform算子：输入和输出非空。如project, filter, join, aggregate等</li><li>Sink算子：输出为空。将数据写入到MergeTree、Parquet、ORC文件中。</li></ul><p>CH中包含算子的QueryPlan会构建QueryPipeLine，然后由PipelineExecutor执行<br><img src=https://backendhouse.github.io/images/Gluten%E4%B8%ADSubstrait%E7%AE%97%E5%AD%90%E7%9A%84%E8%BD%AC%E5%8C%96%E5%92%8CCH%E7%AE%97%E5%AD%90%E7%9A%84%E5%AE%9E%E7%8E%B0/image-5.png alt="alt text"></p><h4 id=source算子的实现>Source算子的实现</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ReadFromStorage <span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>read</span> <span style=color:#8be9fd;font-style:italic>local</span> files<span style=color:#ff79c6>)</span>  
Header: l_quantity Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        l_extendedprice Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        l_discount Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        l_tax Nullable<span style=color:#ff79c6>(</span>Float64<span style=color:#ff79c6>)</span>  
        l_returnflag Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
        l_linestatus Nullable<span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>  
        l_shipdate Nullable<span style=color:#ff79c6>(</span>Date32<span style=color:#ff79c6>)</span>  
</code></pre></div><p>ReadFromStorageStep算子用于将现成的Pipe加入到QueryPlan中作为Source算子。这个设计的精妙之处在于：</p><ul><li>通过ReadBuffer的抽象，我们可通过ReadFromStorageStep读取CH已支持的各种压缩格式(zstd, lz4, snappy等)、各种文件系统(local, s3, hdfs)</li><li>通过InputFormat的抽象，我们可通过ReadFromStorageStep读取任意CH已支持的Format(CSV, Parquet, Arrow, ORC等)</li></ul><p>用户通过ReadBuffer和InputFormat的排列组合即可生成ReadFromStorageStep，实现各类功能</p><ul><li>首先根据压缩格式、文件系统构造ReadBuffer对象</li><li>其次根据ReadBuffer对象构造InputFormat对象</li><li>InputFormat对象本质上是一个Processor, 通过它可构造Pipe</li><li>通过Pipe构造ReadFromStorageStep，加入到QueryPlan中</li><li>通过QueryPlan构造QueryPipeline, 通过PipelineExecutor执行之</li></ul><p>扩展阅读：</p><ul><li>ReadBufferFromHDFS: 从hdfs filesystem读取数据</li><li>ReadBufferFromFile：从local filesystem读取数据</li><li>ReadBufferFromS3: 从s3 filesystem读取数据</li><li>Lz4InflatingReadBuffer：在上游ReadBuffer上级联Lz4解压</li><li>ZstdInflatingReadBuffer：在上游ReadBuffer上级联zstd解压</li><li>SnappyReadBuffer: 在上游ReadBuffer上级联snappy解压</li><li>CSVRowInputFormat：从ReadBuffer读取csv数据并解析后输出Block</li><li>ParquetBlockInputFormat: 从ReadBuffer读取parquet数据并解析后输出Block</li><li>ORCBlockInputFormat: 从ReadBuffer中读取orc数据并解析后输出Block</li></ul><h4 id=project算子的实现>Project算子的实现</h4><p>流程如下：</p><ul><li>首先构造Pipeline: 调用ExpressionStep::transformPipeline<ul><li>由ActionsDAG构造ExpressionActions，继而构造ExpressionTransform，追加到pipeline中。</li><li>如果发现pipeline的输出header与ExpressionStep的输出header有差异，生成一个新的ActionsDAG实现类型强转，追加到pipeline中</li></ul></li><li>然后执行Pipeline: 调用ExpressionTransform::transform → ExpressionActions::execute<ul><li>根据计算required_columns到input block中字段的映射关系</li><li>遍历actions, 调用executeAction执行。生成新的Block并替换回输入Block<ul><li>如果action是FUNCTION类型，如果is_lazy_executed = true(一般用于and/or/multiIf的短路执行优化)时，result column为ColumnFunction，此时不会执行function；如果is_function_compiled = true(用于JIT等优化场景)，则执行编译好的CompiledFunction。否则执行普通函数</li><li>如果action是ARRAY_JOIN类型，根据array join key column的offset对其他column执行replicate操作，生成result column</li><li>如果action是COLUMN类型，修改const column的num_rows</li><li>如果action是ALIAS类型，将source column复制到result column，并修改result column的name</li><li>如果action是INPUT类型，将inputs中的column move到result position</li></ul></li></ul></li></ul><h4 id=aggregate算子的实现>Aggregate算子的实现</h4><p><strong>第一阶段</strong>： AggregatingStep，完成初步聚合</p><ul><li>首先构造pipeline: 调用AggregatingStep::transformPipeline<ul><li>如果pipeline的输出并行度>1, 构造parallel的AggregatingTransform，加入到pipeline中</li><li>如果pipeline的输出并行度 = 1, 构造串行的AggregatingTransform加入pipeline</li></ul></li><li>然后执行pipeline: 调用AggregatingTransform::work<ul><li>首先从上游算子pull一个chunk</li><li>不断调用Aggregator::executeOnBlock对输入的block进行聚合，创建AggregateFunction columns存储聚合的中间状态并不断更新。Aggregator::executeOnBlock的流程：<ul><li>首先根据aggregate method初始化AggregatedDataVariants中的聚合函数指针</li><li>如果是without_key method, 初始化AggregatedDataVariants中的without_key聚合结构，并执行executeWithoutKeyImpl<ul><li>遍历每一个aggregate function, 执行对应的addBatchSinglePlace方法</li></ul></li><li>如果是其他method, 执行executeImplBatch<ul><li>遍历每一行，判断该行的key是否重复，如果不重复新建method对应的aggregate data, 否则复用已有data. places[row_idx]对应着该行的aggregate data，然后遍历每一个aggregate function, 批量执行add, 将数据聚合到对应的aggregate data中。</li></ul></li></ul></li><li>当上游无输入或达到max_rows_to_group_by上限时，AggregatingTransform::consume结束， is_consume_finished = true</li><li>判断当前AggregatingTransform是否为同一批并行聚合算子中最后一个完成consume的。如果不是则当前算子结束。否则：<ul><li>对所有并行算子产出的ManyAggregatedDataVariants结构进行预处理：去掉空值，按照size大小逆序排列，预分配内存池，都是为了性能，见Aggregator::prepareVariantsToMerge</li><li>在pipeline中后置ConvertingAggregatedToChunksTransform算子，将聚合中间状态进行合并，流程如下：<ul><li>首先初始化：分配arena，针对without key聚合有特殊处理</li><li>开始合并：Aggregator::mergeSingleLevelDataImpl, 对每一项aggregate data, 调用mergeDataImpl将他们合并到一处，再调用convertToBlockImpl将汇总好的aggregate data转化成Block。如果final = true, 则以最终聚合结果输出，否则以中间结果的形式输出</li></ul></li></ul></li></ul></li></ul><p><strong>第二阶段</strong>：MergingAggregatedStep，完成最终聚合</p><ul><li>首先构造MergingAggregatedTransform加入到pipeline中，并行度为1</li><li>然后执行pipeline: 调用MergingAggregatedTransform::work</li><li>consume阶段：不断调用MergingAggregatedTransform::consume消费输入的Block。该阶段会将输入的column追加到内存中。</li><li>generate阶段：调用Aggregator::mergeBlocks将之前输入的blocks进行合并<ul><li>如果是aggregate method = without_key，用mergeBlockWithoutKeyStreamsImpl</li><li>否则用mergeStreamsImpl → mergeStreamsImplCase<ul><li>遍历每一行，判断key是否重复，指定该行的aggregate data</li><li>遍历每个aggregate function, 执行mergeBatch，将输入block中的aggregate data合并到目标aggregate data中。</li></ul></li></ul></li></ul><p><strong>注意</strong>：CH Aggregator中针对不同key的类型进行了深度优化，例如无key, 不同长度的整形key，string类型的key, LowCardinality类型的key, nullable类型的key，用于聚合的算法与数据结构都是不一样的，体现了CH极致的性能优化策略。</p><p>从代码中可以看到，IAggregateFunction有不同的add接口用于处理输入：</p><ul><li>add: 一次处理一行数据，性能不如addBatch</li><li>addBatchSinglePlace: 一次处理一批数据，支持if combinator(可选)，如果当前行的if条件不成立，则该行不参与聚合</li><li>addBatchSinglePlaceNotNull: 一次处理一批数据，支持if/null combinator，前者可选。如果当前行尾null值，则该行不参与聚合</li><li>addManyDefaults: 一次处理一批default value</li><li>addBatchSparse: 一次处理一批ColumnSparse类型的输入，针对ColumnSparse结构做了优化</li><li>merge: 一次merge ColumnAggregateFunction中的一行数据</li><li>mergeBatch: 一次merge ColumnAggregateFunction中的一批数据</li></ul><p>2.2.2.4 Sort算子的实现<br>代码入口：SortingStep<br>流程(以full sort为例)：</p><ul><li>构造pipeline:<ul><li>如果有limit clause, 则将PartialSortingTransform加入pipeline</li><li>追加LimitsCheckingTransform(为了检查是否超出local rows/bytes限制)</li><li>追加MergeSortingTransform</li><li>如果pipeline并发度>1, 追加MergingSortedTransform</li></ul></li><li>执行pipeline:<ul><li>PartialSortingTransform: 不断地对input Block进行topn排序，然后输出。这一步是粗排。这里有个性能优化：维护一组topn相关的阈值，高于该阈值的行全部过滤掉，低于该阈值的行才执行下一步的sortBlock。随着迭代不断调整该阈值。</li><li>MergeSortingTransform: 将上游PartialSortingTransform输出的多个局部有序chunk进行归并排序，输出全局排序数据<ul><li>consume阶段：小优化(去掉输入Block中的const column)，加入到chunks队列。随着chunks中数据积累到一定阈值，执行remerge(MergeSorter)。</li><li>generate阶段：首先创建MergeSorter, 从中读取chunk, 然后之前去掉的const column加入到Chunk中来。</li></ul></li><li>MergingSortedTransform: 将上游多路MergeSortingTransform的有序输入进行归并排序。具体算法参考MergingSortedAlgorithm</li></ul></li></ul><h3 id=substrait到ch算子的转化>substrait到CH算子的转化</h3><h4 id=substrait-read算子的转化>substrait read算子的转化</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#6272a4>// The scan operator of base data (physical or virtual), including filtering and projection.  
</span><span style=color:#6272a4></span>message ReadRel {  
  RelCommon common <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;  
  <span style=color:#6272a4>/// 读取数据源的schema, 包括column name和type  
</span><span style=color:#6272a4></span>  NamedStruct base_schema <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;  
  Expression filter <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;  
  Expression best_effort_filter <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>11</span>;  
  Expression.MaskExpression projection <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4</span>;  
  substrait.extensions.AdvancedExtension advanced_extension <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>10</span>;  
   
  <span style=color:#6272a4>// Definition of which type of scan operation is to be performed  
</span><span style=color:#6272a4></span>  oneof read_type {  
    VirtualTable virtual_table <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>5</span>;  
    <span style=color:#6272a4>/// gluten实际运行中，local_files分为两种来源，一种来自iterator, 一种来自本地或远程的Parquet/ORC文件  
</span><span style=color:#6272a4></span>    LocalFiles local_files <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>6</span>;  
    NamedTable named_table <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>7</span>;  
    ExtensionTable extension_table <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>8</span>;  
  }  
   
   
  <span style=color:#6272a4>// Represents a list of files in input of a scan operation  
</span><span style=color:#6272a4></span>  message LocalFiles {  
    <span style=color:#6272a4>/// 一个或多个本地或远程文件。  
</span><span style=color:#6272a4></span>    repeated FileOrFiles items <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;  
    substrait.extensions.AdvancedExtension advanced_extension <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>10</span>;  
   
   
    <span style=color:#6272a4>// Many files consist of indivisible chunks (e.g. parquet row groups  
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// or CSV rows).  If a slice partially selects an indivisible chunk  
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// then the consumer should employ some rule to decide which slice to  
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// include the chunk in (e.g. include it in the slice that contains  
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// the midpoint of the chunk)  
</span><span style=color:#6272a4></span>    message FileOrFiles {  
      oneof path_type {  
        <span style=color:#6272a4>// A URI that can refer to either a single folder or a single file  
</span><span style=color:#6272a4></span>        string uri_path <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;  
        <span style=color:#6272a4>// A URI where the path portion is a glob expression that can  
</span><span style=color:#6272a4></span>        <span style=color:#6272a4>// identify zero or more paths.  
</span><span style=color:#6272a4></span>        <span style=color:#6272a4>// Consumers should support the POSIX syntax.  The recursive  
</span><span style=color:#6272a4></span>        <span style=color:#6272a4>// globstar (**) may not be supported.  
</span><span style=color:#6272a4></span>        string uri_path_glob <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;  
        <span style=color:#6272a4>// A URI that refers to a single file  
</span><span style=color:#6272a4></span>        string uri_file <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;  
        <span style=color:#6272a4>// A URI that refers to a single folder  
</span><span style=color:#6272a4></span>        string uri_folder <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4</span>;  
      }  
</code></pre></div><p>代码入口：SerializedPlanParser.h parseOP函数</p><ul><li>如果local file来自于java iterator, 则将先用SourceFromJavaIter组装Pipe, 再用Pipe生成ReadFromPreparedSource算子，再把算子加入到QueryPlan中。</li><li>如果local file来自于本地或远程的Parquet/ORC文件，先用SubstraitFileSource组装Pipe, 再生成ReadFromStorageStep算子，加入到QueryPlan中</li></ul><p><strong>SourceFromJavaIter</strong>: CH算子，通过jni从gluten中的io/glutenproject/execution/ColumnarNativeIterator中批量读取Block。实现见SourceFromJavaIter::generate</p><p><strong>SubstraitFileSource</strong>: CH算子, 支持从不同数据源local/s3/hdfs读取不同格式Parquet/ORC格式的数据。相关类：</p><ul><li>NormalFileReader: 从单个文件个读取文件，返回Chunk</li><li>FormatFile: 对不同格式的文件的抽象, 目前已经实现了Text, ORC, Parquet三种格式</li></ul><h4 id=substrait-project算子的转化>substrait project算子的转化</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#6272a4>// This operator allows to represent calculated expressions of fields (e.g., a+b). Direct/Emit are used to represent classical relational projections  
</span><span style=color:#6272a4></span>message ProjectRel {  
  RelCommon common <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;  
  <span style=color:#6272a4>/// 输入算子  
</span><span style=color:#6272a4></span>  Rel input <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;  
  <span style=color:#6272a4>/// project算子中包含的多组表达式  
</span><span style=color:#6272a4></span>  repeated Expression expressions <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;  
  substrait.extensions.AdvancedExtension advanced_extension <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>10</span>;  
}  
</code></pre></div><p>转化流程相对简单：</p><ul><li>执行expressionsToActionsDAG，将多组substrait::Expression转化为ActionsDAG</li><li>用ActionsDAG构造ExpressionStep，加入到QueryPlan中</li></ul><h4 id=substrait-aggregate算子的转化>substrait aggregate算子的转化</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#6272a4>// The relational operator representing a GROUP BY Aggregate  
</span><span style=color:#6272a4></span>message AggregateRel {  
  RelCommon common <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;  
   
  <span style=color:#6272a4>// Input of the aggregation  
</span><span style=color:#6272a4></span>  Rel input <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;  
   
  <span style=color:#6272a4>/// group by expressions，对应维度，可能有多个，可能是表达式  
</span><span style=color:#6272a4></span>  repeated Grouping groupings <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;  
   
  <span style=color:#6272a4>/// aggregate expressions, 对应指标，可能有多个  
</span><span style=color:#6272a4></span>  repeated Measure measures <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4</span>;  
   
  substrait.extensions.AdvancedExtension advanced_extension <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>10</span>;  
   
  message Grouping {  
    repeated Expression grouping_expressions <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;  
  }  
   
  message Measure {  
    AggregateFunction measure <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;  
   
    <span style=color:#6272a4>// An optional boolean expression that acts to filter which records are  
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// included in the measure. True means include this record for calculation  
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// within the measure.  
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// Helps to support SUM(&lt;c&gt;) FILTER(WHERE...) syntax without masking opportunities for optimization  
</span><span style=color:#6272a4></span>    Expression filter <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;  
  }  
}  
</code></pre></div><p>转化流程：</p><ul><li>执行SerializedPlanParser::parseAggregate，将substrait aggregate算子转化为QueryPlanStep<ul><li>判断是否需要在CH计划中前置一个ExpressionStep, 满足以下两个条件之一即成立。如果是，则在CH聚合算子之前加入ExpressionStep<ul><li>aggregate function的参数为Literal</li><li>aggregate function的参数为非nullable, 但aggregate function的output type为nullable, 且当前聚合算子处于Partial阶段。</li></ul></li><li>将多组measures转化为AggregateDescriptions</li><li>判断当前aggregate算子是否为final阶段<ul><li>如果是，则在QueryPlan加入MergingAggregatedStep算子</li><li>否则加入AggregatingStep算子</li></ul></li></ul></li></ul><h4 id=substrait-sort算子的转化>substrait sort算子的转化</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#6272a4>// The ORDERY BY (or sorting) relational operator. Beside describing a base relation, it includes a list of fields to sort on  
</span><span style=color:#6272a4></span>message SortRel {  
  RelCommon common <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;  
  Rel input <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;  
  <span style=color:#6272a4>/// 多组sort expressions: order by expr1, expr2, expr3  
</span><span style=color:#6272a4></span>  repeated SortField sorts <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;  
  substrait.extensions.AdvancedExtension advanced_extension <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>10</span>;  
}  
   
<span style=color:#6272a4>// The description of a field to sort on (including the direction of sorting and null semantics)  
</span><span style=color:#6272a4></span>message SortField {  
  Expression expr <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;  
     
  oneof sort_kind {  
    <span style=color:#6272a4>/// sort排序方向，这里分的比较细  
</span><span style=color:#6272a4></span>    SortDirection direction <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;  
    uint32 comparison_function_reference <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;  
  }  
     
  <span style=color:#ff79c6>enum</span> <span style=color:#50fa7b>SortDirection</span> {  
    SORT_DIRECTION_UNSPECIFIED <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;  
    SORT_DIRECTION_ASC_NULLS_FIRST <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;  
    SORT_DIRECTION_ASC_NULLS_LAST <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;  
    SORT_DIRECTION_DESC_NULLS_FIRST <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;  
    SORT_DIRECTION_DESC_NULLS_LAST <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4</span>;  
    SORT_DIRECTION_CLUSTERED <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>5</span>;  
  }  
}  
</code></pre></div><p>入口：SortRelParser::parse<br>转化流程</p><ul><li>首先判断order by后是否有limit clause, 没有则limit = 0</li><li>将substrait SortField转化为CH中的SortDescription</li><li>构造SortingStep，加入到QueryPlan中。</li></ul></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>后端侠</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2025-05-21</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/gluten/>gluten</a>
<a href=/tags/clickhouse/>clickhouse</a></div><nav class=post-nav><a class=prev href=/post/gluten+ch-backend%E4%BB%8B%E7%BB%8D/><i class="iconfont icon-left"></i><span class="prev-text nav-default">Gluten+CH backend介绍</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/post/%E8%87%AA%E6%B4%BD%E7%9A%84%E7%A8%8B%E5%BA%8F%E5%91%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/><span class="next-text nav-default">《自洽的程序员》读书笔记</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><script src=https://utteranc.es/client.js repo=BackendHouse/hugo-comment issue-term=pathname theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=http://github.com/%e5%90%8e%e7%ab%af%e4%be%a0 class="iconfont icon-github" title=github></a><a href=https://backendhouse.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2020 -
2025<span class=heart><i class="iconfont icon-heart"></i></span><span>后端侠</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-SYKLLYTW9K"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-SYKLLYTW9K');</script></body></html>