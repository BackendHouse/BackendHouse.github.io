<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>现代cmake--阅读笔记 - 后端技术小屋</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="后端侠"><meta name=description content="none"><meta name=keywords content="Hugo,theme,后端侠"><meta name=generator content="Hugo 0.62.2 with theme even"><link rel=canonical href=https://backendhouse.github.io/post/%E7%8E%B0%E4%BB%A3cmake-%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.a2095472a2a8d7ddda1334cf60051cbe40ed55f2467554bb6aa4c17c9bcd27a4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="现代cmake--阅读笔记"><meta property="og:description" content="none"><meta property="og:type" content="article"><meta property="og:url" content="https://backendhouse.github.io/post/%E7%8E%B0%E4%BB%A3cmake-%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/"><meta property="article:published_time" content="2021-12-18T15:16:21+08:00"><meta property="article:modified_time" content="2021-12-18T15:16:21+08:00"><meta itemprop=name content="现代cmake--阅读笔记"><meta itemprop=description content="none"><meta itemprop=datePublished content="2021-12-18T15:16:21+08:00"><meta itemprop=dateModified content="2021-12-18T15:16:21+08:00"><meta itemprop=wordCount content="1825"><meta itemprop=keywords content="cpp,cmake,"><meta name=twitter:card content="summary"><meta name=twitter:title content="现代cmake--阅读笔记"><meta name=twitter:description content="none"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>后端技术小屋</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>后端技术小屋</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>现代cmake--阅读笔记</h1><div class=post-meta><span class=post-time>2021-12-18</span><div class=post-category><a href=/categories/cpp/>cpp</a>
<a href=/categories/cmake/>cmake</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#1-running-cmake>1. Running cmake</a><ul><li><a href=#11-cmake选项>1.1. cmake选项</a></li><li><a href=#12-选择编译器>1.2. 选择编译器</a></li><li><a href=#13-选择生成器>1.3. 选择生成器</a></li><li><a href=#14-指定编译选项>1.4. 指定编译选项</a></li><li><a href=#15-调试>1.5. 调试</a></li><li><a href=#16-指定编译类型>1.6. 指定编译类型</a></li></ul></li><li><a href=#2-dos-and-donts>2. Do's and Don'ts</a><ul><li><a href=#21-不要做>2.1. 不要做</a></li><li><a href=#22-要做>2.2. 要做</a></li><li><a href=#23-选择cmake版本>2.3. 选择cmake版本</a><ul><li><a href=#231-os支持>2.3.1. os支持</a></li><li><a href=#232-特性>2.3.2. 特性</a></li></ul></li></ul></li><li><a href=#3-whats-new-in-in-cmake>3. What's new in in CMake</a></li><li><a href=#4-基础知识>4. 基础知识</a></li><li><a href=#5-变量和cache>5. 变量和cache</a></li><li><a href=#6-cmake编程>6. cmake编程</a><ul><li><a href=#61-控制流>6.1. 控制流</a></li><li><a href=#62-宏和函数>6.2. 宏和函数</a></li></ul></li><li><a href=#7-cmake交互>7. cmake交互</a><ul><li><a href=#71-配置文件>7.1. 配置文件</a></li><li><a href=#72-读取文件>7.2. 读取文件</a></li></ul></li><li><a href=#8-如何组织工程>8. 如何组织工程</a></li><li><a href=#9-运行其他程序>9. 运行其他程序</a><ul><li><a href=#91-在配置时运行命令>9.1. 在配置时运行命令</a></li><li><a href=#92-在编译时运行命令>9.2. 在编译时运行命令</a></li></ul></li><li><a href=#10-一个简单示例>10. 一个简单示例</a></li><li><a href=#11-使用技巧>11. 使用技巧</a></li><li><a href=#12-测试>12. 测试</a></li></ul></nav></div></div><div class=post-content><h1 id=1-running-cmake>1. Running cmake</h1><h2 id=11-cmake选项>1.1. cmake选项</h2><p>&ndash;build 指定输出目录</p><p>-j 指定并行度</p><p>&ndash;target 指定编译目标</p><h2 id=12-选择编译器>1.2. 选择编译器</h2><p>EXPORT CC=clang CXX=clang++ cmake ..</p><h2 id=13-选择生成器>1.3. 选择生成器</h2><p>默认为make 通过cmake -G Ninja指定ninja</p><h2 id=14-指定编译选项>1.4. 指定编译选项</h2><p>cmake -DXXX=YYY</p><p>cmake会将各种编译选项缓存到一个文件中，即CMakeCache.txt</p><h2 id=15-调试>1.5. 调试</h2><p>调试makefile: VERBOSE=1 make</p><p>调试cmake:</p><ul><li>cmake &ndash;trace, 打印出cmake运行的每一行脚本</li><li>cmake &ndash;trace-source=<filename> 打印出<filename>中运行的每一行脚本</li><li></li></ul><h2 id=16-指定编译类型>1.6. 指定编译类型</h2><p>-DCMAKE_BUILD_TYPE：Debug或Release或RelWithDebInfo</p><p>-DCMAKE_INSTALL_PREFIX: 指定安装路径，默认为/usr/local</p><p>-DBUILD_SHARED_LIBS: 是否编译共享库，ON or OFF</p><p>-DBUILD_TESTING: 是否编译tests</p><h1 id=2-dos-and-donts>2. Do's and Don'ts</h1><h2 id=21-不要做>2.1. 不要做</h2><ul><li>不要使用全局函数: link_directories, include_libraries等</li><li>非必要不使用PULIBC限制</li><li>不要用glob匹配文件：当新增文件时，除非重新跑一遍cmake, make或其他编译工具将不会感知到新文件</li><li>lib不要直接link到最终的target</li><li>link lib时不要忽略PUBLIC/PRIVATE关键字</li></ul><h2 id=22-要做>2.2. 要做</h2><ul><li>把cmake当做正经代码维护</li><li>站在target的角度思考</li><li>善用alias</li><li>将通用功能抽象成函数或宏</li><li>函数名统一小写</li><li>善用cmake_policy</li></ul><h2 id=23-选择cmake版本>2.3. 选择cmake版本</h2><h3 id=231-os支持>2.3.1. os支持</h3><ul><li>3.4: The bare minimum. Never set less.</li><li>3.7: Debian old-stable.</li><li>3.10: Ubuntu 18.04.</li><li>3.11: CentOS 8 (use EPEL or AppSteams, though)</li><li>3.13: Debian stable.</li><li>3.16: Ubuntu 20.04.</li><li>3.19: First to support Apple Silicon.</li><li>latest: pip/conda-forge/homebew/chocolaty, ect.</li></ul><p>笔者目前用的是3.16</p><h3 id=232-特性>2.3.2. 特性</h3><ul><li>3.8: C++ meta features, CUDA, lots more</li><li>3.11: <code>IMPORTED INTERFACE</code> setting, faster, FetchContent, <code>COMPILE_LANGUAGE</code> in IDEs</li><li>3.12: C++20, <code>cmake --build build -j N</code>, <code>SHELL:</code>, FindPython</li><li>3.14/3.15: CLI, FindPython updates</li><li>3.16: Unity builds / precompiled headers, CUDA meta features</li><li>3.17/3.18: Lots more CUDA, metaprogramming</li></ul><h1 id=3-whats-new-in-in-cmake>3. What's new in in CMake</h1><ul><li>cmake 3.0: interface libraries, 允许将一组头文件抽象成一个lib</li><li>cmake 3.1: 支持c++11和compile features</li><li>cmake 3.2: 支持UTF-8</li><li>cmake 3.4: 支持swift语言，支持ccache</li><li>cmake 3.5: 支持ARM平台</li><li>cmake 3.6: 支持clang-tidy</li><li>其他：略</li></ul><h1 id=4-基础知识>4. 基础知识</h1><p><strong>指定最小版本</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>cmake_minimum_required</span>(<span style=color:#f1fa8c>VERSION</span> <span style=color:#f1fa8c>3.1</span>)
</code></pre></div><p><strong>创建工程</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>project</span>(<span style=color:#f1fa8c>MyProject</span> <span style=color:#f1fa8c>VERSION</span> <span style=color:#f1fa8c>1.0</span>
                  <span style=color:#f1fa8c>DESCRIPTION</span> <span style=color:#f1fa8c>&#34;Very nice project&#34;</span>
                  <span style=color:#f1fa8c>LANGUAGES</span> <span style=color:#f1fa8c>CXX</span>)
</code></pre></div><p><strong>新增executable</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>add_executable</span>(<span style=color:#f1fa8c>one</span> <span style=color:#f1fa8c>two.cpp</span> <span style=color:#f1fa8c>three.h</span>)
</code></pre></div><p><strong>新增library</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>add_library</span>(<span style=color:#f1fa8c>one</span> <span style=color:#f1fa8c>STATIC</span> <span style=color:#f1fa8c>two.cpp</span> <span style=color:#f1fa8c>three.h</span>)
</code></pre></div><p>用户可指定STATIC、SHARED、MODULE 。缺省使用BUILD_SHARED_LIBS选项。</p><p>INTERFAC用于创建头文件库</p><p>ALIAS用于指定库的别名.</p><p><strong>绑定头文件路径</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>target_include_directories</span>(<span style=color:#f1fa8c>one</span> <span style=color:#f1fa8c>PUBLIC</span> <span style=color:#f1fa8c>include</span>)
</code></pre></div><p>PUBLIC表示所有依赖lib的target都自动绑定了该头文件路径</p><p>PRIVATE表示该头文件路径仅对本target有效</p><p>INTERFACE表示该头文件路径仅对依赖该lib的target生效</p><p>PUBLIC = PRIVATE + INTERFACE</p><h1 id=5-变量和cache>5. 变量和cache</h1><p><strong>定义变量</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-CMake data-lang=CMake><span style=color:#8be9fd;font-style:italic>set</span>(<span style=color:#f1fa8c>MY_VARIABLE</span> <span style=color:#f1fa8c>&#34;value&#34;</span>)
</code></pre></div><p>访问变量时使用<code>${MY_VARIABLE}</code></p><p>变量仅在当前作用域内有效。</p><p><strong>定义变量(多个值)</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>set</span>(<span style=color:#f1fa8c>MY_LIST</span> <span style=color:#f1fa8c>&#34;one&#34;</span> <span style=color:#f1fa8c>&#34;two&#34;</span>)
</code></pre></div><p>等效于</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>set</span>(<span style=color:#f1fa8c>MY_LIST</span> <span style=color:#f1fa8c>&#34;one;two&#34;</span>)
</code></pre></div><p><strong>属性</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>set_property</span>(<span style=color:#f1fa8c>TARGET</span> <span style=color:#f1fa8c>TargetName</span>
             <span style=color:#f1fa8c>PROPERTY</span> <span style=color:#f1fa8c>CXX_STANDARD</span> <span style=color:#f1fa8c>11</span>)

<span style=color:#8be9fd;font-style:italic>set_target_properties</span>(<span style=color:#f1fa8c>TargetName</span> <span style=color:#f1fa8c>PROPERTIES</span>
                      <span style=color:#f1fa8c>CXX_STANDARD</span> <span style=color:#f1fa8c>11</span>)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>get_property</span>(<span style=color:#f1fa8c>ResultVariable</span> <span style=color:#f1fa8c>TARGET</span> <span style=color:#f1fa8c>TargetName</span> <span style=color:#f1fa8c>PROPERTY</span> <span style=color:#f1fa8c>CXX_STANDARD</span>)
</code></pre></div><h1 id=6-cmake编程>6. cmake编程</h1><h2 id=61-控制流>6.1. 控制流</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>if</span>(<span style=color:#f1fa8c>variable</span>)
    <span style=color:#6272a4># If variable is `ON`, `YES`, `TRUE`, `Y`, or non zero number
</span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>else</span>()
    <span style=color:#6272a4># If variable is `0`, `OFF`, `NO`, `FALSE`, `N`, `IGNORE`, `NOTFOUND`, `&#34;&#34;`, or ends in `-NOTFOUND`
</span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>endif</span>()
<span style=color:#6272a4># If variable does not expand to one of the above, CMake will expand it then try again
</span></code></pre></div><p>There are a variety of keywords as well, such as:</p><ul><li>Unary: <code>NOT</code>, <code>TARGET</code>, <code>EXISTS</code> (file), <code>DEFINED</code>, etc.</li><li>Binary: <code>STREQUAL</code>, <code>AND</code>, <code>OR</code>, <code>MATCHES</code> (regular expression), <code>VERSION_LESS</code>, <code>VERSION_LESS_EQUAL</code> (CMake 3.7+), etc.</li><li>Parentheses can be used to group</li></ul><p><strong>generator-expressions</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>target_compile_options</span>(<span style=color:#f1fa8c>MyTarget</span> <span style=color:#f1fa8c>PRIVATE</span> <span style=color:#f1fa8c>&#34;$&lt;$&lt;CONFIG:Debug&gt;:--my-flag&gt;&#34;</span>)
</code></pre></div><p>当使用debug编译时，加上&ndash;my-flag编译选项</p><p>That last one is very common. You'll see something like this in almost every package that supports installing:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>target_include_directories</span>(
    <span style=color:#f1fa8c>MyTarget</span>
  <span style=color:#f1fa8c>PUBLIC</span>
    <span style=color:#ff79c6>$&lt;</span><span style=color:#8be9fd;font-style:italic>BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include</span><span style=color:#ff79c6>&gt;</span>
    <span style=color:#ff79c6>$&lt;</span><span style=color:#8be9fd;font-style:italic>INSTALL_INTERFACE:include</span><span style=color:#ff79c6>&gt;</span>
)
</code></pre></div><h2 id=62-宏和函数>6.2. 宏和函数</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>function</span>(<span style=color:#f1fa8c>SIMPLE</span> <span style=color:#f1fa8c>REQUIRED_ARG</span>)
    <span style=color:#8be9fd;font-style:italic>message</span>(<span style=color:#f1fa8c>STATUS</span> <span style=color:#f1fa8c>&#34;Simple arguments: ${REQUIRED_ARG}, followed by ${ARGN}&#34;</span>)
    <span style=color:#8be9fd;font-style:italic>set</span>(<span style=color:#ff79c6>${</span><span style=color:#8be9fd;font-style:italic>REQUIRED_ARG</span><span style=color:#ff79c6>}</span> <span style=color:#f1fa8c>&#34;From SIMPLE&#34;</span> <span style=color:#f1fa8c>PARENT_SCOPE</span>)
<span style=color:#8be9fd;font-style:italic>endfunction</span>()

<span style=color:#8be9fd;font-style:italic>simple</span>(<span style=color:#f1fa8c>This</span> <span style=color:#f1fa8c>Foo</span> <span style=color:#f1fa8c>Bar</span>)
<span style=color:#8be9fd;font-style:italic>message</span>(<span style=color:#f1fa8c>&#34;Output: ${This}&#34;</span>)
</code></pre></div><p>The output would be:</p><pre><code>-- Simple arguments: This, followed by Foo;Bar
Output: From SIMPLE
</code></pre><h1 id=7-cmake交互>7. cmake交互</h1><h2 id=71-配置文件>7.1. 配置文件</h2><p>Version.h.in</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#ff79c6>#</span><span style=color:#ff79c6>pragma once</span><span style=color:#ff79c6>
</span><span style=color:#ff79c6></span>
<span style=color:#ff79c6>#</span><span style=color:#ff79c6>define MY_VERSION_MAJOR @PROJECT_VERSION_MAJOR@</span><span style=color:#ff79c6>
</span><span style=color:#ff79c6></span><span style=color:#ff79c6>#</span><span style=color:#ff79c6>define MY_VERSION_MINOR @PROJECT_VERSION_MINOR@</span><span style=color:#ff79c6>
</span><span style=color:#ff79c6></span><span style=color:#ff79c6>#</span><span style=color:#ff79c6>define MY_VERSION_PATCH @PROJECT_VERSION_PATCH@</span><span style=color:#ff79c6>
</span><span style=color:#ff79c6></span><span style=color:#ff79c6>#</span><span style=color:#ff79c6>define MY_VERSION_TWEAK @PROJECT_VERSION_TWEAK@</span><span style=color:#ff79c6>
</span><span style=color:#ff79c6></span><span style=color:#ff79c6>#</span><span style=color:#ff79c6>define MY_VERSION &#34;@PROJECT_VERSION@&#34;</span><span style=color:#ff79c6>
</span></code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>configure_file</span> (
    <span style=color:#f1fa8c>&#34;${PROJECT_SOURCE_DIR}/include/My/Version.h.in&#34;</span>
    <span style=color:#f1fa8c>&#34;${PROJECT_BINARY_DIR}/include/My/Version.h&#34;</span>
)
</code></pre></div><h2 id=72-读取文件>7.2. 读取文件</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#6272a4># Assuming the canonical version is listed in a single line
</span><span style=color:#6272a4></span><span style=color:#6272a4># This would be in several parts if picking up from MAJOR, MINOR, etc.
</span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>set</span>(<span style=color:#f1fa8c>VERSION_REGEX</span> <span style=color:#f1fa8c>&#34;#define MY_VERSION[ \t]+\&#34;</span>(<span style=color:#f1fa8c>.+</span>)<span style=color:#f1fa8c>\&#34;&#34;)</span>

<span style=color:#6272a4># Read in the line containing the version
</span><span style=color:#6272a4></span><span style=color:#f1fa8c>file(STRINGS</span> <span style=color:#f1fa8c>&#34;${CMAKE_CURRENT_SOURCE_DIR}/include/My/Version.hpp&#34;</span>
    <span style=color:#f1fa8c>VERSION_STRING</span> <span style=color:#f1fa8c>REGEX</span> <span style=color:#ff79c6>${</span><span style=color:#8be9fd;font-style:italic>VERSION_REGEX</span><span style=color:#ff79c6>}</span>)

<span style=color:#6272a4># Pick out just the version
</span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>string</span>(<span style=color:#f1fa8c>REGEX</span> <span style=color:#f1fa8c>REPLACE</span> <span style=color:#ff79c6>${</span><span style=color:#8be9fd;font-style:italic>VERSION_REGEX</span><span style=color:#ff79c6>}</span> <span style=color:#f1fa8c>&#34;\\1&#34;</span> <span style=color:#f1fa8c>VERSION_STRING</span> <span style=color:#f1fa8c>&#34;${VERSION_STRING}&#34;</span>)

<span style=color:#6272a4># Automatically getting PROJECT_VERSION_MAJOR, My_VERSION_MAJOR, etc.
</span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>project</span>(<span style=color:#f1fa8c>My</span> <span style=color:#f1fa8c>LANGUAGES</span> <span style=color:#f1fa8c>CXX</span> <span style=color:#f1fa8c>VERSION</span> <span style=color:#ff79c6>${</span><span style=color:#8be9fd;font-style:italic>VERSION_STRING</span><span style=color:#ff79c6>}</span>)
</code></pre></div><h1 id=8-如何组织工程>8. 如何组织工程</h1><pre><code>- project
  - .gitignore
  - README.md
  - LICENCE.md
  - CMakeLists.txt
  - cmake
    - FindSomeLib.cmake
    - something_else.cmake
  - include
    - project
      - lib.hpp
  - src
    - CMakeLists.txt
    - lib.cpp
  - apps
    - CMakeLists.txt
    - app.cpp
  - tests
    - CMakeLists.txt
    - testlib.cpp
  - docs
    - CMakeLists.txt
  - extern
    - googletest
  - scripts
    - helper.py
</code></pre><p>将cmake/目录加入到工程中.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>set</span>(<span style=color:#f1fa8c>CMAKE_MODULE_PATH</span> <span style=color:#f1fa8c>&#34;${PROJECT_SOURCE_DIR}/cmake&#34;</span> <span style=color:#ff79c6>${</span><span style=color:#8be9fd;font-style:italic>CMAKE_MODULE_PATH</span><span style=color:#ff79c6>}</span>)
</code></pre></div><h1 id=9-运行其他程序>9. 运行其他程序</h1><h2 id=91-在配置时运行命令>9.1. 在配置时运行命令</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>find_package</span>(<span style=color:#f1fa8c>Git</span> <span style=color:#f1fa8c>QUIET</span>)

<span style=color:#8be9fd;font-style:italic>if</span>(<span style=color:#f1fa8c>GIT_FOUND</span> <span style=color:#f1fa8c>AND</span> <span style=color:#f1fa8c>EXISTS</span> <span style=color:#f1fa8c>&#34;${PROJECT_SOURCE_DIR}/.git&#34;</span>)
    <span style=color:#8be9fd;font-style:italic>execute_process</span>(<span style=color:#f1fa8c>COMMAND</span> <span style=color:#ff79c6>${</span><span style=color:#8be9fd;font-style:italic>GIT_EXECUTABLE</span><span style=color:#ff79c6>}</span> <span style=color:#f1fa8c>submodule</span> <span style=color:#f1fa8c>update</span> <span style=color:#f1fa8c>--init</span> <span style=color:#f1fa8c>--recursive</span>
                    <span style=color:#f1fa8c>WORKING_DIRECTORY</span> <span style=color:#ff79c6>${</span><span style=color:#8be9fd;font-style:italic>CMAKE_CURRENT_SOURCE_DIR</span><span style=color:#ff79c6>}</span>
                    <span style=color:#f1fa8c>RESULT_VARIABLE</span> <span style=color:#f1fa8c>GIT_SUBMOD_RESULT</span>)
    <span style=color:#8be9fd;font-style:italic>if</span>(<span style=color:#f1fa8c>NOT</span> <span style=color:#f1fa8c>GIT_SUBMOD_RESULT</span> <span style=color:#f1fa8c>EQUAL</span> <span style=color:#f1fa8c>&#34;0&#34;</span>)
        <span style=color:#8be9fd;font-style:italic>message</span>(<span style=color:#f1fa8c>FATAL_ERROR</span> <span style=color:#f1fa8c>&#34;git submodule update --init --recursive failed with ${GIT_SUBMOD_RESULT}, please checkout submodules&#34;</span>)
    <span style=color:#8be9fd;font-style:italic>endif</span>()
<span style=color:#8be9fd;font-style:italic>endif</span>()
</code></pre></div><h2 id=92-在编译时运行命令>9.2. 在编译时运行命令</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>find_package</span>(<span style=color:#f1fa8c>PythonInterp</span> <span style=color:#f1fa8c>REQUIRED</span>)
<span style=color:#8be9fd;font-style:italic>add_custom_command</span>(<span style=color:#f1fa8c>OUTPUT</span> <span style=color:#f1fa8c>&#34;${CMAKE_CURRENT_BINARY_DIR}/include/Generated.hpp&#34;</span>
    <span style=color:#f1fa8c>COMMAND</span> <span style=color:#f1fa8c>&#34;${PYTHON_EXECUTABLE}&#34;</span> <span style=color:#f1fa8c>&#34;${CMAKE_CURRENT_SOURCE_DIR}/scripts/GenerateHeader.py&#34;</span> <span style=color:#f1fa8c>--argument</span>
    <span style=color:#f1fa8c>DEPENDS</span> <span style=color:#f1fa8c>some_target</span>)

<span style=color:#8be9fd;font-style:italic>add_custom_target</span>(<span style=color:#f1fa8c>generate_header</span> <span style=color:#f1fa8c>ALL</span>
    <span style=color:#f1fa8c>DEPENDS</span> <span style=color:#f1fa8c>&#34;${CMAKE_CURRENT_BINARY_DIR}/include/Generated.hpp&#34;</span>)

<span style=color:#8be9fd;font-style:italic>install</span>(<span style=color:#f1fa8c>FILES</span> <span style=color:#ff79c6>${</span><span style=color:#8be9fd;font-style:italic>CMAKE_CURRENT_BINARY_DIR</span><span style=color:#ff79c6>}</span><span style=color:#f1fa8c>/include/Generated.hpp</span> <span style=color:#f1fa8c>DESTINATION</span>  <span style=color:#f1fa8c>include</span>)
</code></pre></div><h1 id=10-一个简单示例>10. 一个简单示例</h1><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#6272a4># Almost all CMake files should start with this
</span><span style=color:#6272a4></span><span style=color:#6272a4># You should always specify a range with the newest
</span><span style=color:#6272a4></span><span style=color:#6272a4># and oldest tested versions of CMake. This will ensure
</span><span style=color:#6272a4></span><span style=color:#6272a4># you pick up the best policies.
</span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>cmake_minimum_required</span>(<span style=color:#f1fa8c>VERSION</span> <span style=color:#f1fa8c>3.1...3.22</span>)

<span style=color:#6272a4># This is your project statement. You should always list languages;
</span><span style=color:#6272a4></span><span style=color:#6272a4># Listing the version is nice here since it sets lots of useful variables
</span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>project</span>(
  <span style=color:#f1fa8c>ModernCMakeExample</span>
  <span style=color:#f1fa8c>VERSION</span> <span style=color:#f1fa8c>1.0</span>
  <span style=color:#f1fa8c>LANGUAGES</span> <span style=color:#f1fa8c>CXX</span>)

<span style=color:#6272a4># If you set any CMAKE_ variables, that can go here.
</span><span style=color:#6272a4></span><span style=color:#6272a4># (But usually don&#39;t do this, except maybe for C++ standard)
</span><span style=color:#6272a4></span>
<span style=color:#6272a4># Find packages go here.
</span><span style=color:#6272a4></span>
<span style=color:#6272a4># You should usually split this into folders, but this is a simple example
</span><span style=color:#6272a4></span>
<span style=color:#6272a4># This is a &#34;default&#34; library, and will match the *** variable setting.
</span><span style=color:#6272a4></span><span style=color:#6272a4># Other common choices are STATIC, SHARED, and MODULE
</span><span style=color:#6272a4></span><span style=color:#6272a4># Including header files here helps IDEs but is not required.
</span><span style=color:#6272a4></span><span style=color:#6272a4># Output libname matches target name, with the usual extensions on your system
</span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>add_library</span>(<span style=color:#f1fa8c>MyLibExample</span> <span style=color:#f1fa8c>simple_lib.cpp</span> <span style=color:#f1fa8c>simple_lib.hpp</span>)

<span style=color:#6272a4># Link each target with other targets or add options, etc.
</span><span style=color:#6272a4></span>
<span style=color:#6272a4># Adding something we can run - Output name matches target name
</span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>add_executable</span>(<span style=color:#f1fa8c>MyExample</span> <span style=color:#f1fa8c>simple_example.cpp</span>)

<span style=color:#6272a4># Make sure you link your targets with this command. It can also link libraries and
</span><span style=color:#6272a4></span><span style=color:#6272a4># even flags, so linking a target that does not exist will not give a configure-time error.
</span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>target_link_libraries</span>(<span style=color:#f1fa8c>MyExample</span> <span style=color:#f1fa8c>PRIVATE</span> <span style=color:#f1fa8c>MyLibExample</span>)
</code></pre></div><h1 id=11-使用技巧>11. 使用技巧</h1><p><strong>选择c++标准</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>set_target_properties</span>(<span style=color:#f1fa8c>myTarget</span> <span style=color:#f1fa8c>PROPERTIES</span>
    <span style=color:#f1fa8c>CXX_STANDARD</span> <span style=color:#f1fa8c>11</span>
    <span style=color:#f1fa8c>CXX_STANDARD_REQUIRED</span> <span style=color:#f1fa8c>YES</span>
    <span style=color:#f1fa8c>CXX_EXTENSIONS</span> <span style=color:#f1fa8c>NO</span>
)
</code></pre></div><p><strong>启用pisition independent code</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>set</span>(<span style=color:#f1fa8c>CMAKE_POSITION_INDEPENDENT_CODE</span> <span style=color:#f1fa8c>ON</span>)
</code></pre></div><p><strong>集成ccache</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>find_program</span>(<span style=color:#f1fa8c>CCACHE_PROGRAM</span> <span style=color:#f1fa8c>ccache</span>)
<span style=color:#8be9fd;font-style:italic>if</span>(<span style=color:#f1fa8c>CCACHE_PROGRAM</span>)
    <span style=color:#8be9fd;font-style:italic>set</span>(<span style=color:#f1fa8c>CMAKE_CXX_COMPILER_LAUNCHER</span> <span style=color:#f1fa8c>&#34;${CCACHE_PROGRAM}&#34;</span>)
    <span style=color:#8be9fd;font-style:italic>set</span>(<span style=color:#f1fa8c>CMAKE_CUDA_COMPILER_LAUNCHER</span> <span style=color:#f1fa8c>&#34;${CCACHE_PROGRAM}&#34;</span>) <span style=color:#6272a4># CMake 3.9+
</span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>endif</span>()
</code></pre></div><p><strong>集成clang-tidy</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>~/package <span style=color:#6272a4># cmake -S . -B build-tidy -DCMAKE_CXX_CLANG_TIDY=&#34;$(which clang-tidy);-fix&#34;</span>
</code></pre></div><p><strong>打印变量</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>message</span>(<span style=color:#f1fa8c>STATUS</span> <span style=color:#f1fa8c>&#34;MY_VARIABLE=${MY_VARIABLE}&#34;</span>)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>include</span>(<span style=color:#f1fa8c>CMakePrintHelpers</span>)
<span style=color:#8be9fd;font-style:italic>cmake_print_variables</span>(<span style=color:#f1fa8c>MY_VARIABLE</span>)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>cmake_print_properties</span>(
    <span style=color:#f1fa8c>TARGETS</span> <span style=color:#f1fa8c>my_target</span>
    <span style=color:#f1fa8c>PROPERTIES</span> <span style=color:#f1fa8c>POSITION_INDEPENDENT_CODE</span>
)
</code></pre></div><p><strong>trace cmake</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cmake -S . -B build --trace-source<span style=color:#ff79c6>=</span>CMakeLists.txt
</code></pre></div><p><strong>debug编译</strong></p><p>-DCMAKE_BUILD_TYPE=Debug</p><h1 id=12-测试>12. 测试</h1><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=color:#8be9fd;font-style:italic>add_test</span>(
  <span style=color:#f1fa8c>NAME</span>
    <span style=color:#f1fa8c>ExampleCMakeBuild</span>
  <span style=color:#f1fa8c>COMMAND</span>
    <span style=color:#f1fa8c>&#34;${CMAKE_CTEST_COMMAND}&#34;</span>
             <span style=color:#f1fa8c>--build-and-test</span> <span style=color:#f1fa8c>&#34;${My_SOURCE_DIR}/examples/simple&#34;</span>
                              <span style=color:#f1fa8c>&#34;${CMAKE_CURRENT_BINARY_DIR}/simple&#34;</span>
             <span style=color:#f1fa8c>--build-generator</span> <span style=color:#f1fa8c>&#34;${CMAKE_GENERATOR}&#34;</span>
             <span style=color:#f1fa8c>--test-command</span> <span style=color:#f1fa8c>&#34;${CMAKE_CTEST_COMMAND}&#34;</span>
)
</code></pre></div></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>后端侠</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2021-12-18</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/cpp/>cpp</a>
<a href=/tags/cmake/>cmake</a></div><nav class=post-nav><a class=prev href=/post/2021%E6%80%BB%E7%BB%93%E5%92%8C%E6%96%B0%E4%B8%80%E5%B9%B4%E7%9A%84%E5%B1%95%E6%9C%9B/><i class="iconfont icon-left"></i><span class="prev-text nav-default">2021总结和新一年的展望</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/post/%E8%81%8A%E8%81%8Aclickhouse%E7%9A%84%E5%BC%80%E5%8F%91%E7%BC%96%E8%AF%91%E5%92%8C%E6%B5%8B%E8%AF%95/><span class="next-text nav-default">聊聊ClickHouse的开发、编译和测试</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><script src=https://utteranc.es/client.js repo=BackendHouse/hugo-comment issue-term=pathname theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=http://github.com/%e5%90%8e%e7%ab%af%e4%be%a0 class="iconfont icon-github" title=github></a><a href=https://backendhouse.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2020 -
2025<span class=heart><i class="iconfont icon-heart"></i></span><span>后端侠</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-SYKLLYTW9K"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-SYKLLYTW9K');</script></body></html>