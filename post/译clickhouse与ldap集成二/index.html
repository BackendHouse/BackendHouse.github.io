<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>【译】Clickhouse与LDAP集成（二） - 后端技术小屋</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="后端侠"><meta name=description content="【译】Clickhouse与LDAP集成（二）"><meta name=keywords content="Hugo,theme,后端侠"><meta name=generator content="Hugo 0.62.2 with theme even"><link rel=canonical href=https://backendhouse.github.io/post/%E8%AF%91clickhouse%E4%B8%8Eldap%E9%9B%86%E6%88%90%E4%BA%8C/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.a2095472a2a8d7ddda1334cf60051cbe40ed55f2467554bb6aa4c17c9bcd27a4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="【译】Clickhouse与LDAP集成（二）"><meta property="og:description" content="【译】Clickhouse与LDAP集成（二）"><meta property="og:type" content="article"><meta property="og:url" content="https://backendhouse.github.io/post/%E8%AF%91clickhouse%E4%B8%8Eldap%E9%9B%86%E6%88%90%E4%BA%8C/"><meta property="article:published_time" content="2021-09-20T14:23:08+08:00"><meta property="article:modified_time" content="2021-09-20T14:23:08+08:00"><meta itemprop=name content="【译】Clickhouse与LDAP集成（二）"><meta itemprop=description content="【译】Clickhouse与LDAP集成（二）"><meta itemprop=datePublished content="2021-09-20T14:23:08+08:00"><meta itemprop=dateModified content="2021-09-20T14:23:08+08:00"><meta itemprop=wordCount content="3854"><meta itemprop=keywords content="Clickhouse,"><meta name=twitter:card content="summary"><meta name=twitter:title content="【译】Clickhouse与LDAP集成（二）"><meta name=twitter:description content="【译】Clickhouse与LDAP集成（二）"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>后端技术小屋</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>后端技术小屋</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>【译】Clickhouse与LDAP集成（二）</h1><div class=post-meta><span class=post-time>2021-09-20</span><div class=post-category><a href=/categories/clickhouse/>Clickhouse</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#准备工作>准备工作</a></li><li><a href=#ldap用户角色>LDAP用户角色</a></li><li><a href=#使用ldap外部用户目录>使用LDAP外部用户目录</a></li><li><a href=#ldap用户组到rbac角色的映射>LDAP用户组到RBAC角色的映射</a></li><li><a href=#结论>结论</a></li></ul></nav></div></div><div class=post-content><blockquote><p>更多精彩内容，请关注微信公众号：<strong>后端技术小屋</strong></p></blockquote><p>原文：https://altinity.com/blog/integrating-clickhouse-with-ldap-part-two
作者：Vitaliy Zakaznikov</p><p>之前我们发布了<a href=https://mp.weixin.qq.com/s/pL3JFBnKO1TFrpL0z_hyjg>Clickhouse与LDAP集成(一)</a>，这是确保Clickhouse帐户安全的重要一步。我们研究了如何将使用LDAP服务器对Clickhouse用户进行认证，而非在 XML配置文件中手动指定用户名密码。</p><p>在本文中，我们将继续研究如何将ClickHouse和LDAP集成使用。我们将讨论如何将二者的集成提升到一个新的水平。我们将LDAP服务器作为Clickhouse的外部用户目录，通过在Clickhouse中添加LDAP相关配置，Clickhouse会自动从LDAP中查找用户并认证，这样我们就避免了在ClickHouse中直接定义用户。接下是的内容讲述如何将LDAP的用户组映射到Clickhouse RBAC中的角色，以动态控制所有LDAP定义的用户的访问管理。</p><p>这非常有趣，所以让我们开始吧！</p><h1 id=准备工作>准备工作</h1><p>我们将使用与第一部分(<a href=https://mp.weixin.qq.com/s/pL3JFBnKO1TFrpL0z_hyjg>Clickhouse与LDAP集成(一)</a>)中完全相同的配置，因此如果您想继续，请设置您的测试环境，然后添加LDAP配置并检查配置是否生效。</p><h1 id=ldap用户角色>LDAP用户角色</h1><p>在我们配置作为Clickhouse外部目录的LDAP之前，我们需要在Clickhouse中定义一个或多个绑定到LDAP用户的RBAC角色。否则LDAP用户将没有任何权限。</p><p>现在为LDAP用户创建一个RBAC角色。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> clickhouse1 bash -c <span style=color:#f1fa8c>&#39;clickhouse client -q &#34;CREATE ROLE ldap_user_role&#34;&#39;</span>
</code></pre></div><p>检查该角色是否已创建。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> clickhouse1 bash -c <span style=color:#f1fa8c>&#39;clickhouse client -q &#34;SHOW ROLES&#34;&#39;</span>
ldap_user_role
</code></pre></div><p>为了方便测试，现在我们将所有权限授予ldap_user_role这个角色。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> clickhouse1 bash -c <span style=color:#f1fa8c>&#39;clickhouse client -q &#34;GRANT ALL ON *.* TO ldap_user_role&#34;&#39;</span>
</code></pre></div><p>检查权限是否设置成功</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> clickhouse1 bash -c <span style=color:#f1fa8c>&#39;clickhouse client -q &#34;SHOW ACCESS&#34; | grep ldap_user_role&#39;</span>
CREATE ROLE ldap_user_role
GRANT ALL ON *.* TO ldap_user_role
</code></pre></div><p>看起来正常。现在我们继续下一部分：使用LDAP外部用户目录</p><h1 id=使用ldap外部用户目录>使用LDAP外部用户目录</h1><p>在启动docker-compose环境和Clickhouse中配置好LDAP之后，修改config.xml中的<yandex> &lt;user_directories>中的<ldap>配置，ClickHouse就可以使用LDAP服务器作为外部用户目录了。</p><p>但是在最佳实践中，我们不会config.xml直接修改，而是将单独的配置文件添加到/etc/clickhouse-server/config.d目录下。</p><p>请注意，如果您刚刚完成了第一部分(<a href=https://mp.weixin.qq.com/s/pL3JFBnKO1TFrpL0z_hyjg>Clickhouse与LDAP集成(一)</a>)的工作，那么您需要删除ldapuser.xml文件，避免它与我们设置的LDAP外部目录冲突</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> clickhouse1 bash -c <span style=color:#f1fa8c>&#39;rm -rf /etc/clickhouse-server/users.d/ldapuser.xml&#39;</span>
</code></pre></div><p>然后确保我们无法使用ldapuser账户登录Clickhouse</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> clickhouse1 bash -c <span style=color:#f1fa8c>&#39;clickhouse client -n --user &#34;ldapuser&#34; --password &#34;ldapuser&#34; -q &#34;SELECT user()&#34;&#39;</span>
</code></pre></div><p>结果符合预期，登录失败。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Code: 516. DB::Exception: Received from localhost:9000. DB::Exception: ldapuser: Authentication failed: password is incorrect or there is no user with such name.
</code></pre></div><p>现在我们添加LDAP外部用户目录。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> clickhouse1 bash -c <span style=color:#f1fa8c>&#39;cat &lt;&lt;HEREDOC &gt; /etc/clickhouse-server/config.d/ldap_external_user_directory.xml
</span><span style=color:#f1fa8c>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
</span><span style=color:#f1fa8c>&lt;yandex&gt;
</span><span style=color:#f1fa8c>    &lt;!--LDAP external user directory da296a1c-7874-11eb-998e-ddba30bbed5d --&gt;
</span><span style=color:#f1fa8c>    &lt;user_directories&gt;
</span><span style=color:#f1fa8c>        &lt;ldap&gt;
</span><span style=color:#f1fa8c>            &lt;server&gt;openldap1&lt;/server&gt;
</span><span style=color:#f1fa8c>            &lt;roles&gt;
</span><span style=color:#f1fa8c>                &lt;ldap_user_role/&gt;
</span><span style=color:#f1fa8c>            &lt;/roles&gt;
</span><span style=color:#f1fa8c>        &lt;/ldap&gt;
</span><span style=color:#f1fa8c>    &lt;/user_directories&gt;
</span><span style=color:#f1fa8c>&lt;/yandex&gt;
</span><span style=color:#f1fa8c>HEREDOC&#39;</span>
</code></pre></div><p>要注意，在<roles>配置中，我们指定了要分配给所有LDAP用户的角色。这里我们只定义了一个ldap_user_role角色，但您可以根据需要添加多个角色。这些角色将始终被分配给LDAP用户，并且在Clickhouse认证时必须存在。如果其中某个角色不存在，则在Clickhouse添加该角色角色之前，LDAP用户将无法通过认证，并且您将收到类似这样的报错：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Code: 516. DB::Exception: Received from localhost:9000. DB::Exception: ldapuser: Authentication failed: password is incorrect or there is no user with such name. 
</code></pre></div><p>现在重新启动ClickHouse使得上述配置生效。注意：添加或删除外部用户目录需要重新启动Clickhouse</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose restart clickhouse1
Restarting docker-compose_clickhouse1_1 ... <span style=color:#ff79c6>done</span>
</code></pre></div><p>检查配置是否已经被合并</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> clickhouse1 bash -c <span style=color:#f1fa8c>&#39;cat /var/lib/clickhouse/preprocessed_configs/config.xml | grep da296a1c-7874-11eb-998e-ddba30bbed5d&#39;</span>
    &lt;!--LDAP external user directory da296a1c-7874-11eb-998e-ddba30bbed5d --&gt;
</code></pre></div><p>在openldap1容器中，用户ldapuser的密码设置为与用户名相同。现在尝试使用此用户登录 ClickHouse。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> clickhouse1 bash -c <span style=color:#f1fa8c>&#39;clickhouse client -n --user &#34;ldapuser&#34; --password &#34;ldapuser&#34; -q &#34;SELECT user()&#34;&#39;</span>
ldapuser
</code></pre></div><p>生效了!我们可以使用LDAP中定义的用户登录Clickhouse。现在我们动态地将另一个用户添加到LDAP用户目录中, 并测试不修改任何Clickhouse配置的情况下该用户是否可通过认证</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> openldap1 bash -c <span style=color:#f1fa8c>&#39;echo -e &#34;dn: cn=new_ldap_user,ou=users,dc=company,dc=com
</span><span style=color:#f1fa8c>cn: new_ldap_user
</span><span style=color:#f1fa8c>gidnumber: 501
</span><span style=color:#f1fa8c>givenname: John
</span><span style=color:#f1fa8c>homedirectory: /home/users
</span><span style=color:#f1fa8c>objectclass: inetOrgPerson
</span><span style=color:#f1fa8c>objectclass: posixAccount
</span><span style=color:#f1fa8c>objectclass: top
</span><span style=color:#f1fa8c>sn: User
</span><span style=color:#f1fa8c>uid: new_ldap_user
</span><span style=color:#f1fa8c>uidnumber: 2000
</span><span style=color:#f1fa8c>userpassword: new_ldap_user&#34; | ldapadd -x -H ldap://localhost -D &#34;cn=admin,dc=company,dc=com&#34; -w admin&#39;</span>
</code></pre></div><p>您应该会看到提示，确认已将新用户条目添加到 LDAP。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>adding new entry <span style=color:#f1fa8c>&#34;cn=new_ldap_user,ou=users,dc=company,dc=com&#34;</span>
</code></pre></div><p>现在我们尝试使用这个新的LDAP用户登录。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> clickhouse1 bash -c <span style=color:#f1fa8c>&#39;clickhouse-client -n --user &#34;new_ldap_user&#34; --password &#34;new_ldap_user&#34; -q &#34;SELECT user()&#34;&#39;</span>
new_ldap_user
</code></pre></div><p>它起作用了，我们可以使用动态添加的LDAP用户成功登陆Clickhouse。现在我们从LDAP中动态删除新用户。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> openldap1 bash -c <span style=color:#f1fa8c>&#39;ldapdelete -x -H ldap://localhost -D &#34;cn=admin,dc=company,dc=com&#34; -w admin &#34;cn=new_ldap_user,ou=users,dc=company,dc=com&#34;&#39;</span>
</code></pre></div><p>尝试使用已删除的LDAP用户登录，您应该会看到登陆失败。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> clickhouse1 bash -c <span style=color:#f1fa8c>&#39;clickhouse-client -n --user &#34;new_ldap_user&#34; --password &#34;new_ldap_user&#34; -q &#34;SELECT user()&#34;&#39;</span>
Code: 516. DB::Exception: Received from localhost:9000. DB::Exception: new_ldap_user: Authentication failed: password is incorrect or there is no user with such name. 
</code></pre></div><h1 id=ldap用户组到rbac角色的映射>LDAP用户组到RBAC角色的映射</h1><p>我们之前提到过，当LDAP用户登录时，他们会被绑定在LDAP外部用户目录配置中指定的角色。在我们的例子中，我们只分配了一个角色即ldap_user_role.</p><p>当我们尝试用ldapuser登录时，让我们看看为这个用户分配了哪些角色：</p><pre><code>docker-compose exec clickhouse1 bash -c 'clickhouse-client -n --user &quot;ldapuser&quot; --password &quot;ldapuser&quot; -q &quot;SHOW ROLES&quot;'
ldap_user_role
</code></pre><p>如您所见，ldapuser确实被分配了唯一的角色ldap_user_role。在不修改Clickhouse配置的下，您不能向LDAP用户添加任何其他角色，而只能变更配置中指定角色的权限。配置文件中静态分配的角色在某些场景下够用，但鉴于我们使用的是 LDAP，我们不仅要使用LDAP 管理用户，还应当用它来管理用户的角色。通常LDAP用户属于一个或多个LDAP组，因此根据 LDAP用户所属的LDAP组分配RBAC角色是一个很好的选项。事实上，Clickhouse中的角色映射正是这样做的。</p><p>我们可以在LDAP外部用户目录配置中的&lt;role_mapping>部分启动角色映射。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> clickhouse1 bash -c <span style=color:#f1fa8c>&#39;cat &lt;&lt;HEREDOC &gt; /etc/clickhouse-server/config.d/ldap_external_user_directory.xml
</span><span style=color:#f1fa8c>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
</span><span style=color:#f1fa8c>&lt;yandex&gt;
</span><span style=color:#f1fa8c>    &lt;!--LDAP external user directory da296a1c-7874-11eb-998e-ddba30bbed5d --&gt;
</span><span style=color:#f1fa8c>    &lt;user_directories&gt;
</span><span style=color:#f1fa8c>        &lt;ldap&gt;
</span><span style=color:#f1fa8c>            &lt;server&gt;openldap1&lt;/server&gt;
</span><span style=color:#f1fa8c>            &lt;roles&gt;
</span><span style=color:#f1fa8c>                &lt;ldap_user_role/&gt;
</span><span style=color:#f1fa8c>            &lt;/roles&gt;
</span><span style=color:#f1fa8c>            &lt;role_mapping&gt;
</span><span style=color:#f1fa8c>                &lt;base_dn&gt;ou=groups,dc=example,dc=com&lt;/base_dn&gt;
</span><span style=color:#f1fa8c>                &lt;scope&gt;subtree&lt;/scope&gt;
</span><span style=color:#f1fa8c>                &lt;search_filter&gt;(&amp;amp;(objectClass=groupOfNames)(member={bind_dn}))&lt;/search_filter&gt;
</span><span style=color:#f1fa8c>                &lt;attribute&gt;cn&lt;/attribute&gt;
</span><span style=color:#f1fa8c>                &lt;prefix&gt;clickhouse_&lt;/prefix&gt;
</span><span style=color:#f1fa8c>            &lt;/role_mapping&gt;
</span><span style=color:#f1fa8c>        &lt;/ldap&gt;
</span><span style=color:#f1fa8c>    &lt;/user_directories&gt;
</span><span style=color:#f1fa8c>&lt;/yandex&gt;
</span><span style=color:#f1fa8c>HEREDOC&#39;</span>
</code></pre></div><p>如上所示，&lt;role_mapping>部分定义了根据LDAP专有名称执行LDAP搜索的参数。在上面的配置中，我们要查找具有基本专有名称:ou=groups,dc=example,dc=com的所有对象，搜索范围为subtree，搜索过滤器设置为(&(objectClass=groupOfNames)(member={bind_dn}))，我们将映射到Clickhouse RBAC角色的LDAP节点的属性名称是cn, 属性值必须以clickhouse_开头</p><p>这有点复杂，但本质上通过这个配置，我们将分配给LDAP用户的LDAP组名称映射到以clickhouse_前缀开头的RBAC角色。如果您对这些选项感到困惑，那么最好与您的 LDAP 管理员讨论，他们应该能够为您提供正确的配置。ClickHouse使用上述选项来执行LDAP搜索，正如您所见，它们提供了查找和使用不同对象及其属性以映射到RBAC角色的灵活性</p><p>我们还必须注意，在我们的XML配置中，&符号需要转义。幸运的是，XML只有少数几个字符需要转义，因此很容易搞定。这是完整的列表。</p><pre><code>&quot; —— &amp;quot;
' —— &amp;apos;
&lt; —— &amp;lt;
&gt; —— &amp;gt;
&amp; —— &amp;amp;
</code></pre><p>现在让我们重新启动 ClickHouse 服务器并启用角色映射。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose restart clickhouse1
</code></pre></div><p>我们现在添加一个新的LDAP组, 并将用户ldapuser作为该组成员。然后添加一个对应的Clickhouse RBAC角色作为新LDAP组的映射目标。因此我们创建一个LDAP组clickhouse_role1</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> openldap1 bash -c <span style=color:#f1fa8c>&#39;echo -e &#34;dn: cn=clickhouse_role1,ou=groups,dc=company,dc=com
</span><span style=color:#f1fa8c>objectclass: top
</span><span style=color:#f1fa8c>objectclass: groupOfUniqueNames
</span><span style=color:#f1fa8c>uniquemember: cn=admin,dc=company,dc=com&#34; | ldapadd -x -H ldap://localhost -D &#34;cn=admin,dc=company,dc=com&#34; -w admin&#39;</span>
</code></pre></div><p>LDAP提示创建成功</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>adding new entry <span style=color:#f1fa8c>&#34;cn=clickhouse_role1,ou=groups,dc=company,dc=com&#34;</span>
</code></pre></div><p>现在将ldapuser加入到组clickhouse_role1中</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> openldap1 bash -c <span style=color:#f1fa8c>&#39;echo -e &#34;dn: cn=clickhouse_role1,ou=groups,dc=company,dc=com
</span><span style=color:#f1fa8c>changetype: modify
</span><span style=color:#f1fa8c>add: uniquemember
</span><span style=color:#f1fa8c>uniquemember: cn=ldapuser,ou=users,dc=company,dc=com&#34; | ldapmodify -x -H ldap://localhost -D &#34;cn=admin,dc=company,dc=com&#34; -w admin&#39;</span>
</code></pre></div><p>LDAP提示修改成功</p><pre><code>modifying entry &quot;cn=clickhouse_role1,ou=groups,dc=company,dc=com&quot;
</code></pre><p>使用ldapuser账号登陆Clickhouse并检查它拥有的角色</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> clickhouse1 bash -c <span style=color:#f1fa8c>&#39;clickhouse-client -n --user &#34;ldapuser&#34; --password &#34;ldapuser&#34; -q &#34;SHOW ROLES&#34;&#39;</span>
</code></pre></div><p>内容如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ldap_user_role
</code></pre></div><p>奇怪， 没有任何改变，我们只看到静态分配的角色。哎呀，我们忘记在Clickhouse中添加RBAC角色clickhouse_role1了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> clickhouse1 bash -c <span style=color:#f1fa8c>&#39;clickhouse client -q &#34;CREATE ROLE clickhouse_role1&#34;&#39;</span>
</code></pre></div><p>我们再试一次。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose <span style=color:#8be9fd;font-style:italic>exec</span> clickhouse1 bash -c <span style=color:#f1fa8c>&#39;clickhouse-client -n --user &#34;ldapuser&#34; --password &#34;ldapuser&#34; -q &#34;SHOW ROLES&#34;&#39;</span>
</code></pre></div><p>您应该看到，现在ldapuser有两个角色，静态分配的ldap_user_role和映射的clickhouse_role1。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>clickhouse_role1
ldap_user_role
</code></pre></div><p>以上就是添加LDAP组到RBAC角色映射关系的全部过程。您可以继续添加更多的LDAP组和 RBAC角色并使用它们。</p><h1 id=结论>结论</h1><p>玩转ClickHouse与LDAP集成很有趣。我们看到，一旦我们将LDAP定义添加到ClickHouse配置中，我们就可以验证现有ClickHouse用户或启用LDAP外部用户目录以使用LDAP完全管理 ClickHouse用户认证。我们还研究了如何为LDAP用户分配静态RBAC角色或如何使用角色映射将LDAP组映射到RBAC角色。</p><p>总而言之，我们现在可以不再在XML配置文件中定义密码和用户。在大型组织中，Clickhouse管理员可以将他们的ClickHouse与使用LDAP的其他服务集成。因此，如果您的组织正在使用LDAP，那么请与您的LDAP管理员交谈并开始使用LDAP管理您的所有 ClickHouse用户。您的管理员和安全部门肯定会欣赏这一点。</p><p>如果您对ClickHouse安全有更多疑问，请随时通过Altinity与我们联系。我们的团队喜欢研究安全主题，并很乐意为您提供帮助。</p><blockquote><p><strong>推荐阅读</strong></p></blockquote><ul><li><a href=https://mp.weixin.qq.com/s/pL3JFBnKO1TFrpL0z_hyjg>Clickhouse与LDAP集成(一)</a></li></ul><blockquote><p>更多精彩内容，请扫码关注微信公众号：<strong>后端技术小屋</strong>。如果觉得文章对你有帮助的话，请多多分享、转发、在看。</p></blockquote></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>后端侠</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2021-09-20</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/clickhouse/>Clickhouse</a></div><nav class=post-nav><a class=prev href=/post/%E4%B8%80%E4%B8%AA%E6%80%AA%E5%BC%82%E7%9A%84c++%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89%E6%96%B9%E5%BC%8F/><i class="iconfont icon-left"></i><span class="prev-text nav-default">一个怪异的C++函数定义方式</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/post/c++%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/><span class="next-text nav-default">C++开发环境最佳实践</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><script src=https://utteranc.es/client.js repo=BackendHouse/hugo-comment issue-term=pathname theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=http://github.com/%e5%90%8e%e7%ab%af%e4%be%a0 class="iconfont icon-github" title=github></a><a href=https://backendhouse.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2020 -
2022<span class=heart><i class="iconfont icon-heart"></i></span><span>后端侠</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-SYKLLYTW9K"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-SYKLLYTW9K');</script></body></html>